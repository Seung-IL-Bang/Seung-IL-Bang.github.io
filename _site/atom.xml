<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.10.0">Jekyll</generator><link href="http://localhost:4000/atom.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2025-03-23T12:34:45+09:00</updated><id>http://localhost:4000/atom.xml</id><title type="html">Seung ilâ€™s Blog</title><subtitle>ë°©ìŠ¹ì¼ ê¹ƒí—™ ë¸”ë¡œê·¸</subtitle><author><name>Bang Seung IL</name></author><entry><title type="html">Spring Batch ë°ì´í„° ì§‘ê³„(Aggregation) ìµœì í™”</title><link href="http://localhost:4000/spring%20batch/2025/03/23/Spring-Batch-Optimized-aggregation/" rel="alternate" type="text/html" title="Spring Batch ë°ì´í„° ì§‘ê³„(Aggregation) ìµœì í™”" /><published>2025-03-23T00:00:00+09:00</published><updated>2025-03-23T00:00:00+09:00</updated><id>http://localhost:4000/spring%20batch/2025/03/23/Spring-Batch-Optimized-aggregation</id><content type="html" xml:base="http://localhost:4000/spring%20batch/2025/03/23/Spring-Batch-Optimized-aggregation/"><![CDATA[<blockquote>
  <p>ë°ì´í„° ì§‘ê³„ë¥¼ ìœ„í•œ ë°°ì¹˜ ì²˜ë¦¬ ì‹œ <code class="language-plaintext highlighter-rouge">GROUP BY</code>ì™€ <code class="language-plaintext highlighter-rouge">SUM</code> ëŒ€ì‹  <strong>Redis</strong>ë¥¼ í™œìš©í•˜ì—¬ ì„±ëŠ¥ì„ ëŒ€í­ ê°œì„ í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì— ëŒ€í•´ ì•Œì•„ë´…ì‹œë‹¤!</p>
</blockquote>

<!-- more -->

<h1 id="-ë“¤ì–´ê°€ê¸°">ğŸš€ ë“¤ì–´ê°€ê¸°</h1>

<p>ëŒ€ìš©ëŸ‰ ë°ì´í„°ì˜ ì§‘ê³„ ì²˜ë¦¬ëŠ” ë°°ì¹˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ìì£¼ ë°œìƒí•˜ëŠ” ì‘ì—…ì´ì§€ë§Œ, ì²˜ë¦¬í•´ì•¼ í•  ë°ì´í„° ì–‘ì´ ì¦ê°€í• ìˆ˜ë¡ ì„±ëŠ¥ ì´ìŠˆê°€ ë°œìƒí•©ë‹ˆë‹¤. ë³¸ í¬ìŠ¤íŠ¸ì—ì„œëŠ” ê¸°ì¡´ <code class="language-plaintext highlighter-rouge">GROUP BY</code>, <code class="language-plaintext highlighter-rouge">SUM</code> ë“± SQL ê¸°ë°˜ ì§‘ê³„ ëŒ€ì‹  <strong>Redis</strong>ë¥¼ í™œìš©í•œ ê³ ì„±ëŠ¥ ì§‘ê³„ ë°©ë²•ê³¼ ê·¸ ìµœì í™” ê³¼ì •ì— ëŒ€í•´ ë‹¨ê³„ë³„ë¡œ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.</p>

<h1 id="ê¸°ì¡´-group-by-sum-ì¿¼ë¦¬ì˜-í•œê³„">ê¸°ì¡´ GROUP BY, SUM ì¿¼ë¦¬ì˜ í•œê³„</h1>

<p>í†µê³„ ì²˜ë¦¬ ì‹œ ì¼ë°˜ì ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">GROUP BY</code>, <code class="language-plaintext highlighter-rouge">SUM</code> ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì€ ë°ì´í„°ê°€ ì ì„ ë•ŒëŠ” íš¨ìœ¨ì ì…ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ë°ì´í„°ê°€ ëŒ€ìš©ëŸ‰ìœ¼ë¡œ ì¦ê°€í•˜ê³  ì¿¼ë¦¬ê°€ ë³µì¡í•´ì§ˆìˆ˜ë¡ ì—¬ëŸ¬ ì„±ëŠ¥ ë¬¸ì œê°€ ë°œìƒí•©ë‹ˆë‹¤:</p>

<ul>
  <li>ì—¬ëŸ¬ í…Œì´ë¸”ì„ <code class="language-plaintext highlighter-rouge">JOIN</code>í•˜ê³  <code class="language-plaintext highlighter-rouge">GROUP BY</code>í•˜ëŠ” ë³µì¡í•œ ì¿¼ë¦¬ëŠ” ë°ì´í„°ë² ì´ìŠ¤ ì˜µí‹°ë§ˆì´ì €ê°€ ë¹„íš¨ìœ¨ì ì¸ ì‹¤í–‰ ê³„íšì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ëŒ€ëŸ‰ì˜ ë°ì´í„° ì²˜ë¦¬ ê³¼ì •ì—ì„œ ì„ì‹œ í…Œì´ë¸” ìƒì„±ìœ¼ë¡œ ì¸í•œ ë””ìŠ¤í¬ I/O ë¶€í•˜ê°€ ì¦ê°€í•©ë‹ˆë‹¤.</li>
  <li>ë°ì´í„° ì–‘ì´ ì¦ê°€í• ìˆ˜ë¡ ì¿¼ë¦¬ ì‹¤í–‰ ì‹œê°„ì´ ê¸°í•˜ê¸‰ìˆ˜ì ìœ¼ë¡œ ì¦ê°€í•©ë‹ˆë‹¤.</li>
  <li>ì¿¼ë¦¬ íŠœë‹ì´ ë³µì¡í•´ì§€ê³  ë°ì´í„°ë² ì´ìŠ¤ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ì´ ê¸‰ì¦í•©ë‹ˆë‹¤.</li>
</ul>

<p>ì•„ë˜ ì½”ë“œëŠ” ë°°ì¹˜ ê³¼ì •ì—ì„œ ì •ì‚° ë°ì´í„°ë¥¼ ì§‘ê³„í•˜ê¸° ìœ„í•´ <code class="language-plaintext highlighter-rouge">GROUP BY</code>, <code class="language-plaintext highlighter-rouge">SUM</code>ì„ ì‚¬ìš©í•œ SQLë¬¸ ì…ë‹ˆë‹¤:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"""
            SELECT
                    ds.settlement_id,
                    ds.seller_id,
                    ds.settlement_date,
                    SUM(IF(dsd.settlement_status = 'COMPLETED', 1, 0)) AS total_order_count,
                    SUM(IF(dsd.settlement_status = 'REFUNDED', 1, 0)) AS total_claim_count,
                    SUM(CASE
                            WHEN dsd.settlement_status = 'COMPLETED' THEN dsd.quantity
                            WHEN dsd.settlement_status = 'REFUNDED' THEN -dsd.quantity
                            ELSE 0
                        END) AS total_quantity,
                    SUM(CASE
                            WHEN dsd.settlement_status = 'COMPLETED' THEN dsd.sales_amount
                            WHEN dsd.settlement_status = 'REFUNDED' THEN -dsd.sales_amount
                            ELSE 0
                        END) AS total_sales_amount,
                    SUM(CASE
                            WHEN dsd.settlement_status = 'COMPLETED' THEN dsd.tax_amount
                            WHEN dsd.settlement_status = 'REFUNDED' THEN -dsd.tax_amount
                            ELSE 0
                        END) AS total_tax_amount,
                    SUM(CASE
                            WHEN dsd.settlement_status = 'COMPLETED' THEN dsd.promotion_discount_amount
                            WHEN dsd.settlement_status = 'REFUNDED' THEN -dsd.promotion_discount_amount
                            ELSE 0
                        END) AS total_promotion_discount_amount,
                    SUM(CASE
                            WHEN dsd.settlement_status = 'COMPLETED' THEN dsd.coupon_discount_amount
                            WHEN dsd.settlement_status = 'REFUNDED' THEN -dsd.coupon_discount_amount
                            ELSE 0
                        END) AS total_coupon_discount_amount,
                    SUM(CASE
                            WHEN dsd.settlement_status = 'COMPLETED' THEN dsd.point_used_amount
                            WHEN dsd.settlement_status = 'REFUNDED' THEN -dsd.point_used_amount
                            ELSE 0
                        END) AS total_point_used_amount,
                    SUM(CASE
                            WHEN dsd.settlement_status = 'COMPLETED' THEN dsd.shipping_fee
                            WHEN dsd.settlement_status = 'REFUNDED' THEN -dsd.shipping_fee
                            ELSE 0
                        END) AS total_shipping_fee,
                    SUM(IF(dsd.settlement_status = 'REFUNDED', dsd.claim_shipping_fee, 0)) AS total_claim_shipping_fee,
                    SUM(CASE
                            WHEN dsd.settlement_status = 'COMPLETED' THEN dsd.commission_amount
                            WHEN dsd.settlement_status = 'REFUNDED' THEN -dsd.commission_amount
                            ELSE 0
                        END) AS total_commission_amount,
                    SUM(CASE
                            WHEN dsd.settlement_status = 'COMPLETED' THEN dsd.settlement_amount
                            WHEN dsd.settlement_status = 'REFUNDED' THEN -dsd.settlement_amount
                            ELSE 0
                        END) AS total_settlement_amount
            FROM daily_settlement_detail dsd
            JOIN daily_settlement ds on dsd.daily_settlement_id = ds.settlement_id
            WHERE ds.settlement_date = ?
            GROUP BY ds.settlement_id, ds.seller_id, ds.settlement_date
        """</span><span class="o">;</span>

</code></pre></div></div>

<h1 id="redisë¥¼-í™œìš©í•œ-íš¨ìœ¨ì ì¸-ì§‘ê³„-ì²˜ë¦¬">Redisë¥¼ í™œìš©í•œ íš¨ìœ¨ì ì¸ ì§‘ê³„ ì²˜ë¦¬</h1>

<p>ëŒ€ìš©ëŸ‰ ë°ì´í„° ì§‘ê³„ ì‹œ ë°œìƒí•˜ëŠ” <code class="language-plaintext highlighter-rouge">GROUP BY</code> ì¿¼ë¦¬ì˜ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ì§‘ê³„ ì—°ì‚°ì„ <strong>ë””ìŠ¤í¬ ê¸°ë°˜ RDB ë°ì´í„°ë² ì´ìŠ¤</strong>ê°€ ì•„ë‹Œ <strong>ì¸ë©”ëª¨ë¦¬ ë°ì´í„°ë² ì´ìŠ¤ì¸ Redis</strong>ë¡œ ì´ê´€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p><strong>Redis</strong>ë¥¼ ì§‘ê³„ ì²˜ë¦¬ì— í™œìš©í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ ì¥ì ì´ ìˆìŠµë‹ˆë‹¤:</p>

<ol>
  <li>ì§‘ê³„ì— ìµœì í™”ëœ ì—°ì‚° API ì§€ì› (<code class="language-plaintext highlighter-rouge">hincrby</code>, <code class="language-plaintext highlighter-rouge">hincrbyfloat</code> ë“±)</li>
  <li>ë©”ëª¨ë¦¬ ê¸°ë°˜ ì²˜ë¦¬ë¡œ ë””ìŠ¤í¬ I/O ë³‘ëª© í˜„ìƒ ì œê±°</li>
  <li>ì¸ë©”ëª¨ë¦¬ ë°ì´í„°ë² ì´ìŠ¤ì˜ ì´ˆê³ ì† ì—°ì‚° ì²˜ë¦¬ ëŠ¥ë ¥</li>
</ol>

<p>ğŸš¨ <strong>ì£¼ì˜ì‚¬í•­:</strong></p>

<p><strong>Redis</strong>ë¥¼ ì‚¬ìš©í•˜ë©´ ì§‘ê³„ ì—°ì‚°ì„ ë¹ ë¥´ê²Œ ì²˜ë¦¬í•  ìˆœ ìˆì§€ë§Œ, ë³‘ëª© ì§€ì ì´ ë  ìˆ˜ ìˆëŠ” ì§€ì ì´ ë„¤íŠ¸ì›Œí¬ ë ˆì´í„´ì‹œì…ë‹ˆë‹¤. 1,000ë§Œ ê°œì˜ ë°ì´í„°ë¥¼ í•©ì‚°í•˜ê¸° ìœ„í•´ 1,000ë§Œ ë²ˆì˜ ê°œë³„ ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì´ ë°œìƒí•œë‹¤ë©´, ì´ë¡œ ì¸í•œ ì„±ëŠ¥ ì €í•˜ëŠ” í”¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. â˜ ï¸</p>

<h1 id="redis-pipelineì„-í†µí•œ-ë„¤íŠ¸ì›Œí¬-ë ˆì´í„´ì‹œ-ìµœì†Œí™”">Redis Pipelineì„ í†µí•œ ë„¤íŠ¸ì›Œí¬ ë ˆì´í„´ì‹œ ìµœì†Œí™”</h1>

<p><strong>Redis Pipeline</strong>ì„ í™œìš©í•˜ë©´ ìˆ˜ë§ì€ <strong>Redis ëª…ë ¹ì„ ë¬¶ì–´ì„œ í•œ ë²ˆì˜ ë„¤íŠ¸ì›Œí¬ ì™•ë³µìœ¼ë¡œ ì²˜ë¦¬</strong>í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ <strong>1,000ë§Œ ë²ˆì˜ ê°œë³„ ë„¤íŠ¸ì›Œí¬ ìš”ì²­</strong>ì„ ì²­í¬ ë‹¨ìœ„ë¡œ ë¬¶ì–´ <strong>1ë§Œ ë²ˆ</strong> ì •ë„ë¡œ ì¤„ì´ë©´ ì§‘ê³„ ì²˜ë¦¬ ì‹œê°„ì„ íšê¸°ì ìœ¼ë¡œ ë‹¨ì¶•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<h2 id="ê°œë³„-ìš”ì²­-ë°©ì‹">ê°œë³„ ìš”ì²­ ë°©ì‹</h2>

<figure align="center">
<img src="/post_images/spring-batch-optimization/redis-latency1.png" />
<figcaption></figcaption>
</figure>

<h2 id="pipeline-ë°©ì‹">Pipeline ë°©ì‹</h2>

<figure align="center">
<img src="/post_images/spring-batch-optimization/redis-latency2.png" />
<figcaption></figcaption>
</figure>

<p>ğŸ’¡ <strong>ì¤‘ìš”í•œ êµ¬í˜„ í¬ì¸íŠ¸:</strong></p>

<p><strong>Spring Batch</strong>ì˜ ì²­í¬ í”„ë¡œì„¸ì‹± ì•„í‚¤í…ì²˜ë¥¼ ê³ ë ¤í•  ë•Œ, Redis íŒŒì´í”„ë¼ì¸ì€ ë°˜ë“œì‹œ <code class="language-plaintext highlighter-rouge">ItemWriter</code>ì—ì„œ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤. Spring BatchëŠ” <code class="language-plaintext highlighter-rouge">ItemReader</code> â†’ <code class="language-plaintext highlighter-rouge">ItemProcessor</code> ë‹¨ê³„ì—ì„œëŠ” í•­ëª©ì„ í•˜ë‚˜ì”© ì²˜ë¦¬í•˜ë‹¤ê°€, ì§€ì •ëœ Chunk í¬ê¸°ë§Œí¼ í•­ëª©ì´ ì²˜ë¦¬ë˜ë©´ <code class="language-plaintext highlighter-rouge">ItemWriter</code>ì—ê²Œ ë¬¶ìŒìœ¼ë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.</p>

<p>ë§Œì•½ <code class="language-plaintext highlighter-rouge">ItemProcessor</code>ì—ì„œ Redis Pipelineì„ ìƒì„±í•œë‹¤ë©´, í•­ëª©ë§ˆë‹¤ Redis ì—°ê²°ì„ ë§ºê³  ëŠëŠ” ë¶ˆí•„ìš”í•œ ì˜¤ë²„í—¤ë“œê°€ ë°œìƒí•©ë‹ˆë‹¤. ë”°ë¼ì„œ <code class="language-plaintext highlighter-rouge">ItemWriter</code>ì—ì„œ ì²­í¬ ë‹¨ìœ„ë¡œ íŒŒì´í”„ë¼ì¸ì„ ì²˜ë¦¬í•˜ëŠ” ê²ƒì´ ìµœì ì˜ êµ¬í˜„ ë°©ì‹ì…ë‹ˆë‹¤.</p>

<figure align="center">
<img src="/post_images/spring-batch-optimization/spring-batch-chunk-diagram.svg" />
<figcaption></figcaption>
</figure>

<p>(ì²˜ìŒì— ì²­í¬ í”„ë¡œì„¸ì‹± ì•„í‚¤í…ì²˜ë¥¼ ê³ ë ¤í•˜ì§€ ì•Šê³ , ë‹¨ìˆœíˆ <code class="language-plaintext highlighter-rouge">ItemProcessor</code>ì—ì„œ ì²˜ë¦¬í•˜ëŠ”ê²Œ ìì—°ìŠ¤ëŸ½ë‹¨ ì°©ê° ë•ë¶„ì— ì„±ëŠ¥ì´ ë‚˜ë¹ ì§„ ì œ ê²½í—˜ìœ¼ë¡œë¶€í„° ì•Œë ¤ë“œë¦½ë‹ˆë‹¤. ğŸ˜‚)</p>

<p>ë‹¤ìŒì€ ì •ì‚° ë°ì´í„°(<code class="language-plaintext highlighter-rouge">settlement_detail</code>) ì²­í¬ë¥¼ ì •ì‚° í•­ëª©ë³„ë¡œ <strong>Redis</strong>ì—ì„œ íŒŒì´í”„ë¼ì¸ì„ ì‚¬ìš©í•´ ì§‘ê³„ ì²˜ë¦¬í•˜ëŠ” ì½”ë“œì…ë‹ˆë‹¤:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">ItemWriter</span><span class="o">&lt;</span><span class="nc">SettlementAggregate</span><span class="o">&gt;</span> <span class="nf">optimizedRedisAggregateWriter</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">items</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="c1">// ì²­í¬ì˜</span>
        <span class="c1">// íŒŒì´í”„ë¼ì¸ ì‹œì‘</span>
        <span class="n">redisAsyncCommands</span><span class="o">.</span><span class="na">multi</span><span class="o">();</span>

        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Processing {} items in a single Redis pipeline transaction"</span><span class="o">,</span> <span class="n">items</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>

        <span class="k">for</span> <span class="o">(</span><span class="nc">SettlementAggregate</span> <span class="n">detail</span> <span class="o">:</span> <span class="n">items</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">key</span> <span class="o">=</span> <span class="s">"daily_settlement:"</span> <span class="o">+</span> <span class="n">detail</span><span class="o">.</span><span class="na">getSettlementId</span><span class="o">();</span>

            <span class="c1">// ìƒíƒœë³„ ì²˜ë¦¬</span>
            <span class="k">if</span> <span class="o">(</span><span class="no">COMPLETED</span><span class="o">.</span><span class="na">name</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">detail</span><span class="o">.</span><span class="na">getSettlementStatus</span><span class="o">()))</span> <span class="o">{</span>
                <span class="n">redisAsyncCommands</span><span class="o">.</span><span class="na">hincrby</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="s">"totalOrderCount"</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
                <span class="n">redisAsyncCommands</span><span class="o">.</span><span class="na">hincrby</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="s">"totalQuantity"</span><span class="o">,</span> <span class="n">detail</span><span class="o">.</span><span class="na">getQuantity</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="no">REFUNDED</span><span class="o">.</span><span class="na">name</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">detail</span><span class="o">.</span><span class="na">getSettlementStatus</span><span class="o">()))</span> <span class="o">{</span>
                <span class="n">redisAsyncCommands</span><span class="o">.</span><span class="na">hincrby</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="s">"totalClaimCount"</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
                <span class="n">redisAsyncCommands</span><span class="o">.</span><span class="na">hincrby</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="s">"totalQuantity"</span><span class="o">,</span> <span class="o">-</span><span class="n">detail</span><span class="o">.</span><span class="na">getQuantity</span><span class="o">());</span>
            <span class="o">}</span>

            <span class="c1">// ê¸ˆì•¡ ê´€ë ¨ í•„ë“œ ì²˜ë¦¬</span>
            <span class="nc">String</span> <span class="n">statusMultiplier</span> <span class="o">=</span> <span class="no">REFUNDED</span><span class="o">.</span><span class="na">name</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">detail</span><span class="o">.</span><span class="na">getSettlementStatus</span><span class="o">())</span> <span class="o">?</span> <span class="s">"-"</span> <span class="o">:</span> <span class="s">""</span><span class="o">;</span>

            <span class="n">redisAsyncCommands</span><span class="o">.</span><span class="na">hincrbyfloat</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="s">"totalSalesAmount"</span><span class="o">,</span>
                    <span class="nc">Double</span><span class="o">.</span><span class="na">parseDouble</span><span class="o">(</span><span class="n">statusMultiplier</span> <span class="o">+</span> <span class="n">detail</span><span class="o">.</span><span class="na">getSalesAmount</span><span class="o">().</span><span class="na">toString</span><span class="o">()));</span>
            <span class="n">redisAsyncCommands</span><span class="o">.</span><span class="na">hincrbyfloat</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="s">"totalTaxAmount"</span><span class="o">,</span>
                    <span class="nc">Double</span><span class="o">.</span><span class="na">parseDouble</span><span class="o">(</span><span class="n">statusMultiplier</span> <span class="o">+</span> <span class="n">detail</span><span class="o">.</span><span class="na">getTaxAmount</span><span class="o">().</span><span class="na">toString</span><span class="o">()));</span>
            <span class="n">redisAsyncCommands</span><span class="o">.</span><span class="na">hincrbyfloat</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="s">"totalPromotionDiscountAmount"</span><span class="o">,</span>
                    <span class="nc">Double</span><span class="o">.</span><span class="na">parseDouble</span><span class="o">(</span><span class="n">statusMultiplier</span> <span class="o">+</span> <span class="n">detail</span><span class="o">.</span><span class="na">getPromotionDiscountAmount</span><span class="o">().</span><span class="na">toString</span><span class="o">()));</span>
            <span class="n">redisAsyncCommands</span><span class="o">.</span><span class="na">hincrbyfloat</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="s">"totalCouponDiscountAmount"</span><span class="o">,</span>
                    <span class="nc">Double</span><span class="o">.</span><span class="na">parseDouble</span><span class="o">(</span><span class="n">statusMultiplier</span> <span class="o">+</span> <span class="n">detail</span><span class="o">.</span><span class="na">getCouponDiscountAmount</span><span class="o">().</span><span class="na">toString</span><span class="o">()));</span>
            <span class="n">redisAsyncCommands</span><span class="o">.</span><span class="na">hincrbyfloat</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="s">"totalPointUsedAmount"</span><span class="o">,</span>
                    <span class="nc">Double</span><span class="o">.</span><span class="na">parseDouble</span><span class="o">(</span><span class="n">statusMultiplier</span> <span class="o">+</span> <span class="n">detail</span><span class="o">.</span><span class="na">getPointUsedAmount</span><span class="o">().</span><span class="na">toString</span><span class="o">()));</span>
            <span class="n">redisAsyncCommands</span><span class="o">.</span><span class="na">hincrbyfloat</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="s">"totalShippingFee"</span><span class="o">,</span>
                    <span class="nc">Double</span><span class="o">.</span><span class="na">parseDouble</span><span class="o">(</span><span class="n">statusMultiplier</span> <span class="o">+</span> <span class="n">detail</span><span class="o">.</span><span class="na">getShippingFee</span><span class="o">().</span><span class="na">toString</span><span class="o">()));</span>
            <span class="n">redisAsyncCommands</span><span class="o">.</span><span class="na">hincrbyfloat</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="s">"totalCommissionAmount"</span><span class="o">,</span>
                    <span class="nc">Double</span><span class="o">.</span><span class="na">parseDouble</span><span class="o">(</span><span class="n">statusMultiplier</span> <span class="o">+</span> <span class="n">detail</span><span class="o">.</span><span class="na">getCommissionAmount</span><span class="o">().</span><span class="na">toString</span><span class="o">()));</span>
            <span class="n">redisAsyncCommands</span><span class="o">.</span><span class="na">hincrbyfloat</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="s">"totalSettlementAmount"</span><span class="o">,</span>
                    <span class="nc">Double</span><span class="o">.</span><span class="na">parseDouble</span><span class="o">(</span><span class="n">statusMultiplier</span> <span class="o">+</span> <span class="n">detail</span><span class="o">.</span><span class="na">getSettlementAmount</span><span class="o">().</span><span class="na">toString</span><span class="o">()));</span>

            <span class="c1">// REFUNDEDì¸ ê²½ìš° í´ë ˆì„ ë°°ì†¡ë¹„ ì¶”ê°€</span>
            <span class="k">if</span> <span class="o">(</span><span class="no">REFUNDED</span><span class="o">.</span><span class="na">name</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">detail</span><span class="o">.</span><span class="na">getSettlementStatus</span><span class="o">()))</span> <span class="o">{</span>
                <span class="n">redisAsyncCommands</span><span class="o">.</span><span class="na">hincrbyfloat</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="s">"totalClaimShippingFee"</span><span class="o">,</span>
                        <span class="nc">Double</span><span class="o">.</span><span class="na">parseDouble</span><span class="o">(</span><span class="n">detail</span><span class="o">.</span><span class="na">getClaimShippingFee</span><span class="o">().</span><span class="na">toString</span><span class="o">()));</span>
            <span class="o">}</span>

            <span class="c1">// seller_idì™€ settlement_date ì €ì¥ (ë®ì–´ì“°ê¸° - ëª¨ë“  ë ˆì½”ë“œê°€ ë™ì¼í•œ ê°’ì„ ê°€ì§)</span>
            <span class="n">redisAsyncCommands</span><span class="o">.</span><span class="na">hset</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="s">"sellerId"</span><span class="o">,</span> <span class="n">detail</span><span class="o">.</span><span class="na">getSellerId</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>
            <span class="n">redisAsyncCommands</span><span class="o">.</span><span class="na">hset</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="s">"settlementDate"</span><span class="o">,</span> <span class="n">detail</span><span class="o">.</span><span class="na">getSettlementDate</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>

            <span class="c1">// í•´ë‹¹ settlementì— ëŒ€í•œ í‚¤ ëª©ë¡ì— ì¶”ê°€</span>
            <span class="n">redisAsyncCommands</span><span class="o">.</span><span class="na">sadd</span><span class="o">(</span><span class="s">"settlement_keys:"</span> <span class="o">+</span> <span class="n">detail</span><span class="o">.</span><span class="na">getSettlementDate</span><span class="o">().</span><span class="na">toString</span><span class="o">(),</span> <span class="n">key</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// ëª¨ë“  ëª…ë ¹ì„ í•œ ë²ˆì— ì‹¤í–‰</span>
        <span class="n">redisAsyncCommands</span><span class="o">.</span><span class="na">exec</span><span class="o">();</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Successfully processed batch of {} settlement details to Redis"</span><span class="o">,</span> <span class="n">items</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
    <span class="o">};</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ì´ ë°©ì‹ì„ ì ìš©í•œ í›„ì—ë„ <code class="language-plaintext highlighter-rouge">redisAsyncCommands</code> í´ë¼ì´ì–¸íŠ¸ë¥¼ í†µí•´ <strong>ë°˜ë³µë˜ëŠ” ì—°ì‚° ìš”ì²­ì„ ë§¤ë²ˆ íŒŒì´í”„ë¼ì¸ì— ì ì¬</strong>í•´ì•¼ í•˜ë¯€ë¡œ, ê¸°ì¡´ <code class="language-plaintext highlighter-rouge">GROUP BY</code> ëŒ€ë¹„ ì„±ëŠ¥ ê°œì„ ì´ ê¸°ëŒ€ë³´ë‹¤ í¬ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>

<p>ë” ë†’ì€ ì„±ëŠ¥ ê°œì„ ì„ ìœ„í•´ êµ¬ê¸€ë§ê³¼ AIì—ê²Œ ì¡°ì–¸ì„ êµ¬í•˜ì—¬, ì €ìˆ˜ì¤€ API í™œìš© ë°©ë²• ì¤‘ Lua ìŠ¤í¬ë¦½íŠ¸ ì‚¬ìš©ì„ ê³ ë ¤í•´ ë³´ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.</p>

<h1 id="lua-ìŠ¤í¬ë¦½íŠ¸ë¥¼-í™œìš©í•œ-ì§‘ê³„-ì²˜ë¦¬">Lua ìŠ¤í¬ë¦½íŠ¸ë¥¼ í™œìš©í•œ ì§‘ê³„ ì²˜ë¦¬</h1>

<p><strong>íŒŒì´í”„ë¼ì¸ì— ì—°ì‚° ëª…ë ¹ì–´ë¥¼ ì ì¬í•˜ëŠ” ê³¼ì •</strong>ì—ì„œë„ ì—¬ì „íˆ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¸¡ì—ì„œ <strong>ë§ì€ ì—°ì‚°</strong> ë¡œì§ì´ í•„ìš”í•˜ë‹¤ëŠ” ì‚¬ì‹¤ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.</p>

<p>(ğŸ¤” <code class="language-plaintext highlighter-rouge">StepListener</code>ë¥¼ í™œìš©í•˜ì—¬ ëª…ë ¹ì–´ë¥¼ ì ì¬í•˜ëŠ” ê³¼ì •ì´ ì–¼ë§ˆë‚˜ ì‹œê°„ì´ ê±¸ë¦¬ëŠ”ì§€ ì¸¡ì •í–ˆìŠµë‹ˆë‹¤.)</p>

<p>ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ <strong>Lua ìŠ¤í¬ë¦½íŠ¸</strong>ë¥¼ í™œìš©í•˜ì—¬ ë°ì´í„°ë§Œ Redis ì„œë²„ë¡œ ì „ì†¡í•˜ê³ , ëª¨ë“  ì§‘ê³„ ì—°ì‚°ì€ Redis ì„œë²„ì—ì„œ <strong>ì§ì ‘ ìˆ˜í–‰</strong>í•˜ë„ë¡ ê°œì„ í–ˆìŠµë‹ˆë‹¤.</p>

<p>ì´ ì ‘ê·¼ ë°©ì‹ì˜ í•µì‹¬ ì¥ì ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:</p>

<ul>
  <li>ì• í”Œë¦¬ì¼€ì´ì…˜ ì¸¡ì˜ ì—°ì‚° ì˜¤ë²„í—¤ë“œ ì œê±°</li>
  <li>ë°ì´í„° ì „ì†¡ëŸ‰ ìµœì†Œí™”</li>
  <li>Redis ì„œë²„ì—ì„œì˜ ì›ìì  ì‹¤í–‰ ë³´ì¥</li>
  <li>ë³µì¡í•œ ë¡œì§ì„ ë‹¨ì¼ ìŠ¤í¬ë¦½íŠ¸ë¡œ ìº¡ìŠí™”</li>
</ul>

<p>ë‹¤ìŒì€ ì •ì‚° ì§‘ê³„ë¥¼ ìœ„í•œ Lua ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ì§‘ê³„ë¥¼ ìœ„í•œ Lua ìŠ¤í¬ë¦½íŠ¸</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">AGGREGATE_SCRIPT</span> <span class="o">=</span> <span class="s">"""
        local key = KEYS[1]
        local settlement_key = KEYS[2]
        local status = ARGV[1]
        local seller_id = ARGV[2]
        local settlement_date = ARGV[3]
        local quantity = tonumber(ARGV[4])
        local tax_amount = tonumber(ARGV[5])
        local sales_amount = tonumber(ARGV[6])
        local promotion_discount_amount = tonumber(ARGV[7])
        local coupon_discount_amount = tonumber(ARGV[8])
        local point_used_amount = tonumber(ARGV[9])
        local shipping_fee = tonumber(ARGV[10])
        local claim_shipping_fee = tonumber(ARGV[11])
        local commission_amount = tonumber(ARGV[12])
        local settlement_amount = tonumber(ARGV[13])
        
        if status == 'COMPLETED' then
          redis.call('hincrby', key, 'totalOrderCount', 1)
          redis.call('hincrby', key, 'totalQuantity', quantity)
        else
          redis.call('hincrby', key, 'totalClaimCount', 1)
          redis.call('hincrby', key, 'totalQuantity', -quantity)
        end
        
        local multiplier = status == 'REFUNDED' and -1 or 1
        redis.call('hincrbyfloat', key, 'totalSalesAmount', multiplier * sales_amount)
        redis.call('hincrbyfloat', key, 'totalTaxAmount', multiplier * tax_amount)
        redis.call('hincrbyfloat', key, 'totalPromotionDiscountAmount', multiplier * promotion_discount_amount)
        redis.call('hincrbyfloat', key, 'totalCouponDiscountAmount', multiplier * coupon_discount_amount)
        redis.call('hincrbyfloat', key, 'totalPointUsedAmount', multiplier * point_used_amount)
        redis.call('hincrbyfloat', key, 'totalShippingFee', multiplier * shipping_fee)
        redis.call('hincrbyfloat', key, 'totalCommissionAmount', multiplier * commission_amount)
        redis.call('hincrbyfloat', key, 'totalSettlementAmount', multiplier * settlement_amount)
        
        if status == 'REFUNDED' then
          redis.call('hincrbyfloat', key, 'totalClaimShippingFee', claim_shipping_fee)
        end
        
        redis.call('hset', key, 'sellerId', seller_id)
        redis.call('hset', key, 'settlementDate', settlement_date)
        redis.call('sadd', settlement_key, key)
        
        return 1
        """</span><span class="o">;</span>

</code></pre></div></div>

<p>ë‹¤ìŒì€ <strong>Lua ìŠ¤í¬ë¦½íŠ¸</strong>ë¥¼ í™œìš©í•´ <strong>Redis</strong>ì—ì„œ ì§‘ê³„ ì—°ì‚°ì„ ìˆ˜í–‰í•˜ëŠ” <code class="language-plaintext highlighter-rouge">ItemWriter</code> êµ¬í˜„ì…ë‹ˆë‹¤:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">ItemWriter</span><span class="o">&lt;</span><span class="nc">SettlementAggregate</span><span class="o">&gt;</span> <span class="nf">luaScriptDirectWriter</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">items</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Processing {} items with Redis Lua Script direct execution"</span><span class="o">,</span> <span class="n">items</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>

        <span class="c1">// Lua ìŠ¤í¬ë¦½íŠ¸ë¥¼ í™œìš©í•œ ì²˜ë¦¬</span>
        <span class="k">try</span> <span class="o">(</span><span class="nc">StatefulRedisConnection</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">redisClient</span><span class="o">.</span><span class="na">connect</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">RedisAsyncCommands</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">async</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">async</span><span class="o">();</span>
            <span class="n">async</span><span class="o">.</span><span class="na">setAutoFlushCommands</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>

            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">RedisFuture</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">futures</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

            <span class="k">for</span> <span class="o">(</span><span class="nc">SettlementAggregate</span> <span class="n">detail</span> <span class="o">:</span> <span class="n">items</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">String</span> <span class="n">key</span> <span class="o">=</span> <span class="s">"daily_settlement:"</span> <span class="o">+</span> <span class="n">detail</span><span class="o">.</span><span class="na">getSettlementId</span><span class="o">();</span>
                <span class="nc">String</span> <span class="n">settlementKeysKey</span> <span class="o">=</span> <span class="s">"settlement_keys:"</span> <span class="o">+</span> <span class="n">detail</span><span class="o">.</span><span class="na">getSettlementDate</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>

                <span class="c1">// Lua ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ - ëª¨ë“  ì—°ì‚°ì„ ë ˆë””ìŠ¤ ì„œë²„ì—ì„œ ì²˜ë¦¬</span>
                <span class="n">futures</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">async</span><span class="o">.</span><span class="na">eval</span><span class="o">(</span>
                        <span class="no">AGGREGATE_SCRIPT</span><span class="o">,</span>
                        <span class="nc">ScriptOutputType</span><span class="o">.</span><span class="na">INTEGER</span><span class="o">,</span>
                        <span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="n">key</span><span class="o">,</span> <span class="n">settlementKeysKey</span><span class="o">},</span>
                        <span class="n">detail</span><span class="o">.</span><span class="na">getSettlementStatus</span><span class="o">(),</span>
                        <span class="n">detail</span><span class="o">.</span><span class="na">getSellerId</span><span class="o">().</span><span class="na">toString</span><span class="o">(),</span>
                        <span class="n">detail</span><span class="o">.</span><span class="na">getSettlementDate</span><span class="o">().</span><span class="na">toString</span><span class="o">(),</span>
                        <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">detail</span><span class="o">.</span><span class="na">getQuantity</span><span class="o">()),</span>
                        <span class="n">detail</span><span class="o">.</span><span class="na">getTaxAmount</span><span class="o">().</span><span class="na">toString</span><span class="o">(),</span>
                        <span class="n">detail</span><span class="o">.</span><span class="na">getSalesAmount</span><span class="o">().</span><span class="na">toString</span><span class="o">(),</span>
                        <span class="n">detail</span><span class="o">.</span><span class="na">getPromotionDiscountAmount</span><span class="o">().</span><span class="na">toString</span><span class="o">(),</span>
                        <span class="n">detail</span><span class="o">.</span><span class="na">getCouponDiscountAmount</span><span class="o">().</span><span class="na">toString</span><span class="o">(),</span>
                        <span class="n">detail</span><span class="o">.</span><span class="na">getPointUsedAmount</span><span class="o">().</span><span class="na">toString</span><span class="o">(),</span>
                        <span class="n">detail</span><span class="o">.</span><span class="na">getShippingFee</span><span class="o">().</span><span class="na">toString</span><span class="o">(),</span>
                        <span class="n">detail</span><span class="o">.</span><span class="na">getClaimShippingFee</span><span class="o">().</span><span class="na">toString</span><span class="o">(),</span>
                        <span class="n">detail</span><span class="o">.</span><span class="na">getCommissionAmount</span><span class="o">().</span><span class="na">toString</span><span class="o">(),</span>
                        <span class="n">detail</span><span class="o">.</span><span class="na">getSettlementAmount</span><span class="o">().</span><span class="na">toString</span><span class="o">()</span>
                <span class="o">));</span>
            <span class="o">}</span>

            <span class="c1">// ëª¨ë“  ëª…ë ¹ì–´ í•œë²ˆì— ì „ì†¡</span>
            <span class="n">async</span><span class="o">.</span><span class="na">flushCommands</span><span class="o">();</span>

            <span class="c1">// ëª¨ë“  ì‘ì—… ì™„ë£Œ ëŒ€ê¸°</span>
            <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">allOf</span><span class="o">(</span><span class="n">futures</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="nc">CompletableFuture</span><span class="o">[</span><span class="mi">0</span><span class="o">]))</span>
                    <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">30</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Error processing settlements with Lua script: {}"</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"Error executing Redis Lua script"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Successfully processed batch of {} settlement details to Redis using Lua script"</span><span class="o">,</span> <span class="n">items</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
    <span class="o">};</span>
<span class="o">}</span>
</code></pre></div></div>

<h1 id="lua-ìŠ¤í¬ë¦½íŠ¸-ì‚¬ìš©-ì‹œ-ì£¼ì˜ì‚¬í•­ê³¼-íŠ¸ë ˆì´ë“œ-ì˜¤í”„">Lua ìŠ¤í¬ë¦½íŠ¸ ì‚¬ìš© ì‹œ ì£¼ì˜ì‚¬í•­ê³¼ íŠ¸ë ˆì´ë“œ ì˜¤í”„</h1>

<p><strong>Lua ìŠ¤í¬ë¦½íŠ¸</strong>ë¥¼ í†µí•œ ìµœì í™”ëŠ” í° ì„±ëŠ¥ í–¥ìƒì„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆì§€ë§Œ, ëª‡ ê°€ì§€ ì¤‘ìš”í•œ ê³ ë ¤ì‚¬í•­ê³¼ <strong>íŠ¸ë ˆì´ë“œ ì˜¤í”„</strong>ê°€ ì¡´ì¬í•©ë‹ˆë‹¤:</p>

<p>ğŸ“Œ <strong>Redis ì„œë²„ ë¶€í•˜ ì¦ê°€:</strong></p>

<ul>
  <li>ì§‘ê³„ ì—°ì‚°ì˜ ë¶€í•˜ê°€ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ Redis ì„œë²„ë¡œ ì´ë™í•©ë‹ˆë‹¤.</li>
  <li>ë³µì¡í•œ ìŠ¤í¬ë¦½íŠ¸ëŠ” Redisì˜ ì‹±ê¸€ ìŠ¤ë ˆë“œ íŠ¹ì„±ìœ¼ë¡œ ì¸í•´ ë‹¤ë¥¸ ì‘ì—…ì„ ì°¨ë‹¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>íŠ¹íˆ ê³ ë¶€í•˜ ìƒí™©ì—ì„œ Redis ì„œë²„ì˜ CPU ì‚¬ìš©ë¥ ì„ ëª¨ë‹ˆí„°ë§í•´ì•¼ í•©ë‹ˆë‹¤.</li>
</ul>

<p>ğŸ“Œ <strong>ë””ë²„ê¹… ë³µì¡ì„±:</strong></p>

<ul>
  <li>Lua ìŠ¤í¬ë¦½íŠ¸ ë‚´ë¶€ì—ì„œ ë°œìƒí•˜ëŠ” ì˜¤ë¥˜ëŠ” ë””ë²„ê¹…ì´ ì–´ë µìŠµë‹ˆë‹¤.</li>
  <li>ë¡œê·¸ ì¶œë ¥ ë“± ë””ë²„ê¹… ì •ë³´ë¥¼ ì–»ê¸° ì–´ë ¤ìš°ë¯€ë¡œ ì² ì €í•œ í…ŒìŠ¤íŠ¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.</li>
  <li>ìŠ¤í¬ë¦½íŠ¸ ì˜¤ë¥˜ ì‹œ ì „ì²´ íŠ¸ëœì­ì…˜ì´ ì‹¤íŒ¨í•  ìˆ˜ ìˆì–´ ë¡¤ë°± ì „ëµì´ í•„ìš”í•©ë‹ˆë‹¤.</li>
</ul>

<p>ğŸ“Œ <strong>ìœ ì§€ë³´ìˆ˜ ë³µì¡ì„±:</strong></p>

<ul>
  <li>Lua ìŠ¤í¬ë¦½íŠ¸ì— ëŒ€í•œ ë²„ì „ ê´€ë¦¬ì™€ ë°°í¬ ì „ëµì´ í•„ìš”í•©ë‹ˆë‹¤.</li>
</ul>

<p>ğŸ“Œ <strong>Lua ì–¸ì–´ í•™ìŠµ ê³¡ì„ :</strong></p>

<ul>
  <li>ê°œë°œíŒ€ì´ Lua ì–¸ì–´ì— ìµìˆ™í•˜ì§€ ì•Šì„ ê²½ìš° ì¶”ê°€ì ì¸ í•™ìŠµ ë¹„ìš©ì´ ë°œìƒí•©ë‹ˆë‹¤.</li>
</ul>

<p>ğŸ“Œ <strong>ì›ìì„± ì œí•œ:</strong></p>

<ul>
  <li>Lua ìŠ¤í¬ë¦½íŠ¸ëŠ” ë‹¨ì¼ Redis ì¸ìŠ¤í„´ìŠ¤ì—ì„œëŠ” ì›ìì ì´ì§€ë§Œ, í´ëŸ¬ìŠ¤í„° í™˜ê²½ì—ì„œëŠ” ì›ìì„±ì´ ë³´ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
  <li>í´ëŸ¬ìŠ¤í„°ì—ì„œ ì—¬ëŸ¬ í‚¤ì— ê±¸ì¹œ ì‘ì—…ì„ ìˆ˜í–‰í•  ë•ŒëŠ” ëª¨ë“  í‚¤ê°€ ë™ì¼í•œ ìŠ¬ë¡¯ì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤.</li>
</ul>

<p>ğŸ“Œ <strong>ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì¦ê°€:</strong></p>

<ul>
  <li>Lua ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì¤‘ ìƒì„±ë˜ëŠ” ì„ì‹œ ë°ì´í„°ëŠ” Redis ë©”ëª¨ë¦¬ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.</li>
  <li>ëŒ€ê·œëª¨ ë°ì´í„° ì²˜ë¦¬ ì‹œ <code class="language-plaintext highlighter-rouge">maxmemory</code> ì„¤ì •ê³¼ ë©”ëª¨ë¦¬ ëª¨ë‹ˆí„°ë§ì´ ì¤‘ìš”í•©ë‹ˆë‹¤.</li>
</ul>

<p>ì´ëŸ¬í•œ íŠ¸ë ˆì´ë“œ ì˜¤í”„ë¥¼ ê³ ë ¤í•˜ì—¬, ë‹¤ìŒê³¼ ê°™ì€ ìƒí™©ì—ì„œ Lua ìŠ¤í¬ë¦½íŠ¸ ì‚¬ìš©ì„ ê¶Œì¥í•©ë‹ˆë‹¤:</p>

<ul>
  <li>ì§‘ê³„, ì¹´ìš´íŒ… ë“± ë‹¨ìˆœí•˜ê³  ë°˜ë³µì ì¸ ì—°ì‚°ì´ í•„ìš”í•œ ê²½ìš°</li>
  <li>ë„¤íŠ¸ì›Œí¬ ì™•ë³µì„ ìµœì†Œí™”í•´ì•¼ í•˜ëŠ” ì„±ëŠ¥ ë§¤ìš° ì¤‘ìš”í•œ ìƒí™©</li>
  <li>Redis ì„œë²„ì˜ ë¦¬ì†ŒìŠ¤ê°€ ì¶©ë¶„í•œ ê²½ìš°</li>
</ul>

<p>ë°˜ë©´, ë‹¤ìŒê³¼ ê°™ì€ ê²½ìš°ëŠ” íŒŒì´í”„ë¼ì¸ì´ë‚˜ ë‹¤ë¥¸ ë°©ì‹ì„ ê³ ë ¤í•´ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤:</p>

<ul>
  <li>ë¡œì§ì´ ë§¤ìš° ë³µì¡í•˜ê³  ìì£¼ ë³€ê²½ë˜ëŠ” ê²½ìš°</li>
  <li>Redis í´ëŸ¬ìŠ¤í„° í™˜ê²½ì—ì„œ ì—¬ëŸ¬ í‚¤ë¥¼ ì‚¬ìš©í•´ì•¼ í•˜ëŠ” ê²½ìš°</li>
  <li>Redis ì„œë²„ê°€ ì´ë¯¸ ë†’ì€ ë¶€í•˜ë¥¼ ê²ªê³  ìˆëŠ” ê²½ìš°</li>
</ul>

<h1 id="ì„±ëŠ¥-ë¹„êµ-ë°-ê²°ë¡ ">ì„±ëŠ¥ ë¹„êµ ë° ê²°ë¡ </h1>
<p>ì„¸ ê°€ì§€ êµ¬í˜„ ë°©ì‹ì˜ ì„±ëŠ¥ì„ ë¹„êµí•œ ê²°ê³¼ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:</p>

<ol>
  <li><strong>ì²˜ë¦¬ ì†ë„ í–¥ìƒ</strong>: <code class="language-plaintext highlighter-rouge">GROUP BY</code> ì¿¼ë¦¬ ëŒ€ë¹„ ìµœëŒ€ 9ë°° ì„±ëŠ¥ ê°œì„ </li>
  <li><strong>ë°ì´í„°ë² ì´ìŠ¤ ë¶€í•˜ ê°ì†Œ</strong>: ë°ì´í„°ë² ì´ìŠ¤ì˜ ì§‘ê³„ ì—°ì‚° ë¶€ë‹´ ì œê±°</li>
  <li><strong>í™•ì¥ì„± í–¥ìƒ</strong>: ë°ì´í„° ì¦ê°€ì—ë„ ì„ í˜•ì ì¸ ì„±ëŠ¥ ìœ ì§€</li>
  <li><strong>ì‹¤ì‹œê°„ ì§‘ê³„ ê°€ëŠ¥</strong>: ë°°ì¹˜ ì‘ì—…ê³¼ ì‹¤ì‹œê°„ ì§‘ê³„ë¥¼ ë³‘í–‰ ê°€ëŠ¥</li>
</ol>

<h1 id="ê²°ë¡ ">ê²°ë¡ </h1>

<p>ëŒ€ìš©ëŸ‰ ë°ì´í„° ì§‘ê³„ê°€ í•„ìš”í•œ <strong>Spring Batch</strong> ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œëŠ” ë‹¨ìˆœíˆ SQLì˜ <code class="language-plaintext highlighter-rouge">GROUP BY</code>ì— ì˜ì¡´í•˜ê¸°ë³´ë‹¤ <strong>Redis</strong>ì™€ ê°™ì€ ì¸ë©”ëª¨ë¦¬ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ í™œìš©í•˜ê³ , <strong>Lua ìŠ¤í¬ë¦½íŠ¸</strong>ë¥¼ í†µí•œ ì„œë²„ ì‚¬ì´ë“œ ì²˜ë¦¬ë¥¼ êµ¬í˜„í•˜ì—¬ ìµœì ì˜ ì„±ëŠ¥ì„ ì–»ì„ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ë³¸ í¬ìŠ¤íŠ¸ê°€ ë°°ì¹˜ ì²˜ë¦¬ì˜ ì„±ëŠ¥ì„ ë†’ì´ëŠ” ë° ë„ì›€ì´ ë˜ì—ˆìœ¼ë©´ ì¢‹ê² ìŠµë‹ˆë‹¤.</p>

<p>ê°ì‚¬í•©ë‹ˆë‹¤.</p>

<hr />

<h1 id="ì°¸ê³ -ìë£Œ">ì°¸ê³  ìë£Œ</h1>

<ul>
  <li><a href="https://www.youtube.com/watch?v=2IIwQDIi3ys&amp;t=1534s" target="_blank">Batch Performance ê·¹í•œìœ¼ë¡œ ëŒì–´ì˜¬ë¦¬ê¸°: 1ì–µ ê±´ ë°ì´í„° ì²˜ë¦¬ë¥¼ ìœ„í•œ ë…¸ë ¥ / if(kakao)dev2022</a></li>
  <li><a href="https://www.youtube.com/watch?v=VSwWHHkdQI4&amp;t=1369s" target="_blank">Spring Batch ì• í”Œë¦¬ì¼€ì´ì…˜ ì„±ëŠ¥ í–¥ìƒì„ ìœ„í•œ ì£¼ìš” íŒ (kakao tech)</a></li>
  <li><a href="https://redis.io/docs/latest/commands/hincrby/" target="_blank">Redis Commands Docs - hincrby</a></li>
  <li><a href="https://redis.io/docs/latest/commands/hincrbyfloat/" target="_blank">Redis Commands Docs - hincrbyfloat</a></li>
  <li><a href="https://redis.io/docs/latest/develop/interact/programmability/eval-intro/" target="_blank">Redis Docs - Scripting with Lua</a></li>
</ul>

<hr />]]></content><author><name>Bang Seung IL</name></author><category term="Spring Batch" /><category term="Spring Batch" /><category term="Redis" /><category term="Aggregation" /><category term="Performance Optimization" /><summary type="html"><![CDATA[ë°ì´í„° ì§‘ê³„ë¥¼ ìœ„í•œ ë°°ì¹˜ ì²˜ë¦¬ ì‹œ GROUP BYì™€ SUM ëŒ€ì‹  Redisë¥¼ í™œìš©í•˜ì—¬ ì„±ëŠ¥ì„ ëŒ€í­ ê°œì„ í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì— ëŒ€í•´ ì•Œì•„ë´…ì‹œë‹¤!]]></summary></entry><entry><title type="html">Spring Batch íš¨ê³¼ì ì¸ ëŒ€ëŸ‰ ë°ì´í„° ë¦¬ë“œ(Read) ì „ëµ</title><link href="http://localhost:4000/spring%20batch/2025/03/22/Spring-Batch-Optimized-read-strategy/" rel="alternate" type="text/html" title="Spring Batch íš¨ê³¼ì ì¸ ëŒ€ëŸ‰ ë°ì´í„° ë¦¬ë“œ(Read) ì „ëµ" /><published>2025-03-22T00:00:00+09:00</published><updated>2025-03-22T00:00:00+09:00</updated><id>http://localhost:4000/spring%20batch/2025/03/22/Spring-Batch-Optimized-read-strategy</id><content type="html" xml:base="http://localhost:4000/spring%20batch/2025/03/22/Spring-Batch-Optimized-read-strategy/"><![CDATA[<blockquote>
  <p>ìŠ¤í”„ë§ ë°°ì¹˜ë¥¼ ì´ìš©í•  ë•Œ íš¨ê³¼ì ì¸ ëŒ€ëŸ‰ ë°ì´í„°ë¥¼ ì½ê¸° ìœ„í•œ ì „ëµì— ëŒ€í•´ ì•Œì•„ë´…ì‹œë‹¤!</p>
</blockquote>

<!-- more -->

<h1 id="-ë“¤ì–´ê°€ê¸°">ğŸš€ ë“¤ì–´ê°€ê¸°</h1>

<p>ë³¸ í¬ìŠ¤íŠ¸ì—ì„œëŠ” ìŠ¤í”„ë§ ë°°ì¹˜ì˜ í•µì‹¬ ê°œë…ì¸ ì²­í¬ í”„ë¡œì„¸ì‹±(Chunk Processing)ì— ëŒ€í•´ ì•Œì•„ë³´ê³ , ëŒ€ëŸ‰ì˜ ë°ì´í„°ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ì½ê¸° ìœ„í•´ ì‚¬ì´ë“œ í”„ë¡œì íŠ¸ì—ì„œ ì‹¤ì œ ì ìš©í•œ ì „ëµê³¼ ê·¸ ì„±ëŠ¥ ê°œì„  ê²°ê³¼ë¥¼ ê³µìœ í•˜ê³ ì í•©ë‹ˆë‹¤.</p>

<h1 id="ì²­í¬-í”„ë¡œì„¸ì‹±-ê°œë…ê³¼-ì¤‘ìš”ì„±">ì²­í¬ í”„ë¡œì„¸ì‹± ê°œë…ê³¼ ì¤‘ìš”ì„±</h1>

<p>1,000ë§Œ ê°œì˜ ë°ì´í„°ë¥¼ ë°°ì¹˜ ì²˜ë¦¬í•œë‹¤ê³  ê°€ì •í•´ ë³´ê² ìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ ëŒ€ëŸ‰ì˜ ë°ì´í„°ë¥¼ í•œ ë²ˆì— ë©”ëª¨ë¦¬ì— ë¡œë“œí•˜ëŠ” ê²ƒì€ ë¬¼ë¦¬ì ìœ¼ë¡œ ë¶ˆê°€ëŠ¥í•˜ê±°ë‚˜ ì‹¬ê°í•œ ì„±ëŠ¥ ì €í•˜ë¥¼ ì´ˆë˜í•©ë‹ˆë‹¤. ë”°ë¼ì„œ 1,000ê°œì”© ë‚˜ëˆ„ì–´ ì´ 10,000ë²ˆì— ê±¸ì³ ì²˜ë¦¬í•˜ëŠ” ë°©ì‹ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>

<figure align="center">
<img src="/post_images/spring-batch-optimization/chunk-processing-diagram.svg" />
<figcaption></figcaption>
</figure>

<p>ì´ë ‡ê²Œ ë©”ëª¨ë¦¬ ì œì•½ì„ ê³ ë ¤í•˜ì—¬ ë°ì´í„°ë¥¼ ì¼ì • í¬ê¸°ë¡œ ë‚˜ëˆ„ì–´ ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ëŠ” ë°©ì‹ì„ <strong>ì²­í¬ í”„ë¡œì„¸ì‹±(Chunk Processing)</strong>ì´ë¼ê³  í•©ë‹ˆë‹¤. ìŠ¤í”„ë§ ë°°ì¹˜ëŠ” ì´ëŸ¬í•œ ì²­í¬ ë‹¨ìœ„ ì²˜ë¦¬ë¥¼ ê¸°ë³¸ ì•„í‚¤í…ì²˜ë¡œ ì±„íƒí•˜ê³  ìˆì–´ ëŒ€ìš©ëŸ‰ ë°ì´í„° ì²˜ë¦¬ì— ìµœì í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>

<h1 id="itemreader">ItemReader</h1>

<p>ìŠ¤í”„ë§ ë°°ì¹˜ì—ì„œ ì²­í¬ í”„ë¡œì„¸ì‹±ì„ êµ¬í˜„í•  ë•Œ, ë°ì´í„° ì½ê¸°(Read) ì—­í• ì€ <code class="language-plaintext highlighter-rouge">ItemReader</code> ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•œ êµ¬í˜„ì²´ê°€ ë‹´ë‹¹í•©ë‹ˆë‹¤. ì €ëŠ” ì´ˆê¸°ì— JPAì˜ ê°œë°œ í¸ì˜ì„±ê³¼ í˜ì´ì§• ê¸°ëŠ¥ì„ ë™ì‹œì— í™œìš©í•  ìˆ˜ ìˆëŠ” <code class="language-plaintext highlighter-rouge">JpaPagingItemReader</code>ë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì‹¤ì œ ëŒ€ìš©ëŸ‰ ë°ì´í„° ì²˜ë¦¬ ê³¼ì •ì—ì„œ ë‹¤ìŒê³¼ ê°™ì€ ì‹¬ê°í•œ í•œê³„ì ì„ ê²½í—˜í–ˆìŠµë‹ˆë‹¤.</p>

<p><code class="language-plaintext highlighter-rouge">JpaPagingItemReader</code>ì˜ ì£¼ìš” ë¬¸ì œì :</p>

<ol>
  <li><strong>ë°ì´í„° ì¼ê´€ì„± ë¬¸ì œ</strong>: ì¡°ê±´ì ˆì— ì‚¬ìš©í•˜ëŠ” ì»¬ëŸ¼ì´ ë°°ì¹˜ ì‘ì—… ì¤‘ ì—…ë°ì´íŠ¸ë  ê²½ìš° í˜ì´ì§€ë„¤ì´ì…˜ ë¶ˆì¼ì¹˜ ë°œìƒ</li>
  <li><strong>JPA ì˜¤ë²„í—¤ë“œ</strong>: ë¶ˆí•„ìš”í•œ JPA ê¸°ëŠ¥ìœ¼ë¡œ ì¸í•œ ì„±ëŠ¥ ì˜¤ë²„í—¤ë“œ</li>
  <li><strong>Limit-Offset ë°©ì‹ì˜ êµ¬ì¡°ì  í•œê³„</strong>: ì˜¤í”„ì…‹ì´ ì¦ê°€í• ìˆ˜ë¡ ê¸°í•˜ê¸‰ìˆ˜ì ìœ¼ë¡œ ì„±ëŠ¥ ì €í•˜</li>
</ol>

<h1 id="í˜ì´ì§€ë„¤ì´ì…˜-ì˜¤ë¥˜">í˜ì´ì§€ë„¤ì´ì…˜ ì˜¤ë¥˜</h1>

<p><code class="language-plaintext highlighter-rouge">JpaPagingItemReader</code>ë¥¼ ì‚¬ìš©í•˜ë©´ì„œ ê°€ì¥ ë¨¼ì € ì§ë©´í•œ ë¬¸ì œëŠ” í˜ì´ì§€ë„¤ì´ì…˜ì´ ì •í™•í•˜ê²Œ ë™ì‘í•˜ì§€ ì•ŠëŠ” í˜„ìƒì´ì—ˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ì˜ˆìƒí–ˆë˜ 10ë§Œ ê±´ì˜ ì²˜ë¦¬ ëŒ€ìƒ ë°ì´í„° ì¤‘ ì•½ 2ë§Œ ê±´ë§Œ ì²˜ë¦¬ë˜ê³  ì‘ì—…ì´ ì¢…ë£Œë˜ëŠ” ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>

<p>ì´ ë¬¸ì œì˜ ê·¼ë³¸ ì›ì¸ì€ <code class="language-plaintext highlighter-rouge">JpaPagingItemReader</code>ì˜ ë‚´ë¶€ ë™ì‘ ë°©ì‹ê³¼ <strong>OFFSET ê¸°ë°˜ í˜ì´ì§•</strong>ì˜ í•œê³„ì— ìˆì—ˆìŠµë‹ˆë‹¤. ìŠ¤í”„ë§ ë°°ì¹˜ëŠ” ê° ì²­í¬ ë‹¨ìœ„ë¡œ ì½ê¸°(<code class="language-plaintext highlighter-rouge">ItemReader</code>) â†’ ì²˜ë¦¬(<code class="language-plaintext highlighter-rouge">ItemProcessor</code>) â†’ ì“°ê¸°(<code class="language-plaintext highlighter-rouge">ItemWriter</code>) ì‚¬ì´í´ì„ ë°˜ë³µí•©ë‹ˆë‹¤. <code class="language-plaintext highlighter-rouge">JpaPagingItemReader</code>ê°€ ë™ì‘í•  ë•Œ ë°œìƒí•˜ëŠ” ì£¼ìš” ì´ìŠˆëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">JpaPagingItemReader</code>ëŠ” ìì²´ì ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">EntityManager</code>ë¥¼ ìƒì„±í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤.</li>
  <li>íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ ì²˜ë¦¬ë  ë•Œ, ì½ì–´ì˜¨ ì—”í‹°í‹°ë“¤ì€ ì˜ì† ìƒíƒœë¡œ ìœ ì§€ë©ë‹ˆë‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">Processor</code>ë‚˜ <code class="language-plaintext highlighter-rouge">Writer</code>ì—ì„œ ì—”í‹°í‹°ë¥¼ ì—…ë°ì´íŠ¸í•˜ë©´, ì´ ë³€ê²½ì‚¬í•­ì€ ì—¬ì „íˆ <code class="language-plaintext highlighter-rouge">Reader</code>ì˜ <code class="language-plaintext highlighter-rouge">EntityManager</code>ì— ì˜í•´ ê´€ë¦¬ë©ë‹ˆë‹¤.</li>
  <li>ë‹¤ìŒ ì²­í¬ë¥¼ ì½ê¸° ìœ„í•´ ItemReaderê°€ ì‹¤í–‰ë  ë•Œ, ë³€ê²½ëœ ë‚´ìš©ì´ ë°ì´í„°ë² ì´ìŠ¤ì— ë°˜ì˜ë©ë‹ˆë‹¤.</li>
  <li><strong>LIMIT-OFFSET</strong> ë°©ì‹ì˜ í˜ì´ì§•ì€ ë°ì´í„° ë³€ê²½ í›„ì—ë„ ì›ë˜ ê°œìˆ˜ë§Œí¼ <strong>OFFSET</strong>ì„ ì¦ê°€ì‹œí‚¤ë¯€ë¡œ ë°ì´í„° ëˆ„ë½ì´ ë°œìƒí•©ë‹ˆë‹¤.</li>
</ol>

<p>ì´ˆê¸° ì‘ì„±í–ˆë˜ ë‹¤ìŒ ì½”ë“œëŠ” ì´ëŸ¬í•œ ë¬¸ì œ ìƒí™©ì„ ë³´ì—¬ì¤ë‹ˆë‹¤:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="nd">@NonNull</span>
<span class="kd">public</span> <span class="nc">Query</span> <span class="nf">createQuery</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">getEntityManager</span><span class="o">()</span>
            <span class="o">.</span><span class="na">createQuery</span><span class="o">(</span>
                      <span class="s">"SELECT op "</span> <span class="o">+</span>
                            <span class="s">"FROM OrderProduct op "</span> <span class="o">+</span>
                            <span class="s">"LEFT JOIN Claim cl ON op.orderProductId = cl.orderProductId "</span> <span class="o">+</span>
                            <span class="s">"WHERE op.deliveryCompletedAt BETWEEN :startTime AND :endTime "</span> <span class="o">+</span>
                            <span class="s">"AND op.deliveryStatus = 'DELIVERED' "</span> <span class="o">+</span>
                            <span class="s">"AND op.purchaseConfirmedAt IS NULL "</span> <span class="o">+</span>
                            <span class="s">"AND (cl.claimId IS NULL OR cl.completedAt IS NOT NULL) "</span> <span class="o">+</span>
                            <span class="s">"ORDER BY op.orderProductId ASC"</span><span class="o">,</span> <span class="nc">OrderProduct</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"startTime"</span><span class="o">,</span> <span class="n">startTime</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"endTime"</span><span class="o">,</span> <span class="n">endTime</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ìœ„ ì¿¼ë¦¬ì™€ í•¨ê»˜ ë°œìƒí•˜ëŠ” êµ¬ì²´ì ì¸ ë¬¸ì œ ì‹œë‚˜ë¦¬ì˜¤:</p>

<ol>
  <li>ì¡°ê±´ì ˆì— <code class="language-plaintext highlighter-rouge">purchaseConfirmedAt IS NULL</code> ì¡°ê±´ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ì²­í¬ í¬ê¸°ë¥¼ 1,000ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ì²« ë²ˆì§¸ 1,000ê°œ ë ˆì½”ë“œ(ID 1~1000)ë¥¼ ì½ê³  ì²˜ë¦¬í•©ë‹ˆë‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">ItemWriter</code> ë‹¨ê³„ì—ì„œ ì²˜ë¦¬ëœ ë ˆì½”ë“œì˜ <code class="language-plaintext highlighter-rouge">purchaseConfirmedAt</code> í•„ë“œê°€ í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.</li>
  <li>ë‘ ë²ˆì§¸ ì²­í¬ ì‘ì—… ì‹œ, <code class="language-plaintext highlighter-rouge">JpaPagingItemReader</code>ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë‚´ë¶€ ì¿¼ë¦¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤:</li>
</ol>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">op</span> <span class="k">FROM</span> <span class="n">OrderProduct</span> <span class="n">op</span>
<span class="k">WHERE</span> <span class="n">op</span><span class="p">.</span><span class="n">deliveryCompletedAt</span> <span class="k">BETWEEN</span> <span class="p">:</span><span class="n">startTime</span> <span class="k">AND</span> <span class="p">:</span><span class="n">endTime</span>
<span class="k">AND</span> <span class="n">op</span><span class="p">.</span><span class="n">deliveryStatus</span> <span class="o">=</span> <span class="s1">'DELIVERED'</span>
<span class="k">AND</span> <span class="n">op</span><span class="p">.</span><span class="n">purchaseConfirmedAt</span> <span class="k">IS</span> <span class="k">NULL</span>
<span class="k">AND</span> <span class="p">(</span><span class="n">cl</span><span class="p">.</span><span class="n">claimId</span> <span class="k">IS</span> <span class="k">NULL</span> <span class="k">OR</span> <span class="n">cl</span><span class="p">.</span><span class="n">completedAt</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">)</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">op</span><span class="p">.</span><span class="n">orderProductId</span> <span class="k">ASC</span>
<span class="k">OFFSET</span> <span class="mi">1000</span> <span class="k">LIMIT</span> <span class="mi">1000</span>
</code></pre></div></div>

<ul>
  <li>ê·¸ëŸ¬ë‚˜ ì´ ì‹œì ì—ì„œ ì²˜ìŒ 1,000ê°œ ë ˆì½”ë“œëŠ” ì´ë¯¸ <code class="language-plaintext highlighter-rouge">purchaseConfirmedAt IS NULL</code> ì¡°ê±´ì„ ë” ì´ìƒ ë§Œì¡±í•˜ì§€ ì•Šê²Œ ë©ë‹ˆë‹¤.</li>
  <li>ë”°ë¼ì„œ ì›ë˜ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ 1001~2000 IDë¥¼ ê°€ì§„ ë ˆì½”ë“œë“¤ì´ ì•„ë‹Œ, ìƒˆë¡­ê²Œ ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ì²˜ìŒ 1,000ê°œ ì¤‘ì—ì„œ OFFSET 1000ì„ ì ìš©í•˜ê²Œ ë©ë‹ˆë‹¤.</li>
  <li>ì´ë¡œ ì¸í•´ ì›ë˜ ì²˜ë¦¬ë˜ì–´ì•¼ í•  ë°ì´í„° ì¤‘ ì¼ë¶€(OFFSETìœ¼ë¡œ ì¸í•´ ê±´ë„ˆë›°ëŠ” ë°ì´í„°)ê°€ ëˆ„ë½ë˜ëŠ” í˜„ìƒì´ ë°œìƒí•©ë‹ˆë‹¤.</li>
</ul>

<p>ì´ëŸ¬í•œ ë¬¸ì œì˜ ê·¼ë³¸ì ì¸ ì›ì¸ì€ <code class="language-plaintext highlighter-rouge">JpaPagingItemReader</code>ê°€ ë‚´ë¶€ì ìœ¼ë¡œ ì±„íƒí•˜ê³  ìˆëŠ” <strong>LIMIT-OFFSET</strong> ë°©ì‹ì˜ í˜ì´ì§•ê³¼ <code class="language-plaintext highlighter-rouge">EntityManager</code>ì˜ ì˜ì†ì„± ê´€ë¦¬ ë°©ì‹ì´ ì¡°í•©ë˜ì–´ ë°œìƒí•˜ëŠ” êµ¬ì¡°ì  í•œê³„ì— ìˆìŠµë‹ˆë‹¤.</p>

<p>ë”°ë¼ì„œ <code class="language-plaintext highlighter-rouge">JpaPagingItemReader</code>ì€ <strong>ì²˜ë¦¬ ê³¼ì •ì—ì„œ ì¡°ê±´ì ˆì˜ ì»¬ëŸ¼ì´ ë³€ê²½ë  ê²½ìš°, í˜ì´ì§€ë„¤ì´ì…˜ ë¡œì§ì´ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ì§€ ì•Šì•„ ë°ì´í„° ëˆ„ë½ì´ ë°œìƒ</strong>í•©ë‹ˆë‹¤.</p>

<h1 id="limit-offset-ë°©ì‹ì˜-í•œê³„">Limit-Offset ë°©ì‹ì˜ í•œê³„</h1>

<p><code class="language-plaintext highlighter-rouge">JpaPagingItemReader</code>ê°€ ì‚¬ìš©í•˜ëŠ” <code class="language-plaintext highlighter-rouge">Limit-Offset</code> í˜ì´ì§€ë„¤ì´ì…˜ ë°©ì‹ì€ ëŒ€ìš©ëŸ‰ ë°ì´í„° ì²˜ë¦¬ ì‹œ ì¹˜ëª…ì ì¸ ì„±ëŠ¥ ì €í•˜ë¥¼ ì´ˆë˜í•©ë‹ˆë‹¤. ì´ ë°©ì‹ì˜ í•µì‹¬ì ì¸ ë¬¸ì œëŠ” <strong>ì˜¤í”„ì…‹ì´ ì»¤ì§ˆìˆ˜ë¡ ë°ì´í„°ë² ì´ìŠ¤ê°€ ì²˜ë¦¬í•´ì•¼ í•˜ëŠ” ì‘ì—…ëŸ‰ì´ ê¸°í•˜ê¸‰ìˆ˜ì ìœ¼ë¡œ ì¦ê°€</strong>í•œë‹¤ëŠ” ì ì…ë‹ˆë‹¤.</p>

<p>ì˜ˆë¥¼ ë“¤ì–´, <code class="language-plaintext highlighter-rouge">LIMIT 1000 OFFSET 9000</code>ê³¼ ê°™ì€ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•  ê²½ìš°:</p>

<ol>
  <li>ë°ì´í„°ë² ì´ìŠ¤ëŠ” ì²˜ìŒë¶€í„° 9,000ë²ˆì§¸ ë ˆì½”ë“œê¹Œì§€ ëª¨ë‘ ìŠ¤ìº”í•©ë‹ˆë‹¤.</li>
  <li>ê·¸ í›„ 9,001ë²ˆì§¸ë¶€í„° 10,000ë²ˆì§¸ê¹Œì§€ì˜ 1,000ê°œ ë ˆì½”ë“œë§Œ ì‹¤ì œë¡œ ë°˜í™˜í•©ë‹ˆë‹¤.</li>
</ol>

<p>ì¦‰, ì˜¤í”„ì…‹ì´ ì»¤ì§ˆìˆ˜ë¡ ì‹¤ì œë¡œ <strong>í•„ìš”í•œ ë°ì´í„°ëŠ” ì¼ì •í•œë° ë°˜í•´, ìŠ¤ìº”í•´ì•¼ í•˜ëŠ” ë°ì´í„°ëŠ” ê³„ì† ì¦ê°€</strong>í•˜ê²Œ ë©ë‹ˆë‹¤. ìˆ˜ì²œë§Œ ê±´ì˜ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•´ì•¼ í•˜ëŠ” ë°°ì¹˜ ì‘ì—…ì—ì„œ ì´ëŸ¬í•œ ë°©ì‹ì€ ì‹¬ê°í•œ ì„±ëŠ¥ ë³‘ëª©ì„ ì•¼ê¸°í•©ë‹ˆë‹¤.</p>

<h1 id="limit-offset-vs-zero-offset-ë¹„êµ-ë‹¤ì´ì–´ê·¸ë¨">Limit-Offset vs Zero-Offset ë¹„êµ ë‹¤ì´ì–´ê·¸ë¨</h1>

<figure align="center">
<img src="/post_images/spring-batch-optimization/offset-comparison-diagram.svg" />
<figcaption></figcaption>
</figure>

<p>ìœ„ ë‹¤ì´ì–´ê·¸ë¨ì€ ë‘ ë°©ì‹ì˜ ì°¨ì´ì ì„ ëª…í™•í•˜ê²Œ ë³´ì—¬ì£¼ëŠ” ìë£Œì…ë‹ˆë‹¤. Limit-Offsetì˜ êµ¬ì¡°ì  í•œê³„ì  ë•Œë¬¸ì— ì™œ <strong>Zero-Offset</strong> ë°©ì‹ì´ í•„ìš”í•œì§€ë¥¼ ì´í•´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<h1 id="zero-offset-ì•„ì´í…œ-ë¦¬ë”-êµ¬í˜„ê³¼-ì„±ëŠ¥-ê°œì„ ">Zero-Offset ì•„ì´í…œ ë¦¬ë” êµ¬í˜„ê³¼ ì„±ëŠ¥ ê°œì„ </h1>

<p><code class="language-plaintext highlighter-rouge">JpaPagingItemReader</code>ì˜ í•œê³„ë¥¼ ê·¹ë³µí•˜ê¸° ìœ„í•´, ì €ëŠ” <code class="language-plaintext highlighter-rouge">Zero-Offset</code> ë°©ì‹(ë˜ëŠ” <strong>í‚¤ì…‹ í˜ì´ì§•</strong>)ì„ êµ¬í˜„í•œ ì»¤ìŠ¤í…€ ItemReaderë¥¼ ê°œë°œí–ˆìŠµë‹ˆë‹¤.</p>

<p><strong>Zero-Offset</strong> ë°©ì‹ì˜ í•µì‹¬ ì•„ì´ë””ì–´ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:</p>

<ol>
  <li><strong>í•­ìƒ ì˜¤í”„ì…‹ì„ 0ìœ¼ë¡œ ìœ ì§€</strong>: í˜ì´ì§€ ì´ë™ ì‹œì—ë„ í•­ìƒ OFFSET 0ì„ ì‚¬ìš©</li>
  <li><strong>ID ê¸°ë°˜ í•„í„°ë§</strong>: ì´ì „ í˜ì´ì§€ì—ì„œ ì²˜ë¦¬í•œ ë§ˆì§€ë§‰ ë ˆì½”ë“œì˜ IDë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë‹¤ìŒ ë°ì´í„°ë¥¼ ì¡°íšŒ</li>
  <li><strong>PK ì¸ë±ìŠ¤ í™œìš©</strong>: ê¸°ë³¸í‚¤(PK) ì¸ë±ìŠ¤ë¥¼ ìµœëŒ€í•œ í™œìš©í•˜ì—¬ ì¡°íšŒ ì„±ëŠ¥ ìµœì í™”</li>
</ol>

<p>êµ¬í˜„ì„ ìœ„í•œ í•„ìˆ˜ ì¡°ê±´:</p>

<ol>
  <li>PKë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë°ì´í„°ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì •ë ¬ (ì˜ˆ: <code class="language-plaintext highlighter-rouge">ORDER BY id ASC</code>)</li>
  <li>ê° í˜ì´ì§€ ì¡°íšŒ ì‹œ, ì´ì „ í˜ì´ì§€ì˜ ë§ˆì§€ë§‰ ID ê°’ì„ ê¸°ì¤€ìœ¼ë¡œ í•„í„°ë§ ì¡°ê±´ ì¶”ê°€ (ì˜ˆ: <code class="language-plaintext highlighter-rouge">WHERE id &gt; :lastId</code>)</li>
</ol>

<p>ì˜ˆë¥¼ ë“¤ì–´, ì²« ë²ˆì§¸ í˜ì´ì§€ì—ì„œ 1,000ê±´ì„ ì¡°íšŒí•œ í›„ ë§ˆì§€ë§‰ ë ˆì½”ë“œì˜ IDê°€ 1000ì´ë¼ë©´, ë‘ ë²ˆì§¸ í˜ì´ì§€ ì¡°íšŒ ì‹œì—ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ì¿¼ë¦¬ì— <code class="language-plaintext highlighter-rouge">:lastId</code>ì— 1000ì„ ì„¤ì •í•´ì£¼ë©´ ë©ë‹ˆë‹¤.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">order_product</span> 
<span class="k">WHERE</span> <span class="p">...</span> <span class="k">AND</span> <span class="n">order_product_id</span> <span class="o">&gt;</span> <span class="p">:</span><span class="n">lastId</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">order_product_id</span> <span class="k">ASC</span> 
<span class="k">LIMIT</span> <span class="mi">1000</span>
</code></pre></div></div>

<p>ì´ ë°©ì‹ì˜ ì¥ì ì€ í˜ì´ì§€ ë²ˆí˜¸ê°€ ì•„ë¬´ë¦¬ ë’¤ë¡œ ê°€ë”ë¼ë„ í•­ìƒ ì¸ë±ìŠ¤ë¥¼ íƒ€ëŠ” íš¨ìœ¨ì ì¸ ì¿¼ë¦¬ê°€ ì‹¤í–‰ëœë‹¤ëŠ” ì ì…ë‹ˆë‹¤. ê²°ê³¼ì ìœ¼ë¡œ ì¼ê´€ëœ ì„±ëŠ¥ì„ ìœ ì§€í•  ìˆ˜ ìˆìœ¼ë©°, ë°ì´í„° ì¼ê´€ì„± ë¬¸ì œë„ í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<h1 id="ì»¤ì„œ-ê¸°ë°˜-ì•„ì´í…œ-ë¦¬ë”-í™œìš©ê³¼-ì„±ëŠ¥-ê°œì„ ">ì»¤ì„œ ê¸°ë°˜ ì•„ì´í…œ ë¦¬ë” í™œìš©ê³¼ ì„±ëŠ¥ ê°œì„ </h1>

<p><strong>Zero-Offset</strong> ë°©ì‹ ì™¸ì—ë„, <strong>ì»¤ì„œ ê¸°ë°˜(Cursor-based)</strong> ì•„ì´í…œ ë¦¬ë”ë¥¼ í™œìš©í•˜ëŠ” ë°©ë²•ë„ íš¨ê³¼ì ì…ë‹ˆë‹¤. ìŠ¤í”„ë§ ë°°ì¹˜ëŠ” <strong>JdbcCursorItemReader</strong>ì™€ ê°™ì€ ì»¤ì„œ ê¸°ë°˜ êµ¬í˜„ì²´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.</p>

<p>ì»¤ì„œ ê¸°ë°˜ ë°©ì‹ì˜ ì£¼ìš” íŠ¹ì§•:</p>

<ol>
  <li><strong>ìŠ¤íŠ¸ë¦¬ë° ë°©ì‹</strong>: ë°ì´í„°ë² ì´ìŠ¤ ì»¤ì„œë¥¼ í†µí•´ í•„ìš”í•œ ë§Œí¼ë§Œ ë°ì´í„°ë¥¼ ìŠ¤íŠ¸ë¦¬ë° ë°©ì‹ìœ¼ë¡œ ê°€ì ¸ì˜´</li>
  <li><strong>ë©”ëª¨ë¦¬ íš¨ìœ¨ì„±</strong>: ì „ì²´ ê²°ê³¼ì…‹ì„ ë©”ëª¨ë¦¬ì— ë¡œë“œí•˜ì§€ ì•Šê³  í•„ìš”í•œ ë§Œí¼ë§Œ ê°€ì ¸ì˜¤ë¯€ë¡œ ë©”ëª¨ë¦¬ íš¨ìœ¨ì </li>
  <li><strong>ì„±ëŠ¥ ì¼ê´€ì„±</strong>: Limit-Offset ë°©ì‹ì˜ ì„±ëŠ¥ ì €í•˜ ì—†ì´ ëŒ€ëŸ‰ ë°ì´í„° ì²˜ë¦¬ ê°€ëŠ¥</li>
</ol>

<p>ğŸš¨ ë‹¤ë§Œ, ì»¤ì„œ ê¸°ë°˜ ì ‘ê·¼ë²•ì€ ë‹¤ìŒê³¼ ê°™ì€ ê³ ë ¤ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤:</p>

<ol>
  <li><strong>ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ìœ ì§€</strong>: ì²˜ë¦¬ê°€ ì™„ë£Œë  ë•Œê¹Œì§€ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì„ ìœ ì§€í•´ì•¼ í•¨. (ì¶©ë¶„í•œ <code class="language-plaintext highlighter-rouge">Connection-time</code> ì„¤ì • í•„ìš”.)</li>
  <li><strong>íŠ¸ëœì­ì…˜ ë²”ìœ„</strong>: ì¥ì‹œê°„ ì‹¤í–‰ë˜ëŠ” ì‘ì—…ì˜ ê²½ìš° íŠ¸ëœì­ì…˜ ê´€ë¦¬ì— ì£¼ì˜ í•„ìš”.</li>
  <li><strong>ë¦¬ì†ŒìŠ¤ ê´€ë¦¬</strong>: ì»¤ì„œë¥¼ ëª…ì‹œì ìœ¼ë¡œ ë‹«ì•„ì•¼ í•˜ë¯€ë¡œ ë¦¬ì†ŒìŠ¤ ê´€ë¦¬ì— ì‹ ê²½ ì¨ì•¼ í•¨. (<code class="language-plaintext highlighter-rouge">JdbcCursorItemReader</code>ëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ ìë™ìœ¼ë¡œ ì •ë¦¬.)</li>
</ol>

<h1 id="ìµœì¢…-ì„ íƒ-ì»¤ì„œ-ê¸°ë°˜-ì ‘ê·¼ë²•-jdbccursoritemreader">ìµœì¢… ì„ íƒ: ì»¤ì„œ ê¸°ë°˜ ì ‘ê·¼ë²• JdbcCursorItemReader</h1>

<p>ì´ë¡ ì ìœ¼ë¡œëŠ” <strong>Zero-Offset</strong> ë°©ì‹ì´ ë§¤ìš° íš¨ìœ¨ì ì´ì§€ë§Œ, ì‹¤ì œ í”„ë¡œì íŠ¸ì—ì„œëŠ” <strong>ì»¤ì„œ ê¸°ë°˜ ì ‘ê·¼ë²•(Cursor-based approach)</strong>ì„ ìµœì¢…ì ìœ¼ë¡œ ì±„íƒí–ˆìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ ê²°ì •ì„ ë‚´ë¦° ì£¼ìš” ì´ìœ ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:</p>

<ul>
  <li><strong>ê°œë°œ ë¦¬ì†ŒìŠ¤ íš¨ìœ¨ì„±</strong>: Zero-Offset ë°©ì‹ì€ ë§¤ë²ˆ ìƒˆë¡œìš´ Readerë¥¼ êµ¬í˜„í•  ë•Œë§ˆë‹¤ ìƒë‹¹í•œ ê°œë°œ ê³µìˆ˜ê°€ í•„ìš”í•©ë‹ˆë‹¤. ë°˜ë©´ Spring Batchì—ì„œ ê¸°ë³¸ ì œê³µí•˜ëŠ” <code class="language-plaintext highlighter-rouge">JdbcCursorItemReader</code>ë¥¼ ì‚¬ìš©í•˜ë©´ ì¦‰ì‹œ í™œìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
  <li><strong>ìœ ì§€ë³´ìˆ˜ ìš©ì´ì„±</strong>: ì»¤ìŠ¤í…€ êµ¬í˜„ì²´ë³´ë‹¤ Spring Batchì˜ ê³µì‹ ì»´í¬ë„ŒíŠ¸ë¥¼ ì‚¬ìš©í•¨ìœ¼ë¡œì¨ ìœ ì§€ë³´ìˆ˜ê°€ ìš©ì´í•˜ê³  ë²„ì „ ì—…ê·¸ë ˆì´ë“œ ì‹œ í˜¸í™˜ì„± ë¬¸ì œê°€ ì ìŠµë‹ˆë‹¤.</li>
  <li><strong>ì„±ëŠ¥ ëŒ€ë¹„ ë¹„ìš©</strong>: Zero-Offset ë°©ì‹ì´ ì´ë¡ ì ìœ¼ë¡œ ì•½ê°„ ë” ë›°ì–´ë‚œ ì„±ëŠ¥ì„ ë³´ì¼ ìˆ˜ ìˆì§€ë§Œ, ì»¤ì„œ ê¸°ë°˜ ì ‘ê·¼ë²•ë„ ì¶©ë¶„íˆ ìš°ìˆ˜í•œ ì„±ëŠ¥ì„ ì œê³µí•˜ë©´ì„œ ê°œë°œ ë¹„ìš©ì€ í¬ê²Œ ì ˆê°í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.</li>
</ul>

<p>â­ï¸ ë”°ë¼ì„œ, ì„±ëŠ¥ìƒ í¬ê²Œ ì°¨ì´ê°€ ì•ˆ ë‚˜ëŠ” <strong>Zero-Offset</strong> ë°©ì‹ê³¼ <strong>Cursor-Based</strong> ë°©ì‹ ì¤‘ ì‹¤ìš©ì ì¸ ì¸¡ë©´ì„ ìƒê°í•˜ì—¬ Cursor-basedì¸ <code class="language-plaintext highlighter-rouge">JdbcCursorItemReader</code> ë¥¼ í”„ë¡œì íŠ¸ì— ì ìš©í•˜ì˜€ìŠµë‹ˆë‹¤.</p>

<p>ë‹¤ìŒì€ ì‹¤ì œ êµ¬í˜„ì— ì‚¬ìš©í•œ <code class="language-plaintext highlighter-rouge">JdbcCursorItemReader</code> ì„¤ì •ì˜ ì½”ë“œì…ë‹ˆë‹¤:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span>
<span class="nd">@StepScope</span>
<span class="kd">public</span> <span class="nc">JdbcCursorItemReader</span><span class="o">&lt;</span><span class="nc">OrderProduct</span><span class="o">&gt;</span> <span class="nf">deliveryCompletedJdbcItemReader</span><span class="o">(</span>
        <span class="nd">@Value</span><span class="o">(</span><span class="s">"#{jobParameters['settlementDate']}"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">settlementDateStr</span><span class="o">)</span> <span class="o">{</span>

    <span class="nc">LocalDate</span> <span class="n">date</span> <span class="o">=</span> <span class="nc">JobParameterUtils</span><span class="o">.</span><span class="na">parseSettlementDate</span><span class="o">(</span><span class="n">settlementDateStr</span><span class="o">);</span>
    <span class="nc">LocalDateTime</span> <span class="n">startTime</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="na">atStartOfDay</span><span class="o">();</span>
    <span class="nc">LocalDateTime</span> <span class="n">endTime</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="na">plusDays</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="na">atStartOfDay</span><span class="o">();</span>

    <span class="c1">// SQL ì¿¼ë¦¬ ì‘ì„±</span>
    <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"""
        SELECT op.*
        FROM order_product op
        LEFT JOIN claim cl ON op.order_product_id = cl.order_product_id
        WHERE op.delivery_completed_at BETWEEN ? AND ?
        AND op.delivery_status = 'DELIVERED'
        AND op.purchase_confirmed_at IS NULL
        AND (cl.claim_id IS NULL OR cl.completed_at IS NOT NULL)
        ORDER BY op.order_product_id ASC
        """</span><span class="o">;</span>

    <span class="c1">// PreparedStatement íŒŒë¼ë¯¸í„° ì„¤ì •</span>
    <span class="nc">Object</span><span class="o">[]</span> <span class="n">parameters</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[]</span> <span class="o">{</span>
            <span class="n">startTime</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="nc">DateTimeFormatter</span><span class="o">.</span><span class="na">ofPattern</span><span class="o">(</span><span class="s">"yyyy-MM-dd HH:mm:ss"</span><span class="o">)),</span>
            <span class="n">endTime</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="nc">DateTimeFormatter</span><span class="o">.</span><span class="na">ofPattern</span><span class="o">(</span><span class="s">"yyyy-MM-dd HH:mm:ss"</span><span class="o">))</span>
    <span class="o">};</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nc">JdbcCursorItemReaderBuilder</span><span class="o">&lt;</span><span class="nc">OrderProduct</span><span class="o">&gt;()</span>
            <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"deliveryCompletedJdbcItemReader"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">dataSource</span><span class="o">(</span><span class="n">dataSource</span><span class="o">)</span>
            <span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="n">sql</span><span class="o">)</span>
            <span class="o">.</span><span class="na">preparedStatementSetter</span><span class="o">(</span><span class="k">new</span> <span class="nc">ArgumentPreparedStatementSetter</span><span class="o">(</span><span class="n">parameters</span><span class="o">))</span>
            <span class="o">.</span><span class="na">rowMapper</span><span class="o">(</span><span class="k">new</span> <span class="nc">BeanPropertyRowMapper</span><span class="o">&lt;&gt;(</span><span class="nc">OrderProduct</span><span class="o">.</span><span class="na">class</span><span class="o">))</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li><strong>Zero-Offset</strong> ë°©ì‹ì˜ <code class="language-plaintext highlighter-rouge">ItemReader</code>ë¥¼ ì§ì ‘ ê°œë°œí•˜ëŠ” ê²ƒë³´ë‹¤ Spring Batchì—ì„œ ì§€ì›í•´ì£¼ëŠ” <code class="language-plaintext highlighter-rouge">JdbcCursorItemReader</code>ë¥¼ ì‚¬ìš©í•¨ìœ¼ë¡œì¨ ë§¤ë²ˆ <code class="language-plaintext highlighter-rouge">:lastId</code>ë¥¼ ì‹ ê²½ì“°ì§€ ì•Šê³ ë„ í¸ë¦¬í•˜ê²Œ ê°œë°œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h1 id="ì„±ëŠ¥-ë¹„êµ-jpa-paging-vs-cursor-based">ì„±ëŠ¥ ë¹„êµ: JPA Paging vs Cursor-based</h1>

<p>ì‹¤ì œ ë™ì¼í•œ ë°ì´í„°ì…‹(ìµœëŒ€ 100ë§Œ ê±´ì˜ ì£¼ë¬¸ ë°ì´í„°)ì— ëŒ€í•´ ë‘ ê°€ì§€ ë°©ì‹ì„ ì ìš©í•œ ì„±ëŠ¥ ë¹„êµ ê²°ê³¼ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:</p>

<figure align="center">
<img src="/post_images/spring-batch-optimization/realistic-performance-comparison.svg" />
<figcaption></figcaption>
</figure>

<p>ì°¸ê³ ë¡œ, <code class="language-plaintext highlighter-rouge">JpaPagingItemReader</code> ì½ê¸°ê°€ 2ë§Œê±´ ì²˜ë¦¬ì— 6ë¶„ì´ ê±¸ë ¸ê³ , ê·¸ ì´ìƒì˜ ë°ì´í„°ëŠ” í…ŒìŠ¤íŠ¸í•˜ê¸° ì–´ë ¤ì› ë˜ í˜„ì‹¤ì ì¸ ìƒí™©ì„ ë°˜ì˜í•˜ì—¬ ì¶”ì •ì¹˜ë¥¼ í‘œì‹œí–ˆìŠµë‹ˆë‹¤.</p>

<p>ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¶„ì„:</p>

<ul>
  <li><strong>JPA Paging</strong>: ë°ì´í„°ëŸ‰ì´ ì¦ê°€í• ìˆ˜ë¡ ì²˜ë¦¬ ì‹œê°„ì´ <strong>ê¸°í•˜ê¸‰ìˆ˜ì ìœ¼ë¡œ ì¦ê°€</strong>í•¨.</li>
  <li><strong>Cursor-based</strong>: ë¹ ë¥¸ ì²˜ë¦¬ ì†ë„ë¥¼ ë³´ì´ë©°, ë°ì´í„°ëŸ‰ì´ ì¦ê°€í•˜ë”ë¼ë„ ì²˜ë¦¬ ì‹œê°„ì´ <strong>ì„ í˜•ì ìœ¼ë¡œ ì¦ê°€</strong>í•¨.</li>
</ul>

<h1 id="ë³´ì™„í• -ì ">ë³´ì™„í•  ì </h1>

<p>í˜„ì¬ êµ¬í˜„ì—ì„œ ê°€ì¥ í° ê°œì„ ì ì€ íƒ€ì… ì•ˆì „ì„±ì…ë‹ˆë‹¤. ë¬¸ìì—´ ê¸°ë°˜ ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•˜ëŠ” í˜„ì¬ ë°©ì‹ì€ ì˜¤íƒ€ë‚˜ ì»¬ëŸ¼ëª… ë³€ê²½ ì‹œ ì»´íŒŒì¼ íƒ€ì„ì— ì˜¤ë¥˜ë¥¼ ì¡ì•„ë‚´ê¸° ì–´ë µìŠµë‹ˆë‹¤.</p>

<p>í–¥í›„ ê°œì„  ë°©í–¥:</p>

<ul>
  <li><strong>QueryDSL ë„ì…</strong>: Java ì½”ë“œë¡œ íƒ€ì… ì•ˆì „í•œ ì¿¼ë¦¬ë¥¼ ì‘ì„±í•˜ì—¬ ì»´íŒŒì¼ íƒ€ì„ì— ì˜¤ë¥˜ ê°ì§€</li>
  <li><strong>í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ê°•í™”</strong>: ë‹¤ì–‘í•œ ë°ì´í„° íŒ¨í„´ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì¶”ê°€</li>
  <li><strong>ëª¨ë‹ˆí„°ë§ ê¸°ëŠ¥ ê°œì„ </strong>: ë°°ì¹˜ ì‘ì—…ì˜ ì§„í–‰ ìƒí™© ë° ì„±ëŠ¥ ì§€í‘œ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</li>
</ul>

<p>Kotlin ê¸°ë°˜ í”„ë¡œì íŠ¸ì˜ ê²½ìš°, <strong>Exposed ë¼ì´ë¸ŒëŸ¬ë¦¬</strong>ë¥¼ í™œìš©í•˜ë©´ ë”ìš± ê°„ê²°í•˜ê³  íƒ€ì… ì•ˆì „í•œ ë°©ì‹ìœ¼ë¡œ ì¿¼ë¦¬ë¥¼ ì‘ì„±í•˜ì‹¤ ìˆ˜ ìˆìœ¼ë‹ˆ ì°¸ê³ í•˜ì‹œë©´ ì¢‹ì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.</p>

<h1 id="ï¸-ê²°ë¡ ">â­ï¸ ê²°ë¡ </h1>

<p>ëŒ€ìš©ëŸ‰ ë°ì´í„° ì²˜ë¦¬ ì‹œ Spring Batchì˜ <code class="language-plaintext highlighter-rouge">ItemReader</code> ì „ëµì€ ì „ì²´ ë°°ì¹˜ í”„ë¡œì„¸ìŠ¤ì˜ ì„±ëŠ¥ê³¼ ì•ˆì •ì„±ì— ê²°ì •ì ì¸ ì˜í–¥ì„ ë¯¸ì¹©ë‹ˆë‹¤. íŠ¹íˆ <code class="language-plaintext highlighter-rouge">Limit-Offset</code> ë°©ì‹ì˜ í˜ì´ì§• ëŒ€ì‹  <strong>Zero-Offset</strong> ë˜ëŠ” <strong>ì»¤ì„œ ê¸°ë°˜ ì ‘ê·¼ë²•</strong>ì„ í™œìš©í•¨ìœ¼ë¡œì¨ ë‹¤ìŒê³¼ ê°™ì€ ì´ì ì„ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:</p>

<ul>
  <li><strong>ì¼ê´€ëœ ì„±ëŠ¥</strong>: ì²˜ë¦¬ ë°ì´í„°ëŸ‰ì— ê´€ê³„ì—†ì´ ì˜ˆì¸¡ ê°€ëŠ¥í•œ ì„±ëŠ¥ ìœ ì§€</li>
  <li><strong>ë°ì´í„° ì¼ê´€ì„±</strong>: ë°°ì¹˜ ì²˜ë¦¬ ì¤‘ ë°ì´í„° ë³€ê²½ì—ë„ í˜ì´ì§€ë„¤ì´ì…˜ ì •í™•ì„± ë³´ì¥</li>
  <li><strong>ë¦¬ì†ŒìŠ¤ íš¨ìœ¨ì„±</strong>: ë°ì´í„°ë² ì´ìŠ¤ì™€ ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë²„ì˜ ë¦¬ì†ŒìŠ¤ íš¨ìœ¨ì  í™œìš©</li>
</ul>

<p>ëŒ€ê·œëª¨ ë°°ì¹˜ ì‘ì—…ì„ ì„¤ê³„í•  ë•ŒëŠ” ë‹¨ìˆœíˆ <strong>ì½”ë“œ ì‘ì„±ì˜ í¸ì˜ì„±ë³´ë‹¤ ì„±ëŠ¥ê³¼ í™•ì¥ì„±ì„ ìš°ì„ ì ìœ¼ë¡œ ê³ ë ¤í•˜ëŠ” ê²ƒì´ ì¤‘ìš”</strong>í•©ë‹ˆë‹¤. ë³¸ í¬ìŠ¤íŠ¸ì—ì„œ ì†Œê°œí•œ ì „ëµë“¤ì´ íš¨ìœ¨ì ì¸ ë°°ì¹˜ ì‹œìŠ¤í…œ êµ¬ì¶•ì— ë„ì›€ì´ ë˜ê¸¸ ë°”ëë‹ˆë‹¤.</p>

<h1 id="ì°¸ê³ -ìë£Œ">ì°¸ê³  ìë£Œ</h1>

<ul>
  <li><a href="https://www.youtube.com/watch?v=2IIwQDIi3ys&amp;t=1534s" target="_blank">Batch Performance ê·¹í•œìœ¼ë¡œ ëŒì–´ì˜¬ë¦¬ê¸°: 1ì–µ ê±´ ë°ì´í„° ì²˜ë¦¬ë¥¼ ìœ„í•œ ë…¸ë ¥ / if(kakao)dev2022</a></li>
  <li><a href="https://www.youtube.com/watch?v=VSwWHHkdQI4&amp;t=1369s" target="_blank">Spring Batch ì• í”Œë¦¬ì¼€ì´ì…˜ ì„±ëŠ¥ í–¥ìƒì„ ìœ„í•œ ì£¼ìš” íŒ (kakao tech)</a></li>
  <li><a href="https://docs.spring.io/spring-batch/reference/5.2-SNAPSHOT/readers-and-writers/database.html#JdbcCursorItemReader" target="_blank">Spring Batch Documentation: Cursor-based ItemReader Implementations</a></li>
</ul>

<hr />]]></content><author><name>Bang Seung IL</name></author><category term="Spring Batch" /><category term="Spring Batch" /><category term="Zero Offset" /><category term="Limit-Offset" /><category term="Cursor-Based" /><summary type="html"><![CDATA[ìŠ¤í”„ë§ ë°°ì¹˜ë¥¼ ì´ìš©í•  ë•Œ íš¨ê³¼ì ì¸ ëŒ€ëŸ‰ ë°ì´í„°ë¥¼ ì½ê¸° ìœ„í•œ ì „ëµì— ëŒ€í•´ ì•Œì•„ë´…ì‹œë‹¤!]]></summary></entry><entry><title type="html">Spring Batch ëŒ€ìš©ëŸ‰ ì²˜ë¦¬ì˜ ì´í•´</title><link href="http://localhost:4000/spring%20batch/2025/03/22/Spring-Batch-high-volume-processing/" rel="alternate" type="text/html" title="Spring Batch ëŒ€ìš©ëŸ‰ ì²˜ë¦¬ì˜ ì´í•´" /><published>2025-03-22T00:00:00+09:00</published><updated>2025-03-22T00:00:00+09:00</updated><id>http://localhost:4000/spring%20batch/2025/03/22/Spring-Batch-high-volume-processing</id><content type="html" xml:base="http://localhost:4000/spring%20batch/2025/03/22/Spring-Batch-high-volume-processing/"><![CDATA[<blockquote>
  <p>ìŠ¤í”„ë§ ë°°ì¹˜ë¥¼ í†µí•œ ëŒ€ìš©ëŸ‰ ì²˜ë¦¬ì— ëŒ€í•´ ì•Œì•„ë´…ì‹œë‹¤!</p>
</blockquote>

<!-- more -->

<h1 id="-ë“¤ì–´ê°€ê¸°">ğŸš€ ë“¤ì–´ê°€ê¸°</h1>

<p>ë³¸ í¬ìŠ¤íŠ¸ì—ì„œëŠ” ë°°ì¹˜ ì²˜ë¦¬ì˜ ê°œë…ê³¼ ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ, ì¼ê´„ ìƒì„±, ì¼ê´„ ìˆ˜ì •, í†µê³„ ì²˜ë¦¬ì— ëŒ€í•´ ì•Œì•„ë³´ê³  ëŒ€ëŸ‰ ë°ì´í„° ì²˜ë¦¬ ì‹œ ë°œìƒí•˜ëŠ” ì¼ë°˜ì ì¸ ë¬¸ì œì ê¹Œì§€ ì‚´í´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.</p>

<h1 id="ë°°ì¹˜-ì²˜ë¦¬ì˜-ê°œë…ê³¼-ì‚¬ìš©-ì‹œë‚˜ë¦¬ì˜¤">ë°°ì¹˜ ì²˜ë¦¬ì˜ ê°œë…ê³¼ ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤</h1>

<p><strong>ë°°ì¹˜(batch) ì²˜ë¦¬</strong>ëŠ” íŠ¹ì • ì‹œê°„ì— <strong>ë§ì€ ë°ì´í„°ë¥¼ ì¼ê´„ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ëŠ” í”„ë¡œì„¸ìŠ¤</strong>ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, e-ì»¤ë¨¸ìŠ¤ í”Œë«í¼ì—ì„œ ì˜¤í›„ 4ì‹œì— ìƒí’ˆ ë°°ì†¡ ì •ë³´ë¥¼ ê³ ê°ë“¤ì—ê²Œ ë¬¸ìë¡œ ì¼ê´„ ì „ì†¡í•˜ëŠ” ê²½ìš°ê°€ ì´ì— í•´ë‹¹í•©ë‹ˆë‹¤. ì„œë²„ ê°œë°œìë“¤ì€ íŠ¹ì • ì‹œê°„ì— ì¼ê´„ ì²˜ë¦¬í•´ì•¼ í•˜ëŠ” ì‘ì—…ì´ í•„ìš”í•  ë•Œ ì´ë¥¼ ë°°ì¹˜ í”„ë¡œì„¸ìŠ¤ë¡œ êµ¬í˜„í•˜ëŠ” ê²ƒì´ ì¼ë°˜ì ì…ë‹ˆë‹¤.</p>

<h1 id="ì¼ê´„-ìƒì„±-ì¼ê´„-ìˆ˜ì •-í†µê³„-ì²˜ë¦¬-ê°œë…">ì¼ê´„ ìƒì„±, ì¼ê´„ ìˆ˜ì •, í†µê³„ ì²˜ë¦¬ ê°œë…</h1>

<p>ë°°ì¹˜ ì²˜ë¦¬ëŠ” í¬ê²Œ ì„¸ ê°€ì§€ í˜•íƒœë¡œ êµ¬ë¶„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<h2 id="1-ì¼ê´„-ìƒì„±read-create-write">1. ì¼ê´„ ìƒì„±(Read-Create-Write)</h2>

<p>ê¸°ì¡´ ì €ì¥ëœ ì •ë³´ë¥¼ ì¡°í•©í•´ ìƒˆë¡œìš´ ì •ë³´ë¥¼ ë§Œë“­ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ì£¼ë¬¸ ì •ë³´ë¥¼ ì½ì–´ ì‚¬ìš©ì ì •ë³´ì™€ í•©ì¹œ í›„ ë¬¸ì ì •ë³´ë¥¼ ìƒì„±í•˜ëŠ” ê²½ìš°ê°€ ì´ì— í•´ë‹¹í•©ë‹ˆë‹¤.</p>

<h2 id="2-ì¼ê´„-ìˆ˜ì •read-update-write">2. ì¼ê´„ ìˆ˜ì •(Read-Update-Write)</h2>

<p>A ë°ì´í„°ë¥¼ ì½ê³  B ë°ì´í„°ë¥¼ ì°¸ê³ í•˜ì—¬ A ë°ì´í„°ë¥¼ ìˆ˜ì • í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ì£¼ë¬¸ ì •ë³´ë¥¼ ì½ê³  ë°°ì†¡ ì •ë³´ë¥¼ ì°¸ê³ í•´ ì£¼ë¬¸ ì •ë³´ë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤.</p>

<h2 id="3-í†µê³„-ì²˜ë¦¬read-sum-write">3. í†µê³„ ì²˜ë¦¬(Read-Sum-Write)</h2>

<p>ë°ì´í„°ë¥¼ ì§‘ê³„í•˜ì—¬ í†µê³„ í˜•ì‹ì˜ ë°ì´í„°ë¥¼ ë§Œë“­ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ì£¼ë¬¸ ì •ë³´ë¥¼ <code class="language-plaintext highlighter-rouge">GROUP BY</code> í˜•íƒœë¡œ ì§ˆì˜í•´ì˜¨ ë‹¤ìŒ ìƒí’ˆë³„ ì£¼ë¬¸ ê¸ˆì•¡ í•©ì‚° ë°ì´í„°ë¥¼ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<h1 id="ì‚¬ì´ë“œ-í”„ë¡œì íŠ¸-ì†Œê°œ">ì‚¬ì´ë“œ í”„ë¡œì íŠ¸ ì†Œê°œ</h1>

<p>ìŠ¤í”„ë§ ë°°ì¹˜ì˜ ì„±ëŠ¥ì„ ìµœì í™”í•˜ëŠ” <a href="https://github.com/Seung-IL-Bang/spring-batch-optimization-side-project" target="_blank" rel="noopener noreferrer">ì‚¬ì´ë“œ í”„ë¡œì íŠ¸</a>ë¥¼ ì§„í–‰í–ˆìŠµë‹ˆë‹¤. ì´ í”„ë¡œì íŠ¸ì—ì„œëŠ” e-ì»¤ë¨¸ìŠ¤ í”Œë«í¼ì—ì„œ ìƒí’ˆì„ ë“±ë¡í•œ íŒë§¤ìì—ê²Œ ì¼ì¼ ì •ì‚°ì„ ì œê³µí•˜ê¸° ìœ„í•´, í•˜ë£¨ ë™ì•ˆ ë°œìƒí•œ êµ¬ë§¤ í™•ì • ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë§¤ì¼ íŠ¹ì • ì‹œê°ì— íŒë§¤ìë³„ ì¼ì¼ ì •ì‚°ì„ ìˆ˜í–‰í•˜ëŠ” ë°°ì¹˜ í”„ë¡œì„¸ìŠ¤ë¥¼ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.</p>

<p>ë‹¤ìŒ ì´ë¯¸ì§€ëŠ” ì¼ì¼ ì •ì‚° ë°°ì¹˜ë¥¼ ìˆ˜í–‰í•˜ëŠ” ê° ë‹¨ê³„ë³„ ìƒíƒœë¥¼ ë‚˜íƒ€ë‚¸ ë‹¤ì´ì–´ê·¸ë¨ì…ë‹ˆë‹¤.</p>
<figure align="center">
<img src="/post_images/spring-batch-optimization/batch-state-diagram.png" />
<figcaption></figcaption>
</figure>

<ul>
  <li><code class="language-plaintext highlighter-rouge">ì£¼ë¬¸-ìƒí’ˆ êµ¬ë§¤ í™•ì • ì²˜ë¦¬</code>: íŠ¹ì • ì¡°ê±´ì„ ë§Œì¡±ì‹œí‚¤ëŠ” ì£¼ë¬¸-ìƒí’ˆ ê±´ì— ëŒ€í•˜ì—¬ <strong>êµ¬ë§¤ í™•ì •</strong> ìƒíƒœë¡œ ì¼ê´„ ìˆ˜ì • í•©ë‹ˆë‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">í´ë ˆì„ ì²˜ë¦¬ ì™„ë£Œ</code>: í´ë ˆì„(ì·¨ì†Œ/í™˜ë¶ˆ/ë°˜í’ˆ)ì´ ëë‚œ ê±´ì— ëŒ€í•˜ì—¬ <strong>í´ë ˆì„ ì™„ë£Œ ì²˜ë¦¬</strong> ìƒíƒœë¡œ ì¼ê´„ ìˆ˜ì • í•©ë‹ˆë‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">íŒë§¤ìë³„ ì¼ì¼ ì •ì‚° ìƒì„±</code>: ê¸ˆì¼ íŒë§¤ê±´ì´ ì¡´ì¬í•˜ëŠ” íŒë§¤ìì— ëŒ€í•˜ì—¬ ì¼ì¼ ì •ì‚°ì„ ì¼ê´„ ìƒì„± í•©ë‹ˆë‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">ì£¼ë¬¸-ìƒí’ˆ ì •ì‚° Detail ìƒì„±</code>: êµ¬ë§¤ í™•ì • ìƒíƒœì˜ ì£¼ë¬¸-ìƒí’ˆ ê±´ì— ëŒ€í•˜ì—¬ <strong>(+) ì •ì‚° ì²˜ë¦¬</strong>í•œ ë°ì´í„°ë¥¼ ì¼ê´„ ìƒì„±í•©ë‹ˆë‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">í´ë ˆì„-í™˜ë¶ˆ ì •ì‚° Detail ìƒì„±</code>: í´ë ˆì„ ì²˜ë¦¬ ì™„ë£Œ ê±´ ì¤‘ í™˜ë¶ˆê±´ì— ëŒ€í•˜ì—¬ <strong>(-) ì •ì‚° ì²˜ë¦¬</strong>í•œ ë°ì´í„°ë¥¼ ì¼ê´„ ìƒì„±í•©ë‹ˆë‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">íŒë§¤ìë³„ ì •ì‚° Detail ì§‘ê³„</code>: íŒë§¤ìë³„ë¡œ <strong>(+)ì •ì‚°ê³¼ (-)ì •ì‚°ì„ ì§‘ê³„</strong>í•˜ì—¬ í†µê³„ ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">íŒë§¤ìë³„ ì¼ì¼ ì •ì‚° ì—…ë°ì´íŠ¸</code>: ì´ì „ ë‹¨ê³„ì—ì„œ ìƒì„±í•´ë‘ì—ˆë˜ ì¼ì¼ ì •ì‚°ì— ì§‘ê³„ ë°ì´í„°ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.</li>
</ul>

<!--ì¼ì¼ ì •ì‚° ë°°ì¹˜ í”„ë¡œì„¸ìŠ¤ ìƒíƒœ ë‹¤ì´ì–´ê·¸ë¨-->

<h1 id="ëŒ€ëŸ‰-ë°ì´í„°-ì²˜ë¦¬-ì‹œ-ë°œìƒí•˜ëŠ”-ì¼ë°˜ì ì¸-ë¬¸ì œì ">ëŒ€ëŸ‰ ë°ì´í„° ì²˜ë¦¬ ì‹œ ë°œìƒí•˜ëŠ” ì¼ë°˜ì ì¸ ë¬¸ì œì </h1>

<p>ê°œë°œìë“¤ì€ ì¢…ì¢… ë°°ì¹˜ ì„±ëŠ¥ì— ìƒëŒ€ì ìœ¼ë¡œ ë¬´ê´€ì‹¬í•œ ê²½í–¥ì´ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ë°°ì¹˜ ì‘ì—…ì´ ì£¼ë¡œ íŠ¸ë˜í”½ì´ ì ì€ ì‹œê°„ëŒ€ì¸ ìƒˆë²½ì— ìë™ìœ¼ë¡œ ìŠ¤ì¼€ì¤„ë§ë˜ì–´ ì‹¤í–‰ë˜ê¸° ë•Œë¬¸ì—, ë°°ì¹˜ ì²˜ë¦¬ ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦¬ë”ë¼ë„ í° ë¬¸ì œë¡œ ì¸ì‹ë˜ì§€ ì•ŠëŠ” ê²½ìš°ê°€ ë§ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ë˜í•œ ë°°ì¹˜ë¥¼ ê°œë°œí•œ ë’¤ ë°°í¬ í›„ ì´ˆê¸°ì—ë§Œ ë¡œê·¸ë¥¼ ëª¨ë‹ˆí„°ë§í•˜ë‹¤ê°€, ë¬¸ì œê°€ ì—†ë‹¤ê³  í™•ì¸ëœ í›„ì—ëŠ” ì‹¤ì œ ë¬¸ì œê°€ ë°œìƒí•˜ê¸° ì „ê¹Œì§€ ì˜ ì‚´í´ë³´ì§€ ì•ŠëŠ” ê´€ë¦¬ ì†Œí™€ë¡œ ì´ì–´ì§€ê¸°ë„ í•©ë‹ˆë‹¤. íŠ¹íˆ ë°°ì¹˜ ëª¨ë‹ˆí„°ë§ í™˜ê²½ì´ ì œëŒ€ë¡œ êµ¬ì¶•ë˜ì–´ ìˆì§€ ì•Šë‹¤ë©´, ë¬¸ì œë¥¼ íŒŒì•…í•˜ê³  í•´ê²°í•˜ëŠ” ë° ìƒë‹¹í•œ ì‹œê°„ì´ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p>ëŒ€ëŸ‰ ë°ì´í„° ì²˜ë¦¬ ì‹œ í”íˆ ë°œìƒí•˜ëŠ” ë¬¸ì œì ë“¤ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:</p>
<ul>
  <li>ì²˜ë¦¬ ì‹œê°„ì´ ì˜ˆìƒë³´ë‹¤ í¬ê²Œ ê¸¸ì–´ì§€ëŠ” í˜„ìƒ</li>
  <li>ë©”ëª¨ë¦¬ ë¶€ì¡±(OOM, Out Of Memory) ì˜¤ë¥˜ ë°œìƒ</li>
  <li>ë°ì´í„°ë² ì´ìŠ¤ ë¶€í•˜ ì¦ê°€ ë° ì„±ëŠ¥ ì €í•˜</li>
  <li>ë™ì‹œì— ì‹¤í–‰ë˜ëŠ” ë°°ì¹˜ ì‘ì—… ê°„ ìì› ê²½ìŸìœ¼ë¡œ ì¸í•œ ì„±ëŠ¥ ì €í•˜</li>
  <li>ë°°ì¹˜ ì²˜ë¦¬ ì´ë ¥ ê´€ë¦¬ ë° ëª¨ë‹ˆí„°ë§ì˜ ì–´ë ¤ì›€</li>
</ul>

<p>ì‚¬ì´ë“œ í”„ë¡œì íŠ¸ë¥¼ ì§„í–‰í•˜ë©´ì„œ ìœ„ ë¬¸ì œë“¤ì„ ì–´ë–»ê²Œ ê°œì„ í•´ë‚˜ê°”ëŠ”ì§€ ë‹¤ìŒ í¬ìŠ¤íŠ¸ë“¤ì—ì„œ í•˜ë‚˜ì”© ìì„¸íˆ ì‚´í´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.</p>

<h2 id="ê°ì‚¬í•©ë‹ˆë‹¤">ê°ì‚¬í•©ë‹ˆë‹¤.</h2>]]></content><author><name>Bang Seung IL</name></author><category term="Spring Batch" /><category term="Spring Batch" /><summary type="html"><![CDATA[ìŠ¤í”„ë§ ë°°ì¹˜ë¥¼ í†µí•œ ëŒ€ìš©ëŸ‰ ì²˜ë¦¬ì— ëŒ€í•´ ì•Œì•„ë´…ì‹œë‹¤!]]></summary></entry><entry><title type="html">Spring Boot + Prometheus + Grafanaë¡œ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ êµ¬ì¶•</title><link href="http://localhost:4000/msa/monitoring/prometheus/grafana/2025/02/24/Prometheus-Grafana-Monitoring/" rel="alternate" type="text/html" title="Spring Boot + Prometheus + Grafanaë¡œ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ êµ¬ì¶•" /><published>2025-02-24T00:00:00+09:00</published><updated>2025-02-24T00:00:00+09:00</updated><id>http://localhost:4000/msa/monitoring/prometheus/grafana/2025/02/24/Prometheus-Grafana-Monitoring</id><content type="html" xml:base="http://localhost:4000/msa/monitoring/prometheus/grafana/2025/02/24/Prometheus-Grafana-Monitoring/"><![CDATA[<blockquote>
  <p>Prometheusì™€ Grafanaë¥¼ í™œìš©í•˜ì—¬ Spring Boot ê¸°ë°˜ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ë¥¼ ëª¨ë‹ˆí„°ë§ í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ ì•Œì•„ë´…ì‹œë‹¤!</p>
</blockquote>

<!-- more -->

<h1 id="-ë“¤ì–´ê°€ê¸°">ğŸ“Œ ë“¤ì–´ê°€ê¸°</h1>

<p>í˜„ëŒ€ì˜ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ëŠ” ì—¬ëŸ¬ ê°œì˜ ë…ë¦½ì ì¸ ì„œë¹„ìŠ¤ê°€ ìœ ê¸°ì ìœ¼ë¡œ í˜‘ë ¥í•˜ì—¬ í•˜ë‚˜ì˜ í° ì‹œìŠ¤í…œì„ êµ¬ì„±í•©ë‹ˆë‹¤. ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ í™˜ê²½ì—ì„œëŠ” ê° ì„œë¹„ìŠ¤ê°€ ë…ë¦½ì ìœ¼ë¡œ ë°°í¬ë˜ê³  ìš´ì˜ë˜ê¸° ë•Œë¬¸ì—, íŠ¹ì • ì„œë¹„ìŠ¤ì˜ ì¥ì• ë‚˜ ì„±ëŠ¥ ì €í•˜ê°€ ì „ì²´ ì‹œìŠ¤í…œì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë§Œì•½ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œì´ ì—†ë‹¤ë©´ ì„œë¹„ìŠ¤ ì¥ì• ë‚˜ ì„±ëŠ¥ ì €í•˜ ë°œìƒ ì‹œ ì›ì´ íŒŒì•…ì— ì˜¤ëœ ì‹œê°„ì´ ì†Œìš”ë˜ì–´ ë¹„ì¦ˆë‹ˆìŠ¤ì— ì‹¬ê°í•œ ì˜í–¥ì„ ë¯¸ì¹  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŸ° ì„œë¹„ìŠ¤ ì¥ì• ê°€ ì§€ì†ë˜ë©´ ì‚¬ìš©ì ê²½í—˜ì´ ì•…í™”ë˜ê³ , ê²°ê³¼ì ìœ¼ë¡œ ì„œë¹„ìŠ¤ì˜ ì‹ ë¢°ë¥¼ ìƒì–´ë²„ë¦¬ëŠ” ìµœì•…ì˜ ìƒí™©ì´ ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ MSA í™˜ê²½ì—ì„œëŠ” ê° ì„œë¹„ìŠ¤ì˜ ìƒíƒœì™€ ì„±ëŠ¥ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§í•˜ëŠ” ê²ƒì´ í•„ìˆ˜ì ì…ë‹ˆë‹¤.</p>

<p>ë³¸ í¬ìŠ¤íŠ¸ì—ì„œëŠ” <code class="language-plaintext highlighter-rouge">Prometheus</code>ì™€ <code class="language-plaintext highlighter-rouge">Grafana</code>ë¥¼ í™œìš©í•˜ì—¬ Spring Boot ê¸°ë°˜ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ë¥¼ ëª¨ë‹ˆí„°ë§í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ ì•Œì•„ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.</p>

<h1 id="promethus--grafana">Promethus &amp; Grafana</h1>

<p>ìš°ì„  Prometheusì™€ Grafanaê°€ ê°ê° ë¬´ì—‡ì¸ì§€ ì•Œì•„ë´…ì‹œë‹¤.</p>

<h2 id="prometheusë€">Prometheusë€?</h2>

<p><code class="language-plaintext highlighter-rouge">Prometheus</code>ëŠ” ì˜¤í”ˆì†ŒìŠ¤ ëª¨ë‹ˆí„°ë§ ë° ê²½ê³  ë„êµ¬ë¡œ, ì£¼ë¡œ <strong>ì‹œê³„ì—´ ë°ì´í„°</strong>ë¥¼ ìˆ˜ì§‘í•˜ì—¬ ì €ì¥, ì¿¼ë¦¬, ë¶„ì„í•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” ì €ì¥ì†Œì…ë‹ˆë‹¤. íŠ¹íˆ ì‹œê³„ì—´ ë°ì´í„°ì— íŠ¹í™”ëœ ì¿¼ë¦¬ ì–¸ì–´ì¸ <strong>PromQL</strong>ì„ ì œê³µí•˜ì—¬, ìˆ˜ì§‘í•œ ë©”íŠ¸ë¦­ì„ ì¡°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<h2 id="grafanaë€">Grafanaë€?</h2>

<p><code class="language-plaintext highlighter-rouge">Grafana</code>ëŠ” <code class="language-plaintext highlighter-rouge">Prometheus</code>ì—ì„œ ìˆ˜ì§‘í•œ ë°ì´í„°ë¥¼ ì§ê´€ì ì¸ ëŒ€ì‹œë³´ë“œ í˜•íƒœë¡œ ì‹œê°í™”í•˜ëŠ” ì‹œê°í™” ë„êµ¬ì…ë‹ˆë‹¤. Prometheus ë¿ë§Œ ì•„ë‹ˆë¼ ë‹¤ì–‘í•œ ë°ì´í„° ì†ŒìŠ¤ì™€ì˜ ì—°ë™ë„ ì§€ì›í•©ë‹ˆë‹¤. ëŒ€ì‹œë³´ë“œë¥¼ ì»¤ìŠ¤í…€í•  ìˆ˜ ìˆì„ ë¿ë§Œ ì•„ë‹ˆë¼ ê²½ê³  ì‹œìŠ¤í…œë„ êµ¬ì¶• ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>

<h1 id="spring-bootì™€-prometheus-ì—°ë™">Spring Bootì™€ Prometheus ì—°ë™</h1>

<p>Spring BootëŠ” <strong>Actuator</strong> ëª¨ë“ˆì„ í†µí•´ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë‹¤ì–‘í•œ ìƒíƒœ ì •ë³´(<strong>metrics</strong>)ë¥¼ ì‰½ê²Œ ë…¸ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í™œìš©í•˜ì—¬ Prometheusê°€ <strong>Pull ë°©ì‹</strong>ìœ¼ë¡œ ë©”íŠ¸ë¦­ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p>Actuator ëª¨ë“ˆì„ í†µí•´ ìŠ¤í”„ë§ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë©”íŠ¸ë¦­ ì •ë³´ë“¤ì„ Prometheusì—ê²Œ ë…¸ì¶œí•˜ê¸° ìœ„í•´ ë‹¤ìŒ ì˜ì¡´ì„±ì„ ì¶”ê°€í•´ì¤˜ì•¼ í•©ë‹ˆë‹¤.</p>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">implementation</span> <span class="s1">'org.springframework.boot:spring-boot-starter-actuator'</span>
<span class="n">implementation</span> <span class="s1">'io.micrometer:micrometer-registry-prometheus'</span>
</code></pre></div></div>

<p>ê·¸ë¦¬ê³ , Prometheusê°€ Pull ë°©ì‹ìœ¼ë¡œ ë©”íŠ¸ë¦­ì„ ì¡°íšŒí•  Actuator ì—”ë“œí¬ì¸íŠ¸ë¥¼ í™œì„±í™”ì‹œì¼œ ì¤˜ì•¼ í•©ë‹ˆë‹¤.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">management</span><span class="pi">:</span>
  <span class="na">endpoints</span><span class="pi">:</span>
    <span class="na">web</span><span class="pi">:</span>
      <span class="na">exposure</span><span class="pi">:</span>
        <span class="na">include</span><span class="pi">:</span> <span class="s">prometheus</span>
</code></pre></div></div>

<p>ë§ˆì§€ë§‰ìœ¼ë¡œ Promethues.yml ì„¤ì • íŒŒì¼ì„ í†µí•´ Prometheusê°€ Pull í•˜ê³ ì í•˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ìœ„ì¹˜ ì •ë³´ë¥¼ ì„¤ì •í•´ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤.</p>

<p>ì•„ë˜ ì„¤ì •ì€ ë™ì¼í•œ ë„ì»¤ ë„¤íŠ¸ì›Œí¬ ìƒì— ì¡´ì¬í•˜ëŠ” <code class="language-plaintext highlighter-rouge">user service</code>, <code class="language-plaintext highlighter-rouge">product service</code>, <code class="language-plaintext highlighter-rouge">order service</code>ì— ëŒ€í•œ ë©”íŠ¸ë¦­ì„ Pullì„ 5ì´ˆ ê°„ê²©ìœ¼ë¡œ ì§„í–‰í•˜ê² ë‹¨ ì„¤ì •ì…ë‹ˆë‹¤.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">global</span><span class="pi">:</span>
  <span class="na">scrape_interval</span><span class="pi">:</span> <span class="s">15s</span>
  <span class="na">external_labels</span><span class="pi">:</span>
    <span class="na">monitor</span><span class="pi">:</span> <span class="s1">'</span><span class="s">codelab-monitor'</span>
<span class="na">scrape_configs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">job_name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">prometheus'</span>
    <span class="na">scrape_interval</span><span class="pi">:</span> <span class="s">5s</span>
    <span class="na">static_configs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">targets</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">localhost:9090'</span><span class="pi">]</span>
  <span class="pi">-</span> <span class="na">job_name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">user-actuator'</span>
    <span class="na">metrics_path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">/actuator/prometheus'</span>
    <span class="na">scrape_interval</span><span class="pi">:</span> <span class="s">5s</span>
    <span class="na">static_configs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">targets</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">user-service:8080'</span><span class="pi">]</span>
      <span class="pi">-</span> <span class="na">targets</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">product-service:8081'</span><span class="pi">]</span>
      <span class="pi">-</span> <span class="na">targets</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">order-service:8082'</span><span class="pi">]</span>
</code></pre></div></div>

<p>ë§Œì•½ ë¡œì»¬ì— ì„¤ì¹˜ëœ Prometheusê°€ ì•„ë‹Œ ë„ì»¤ë¡œ ì‹¤í–‰ ì‹œ, Prometheusì˜ <code class="language-plaintext highlighter-rouge">/etc/prometheus/prometheus.yml</code> ê²½ë¡œì™€ ì»¤ìŠ¤í…€ ì„¤ì • íŒŒì¼ì„ ë³¼ë¥¨ ë§ˆìš´íŒ… í•´ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3.8'</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="na">prometheus</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">prom/prometheus:latest</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">prometheus</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./prometheus.yml:/etc/prometheus/prometheus.yml</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">9090:9090"</span>
</code></pre></div></div>

<p>ìœ„ ì„¤ì •ì´ ì™„ë£Œë˜ë©´ PrometheusëŠ” <code class="language-plaintext highlighter-rouge">http://&lt;í˜¸ìŠ¤íŠ¸&gt;:&lt;í¬íŠ¸&gt;/actuator/prometheus</code> ì—”ë“œí¬ì¸íŠ¸ë¥¼ í†µí•´ Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ë“¤ì˜ ë©”íŠ¸ë¦­ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<h1 id="prometheus-ë©”íŠ¸ë¦­---grafana-ì‹œê°í™”">Prometheus ë©”íŠ¸ë¦­ -&gt; Grafana ì‹œê°í™”</h1>

<p>ë©”íŠ¸ë¦­ ë°ì´í„°ë“¤ì´ Prometheusì— ì €ì¥ë˜ë©´ ì´ì™€ ì—°ë™í•˜ì—¬ Grafanaë¥¼ í†µí•´ ì‹œê°í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p>Grafana ê´€ë¦¬ í˜ì´ì§€ì—ì„œ ë°ì´í„° ì†ŒìŠ¤ë¡œ Prometheusë¥¼ ì¶”ê°€í•œ ë‹¤ìŒ, URLì— Prometheus ì„œë²„ì˜ ì£¼ì†Œ(<code class="language-plaintext highlighter-rouge">http://&lt;prometheus-host&gt;:9090</code>)ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.</p>

<p>ëŒ€ì‹œë³´ë“œë¥¼ ê°œì¸ì´ ì§ì ‘ ì»¤ìŠ¤í„°ë§ˆì´ì§•í•  ìˆ˜ë„ ìˆì§€ë§Œ, ì´ë¯¸ ì˜ ë§Œë“¤ì–´ì§„ ëŒ€ì‹œë³´ë“œ í…œí”Œë¦¿ì„ ê°€ì ¸ë‹¤ ì‚¬ìš©í•˜ë©´ í¸ë¦¬í•©ë‹ˆë‹¤.</p>

<h1 id="-ê²°ë¡ ">ğŸš€ ê²°ë¡ </h1>

<p><strong>Prometheus</strong>ì™€ <strong>Grafana</strong>ë¥¼ í™œìš©í•œ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œì€ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ í™˜ê²½ì—ì„œ ì„œë¹„ìŠ¤ì˜ ìƒíƒœë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ í™•ì¸í•˜ê³ , ì¥ì•  ë°œìƒ ì‹œ ë¹ ë¥¸ ëŒ€ì‘ì„ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤. ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œì€ í•„ìˆ˜ì ì´ë©°, ì´ë¥¼ ë¶€ì¬í•  ê²½ìš° ì‹¬ê°í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¦¬ìŠ¤í¬ë¥¼ ì´ˆë˜í•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì„ ëª…ì‹¬í•´ì•¼ ë©ë‹ˆë‹¤.</p>

<h1 id="ì¶”ê°€ë¡œ-ê³µë¶€í•˜ë©´-ì¢‹ì„-ë‚´ìš©">ì¶”ê°€ë¡œ ê³µë¶€í•˜ë©´ ì¢‹ì„ ë‚´ìš©</h1>

<ul>
  <li>Grafana Alerting ê¸°ëŠ¥ (íŠ¹ì • ë©”íŠ¸ë¦­ ê°’ì´ ì„ê³„ì¹˜ ì´ˆê³¼ ì‹œ ì•Œë¦¼ ë°œì†¡)</li>
</ul>

<hr />]]></content><author><name>Bang Seung IL</name></author><category term="MSA" /><category term="Monitoring" /><category term="Prometheus" /><category term="Grafana" /><category term="Prometheus" /><category term="Grafana" /><summary type="html"><![CDATA[Prometheusì™€ Grafanaë¥¼ í™œìš©í•˜ì—¬ Spring Boot ê¸°ë°˜ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ë¥¼ ëª¨ë‹ˆí„°ë§ í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ ì•Œì•„ë´…ì‹œë‹¤!]]></summary></entry><entry><title type="html">ELK ìŠ¤íƒì„ í™œìš©í•œ MSA ì¤‘ì•™ ì§‘ì¤‘ì‹ ë¡œê·¸ ëª¨ë‹ˆí„°ë§</title><link href="http://localhost:4000/msa/elk/2025/02/24/ELK-Stack-Log-Analysis/" rel="alternate" type="text/html" title="ELK ìŠ¤íƒì„ í™œìš©í•œ MSA ì¤‘ì•™ ì§‘ì¤‘ì‹ ë¡œê·¸ ëª¨ë‹ˆí„°ë§" /><published>2025-02-24T00:00:00+09:00</published><updated>2025-02-24T00:00:00+09:00</updated><id>http://localhost:4000/msa/elk/2025/02/24/ELK-Stack-Log-Analysis</id><content type="html" xml:base="http://localhost:4000/msa/elk/2025/02/24/ELK-Stack-Log-Analysis/"><![CDATA[<blockquote>
  <p>ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ì—ì„œ ELK(Elasticsearch + Logstash + Kibana) ìŠ¤íƒì„ í™œìš©í•œ ì¤‘ì•™ ì§‘ì¤‘ì‹ ë¡œê·¸ ëª¨ë‹ˆí„°ë§ì— ëŒ€í•´ ì•Œì•„ë´…ì‹œë‹¤!</p>
</blockquote>

<!-- more -->

<h1 id="-ë“¤ì–´ê°€ê¸°">ğŸ“Œ ë“¤ì–´ê°€ê¸°</h1>

<p>ìµœê·¼ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ê°€ ë„ë¦¬ ì‚¬ìš©ë˜ë©´ì„œ, ë‹¤ì–‘í•œ ì„œë¹„ìŠ¤ì—ì„œ ë°œìƒí•˜ëŠ” ë¡œê·¸ë¥¼ íš¨ê³¼ì ìœ¼ë¡œ ìˆ˜ì§‘ ë° ë¶„ì„í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì´ í•„ìš”í•´ì¡ŒìŠµë‹ˆë‹¤. ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ í™˜ê²½ì—ì„œëŠ” ê° ì„œë¹„ìŠ¤ë§ˆë‹¤ ë³„ë„ì˜ ë¡œê·¸ íŒŒì¼ì´ ìƒì„±ë©ë‹ˆë‹¤. ê°œë³„ ì„œë²„ë§ˆë‹¤ ë¶„ì‚°ë˜ì–´ ì €ì¥ëœ ë¡œê·¸ íŒŒì¼ì„ ì¼ì¼ì´ ë¶„ì„í•˜ëŠ” ê²ƒì€ ë§¤ìš° ê³ ëœ ì¼ì´ ë  ê²ƒì…ë‹ˆë‹¤. ê·¸ë¦¬ê³  ë¬¸ì œ ë°œìƒ ì‹œ ì‹ ì†í•˜ê²Œ ë¡œê·¸ë¥¼ ì¶”ì í•˜ì—¬ ì›ì¸ì„ íŒŒì•…í•˜ê³  ëŒ€ì‘í•˜ëŠ” ë°ì— ë§ì€ ì‹œê°„ì´ ì†Œëª¨ë  ê²ƒì…ë‹ˆë‹¤. ì´ì²˜ëŸ¼ MSA í™˜ê²½ì—ì„œ ë¡œê·¸ë¥¼ ì¤‘ì•™ ì§‘ì¤‘ì‹ìœ¼ë¡œ ê´€ë¦¬í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ì—¬ëŸ¬ ê°€ì§€ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ë°–ì— ì—†ìŠµë‹ˆë‹¤.</p>

<p>ì´ì— ë”°ë¼ ELK(Elasticsearch + Logstash + Kibana)ë¥¼ í™œìš©í•œ ì¤‘ì•™ ì§‘ì¤‘ì‹ ë¡œê·¸ ëª¨ë‹ˆí„°ë§ì˜ í•„ìš”ì„±ì´ ë”ìš± ë¶€ê°ë˜ê³  ìˆìŠµë‹ˆë‹¤.</p>

<p>ë³¸ í¬ìŠ¤íŠ¸ì—ì„œëŠ” ELK ìŠ¤íƒ ê¸°ë°˜ì˜ ë¡œê·¸ ëª¨ë‹ˆí„°ë§ êµ¬ì„±ê³¼, Zipkin ë¡œê·¸ íŠ¸ë ˆì´ì‹±ê³¼ì˜ ì—°ê³„ë¥¼ í†µí•œ íš¨ìœ¨ì ì¸ ëª¨ë‹ˆí„°ë§ ë°©ë²•ì— ëŒ€í•´ ì‚´í´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤. <a href="https://seung-il-bang.github.io/spring%20cloud/zipkin/msa/2025/02/23/Zipkin-Distributed-Tracing/#">Zipkin ë¡œê·¸ íŠ¸ë ˆì´ì‹±</a>ê³¼ ê´€ë ¨í•œ í¬ìŠ¤íŠ¸ê°€ ìˆìœ¼ë‹ˆ ì°¸ê³ í•˜ì‹œë©´ ì¢‹ì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.</p>

<h1 id="elk-ë„ì…ì˜-íš¨ê³¼">ELK ë„ì…ì˜ íš¨ê³¼</h1>

<h2 id="logstashë¥¼-í†µí•œ-ë¡œê·¸-ìˆ˜ì§‘-ë°-í•„í„°ë§">Logstashë¥¼ í†µí•œ ë¡œê·¸ ìˆ˜ì§‘ ë° í•„í„°ë§</h2>

<p>LogstashëŠ” ë‹¤ì–‘í•œ ì†ŒìŠ¤ì˜ ë¡œê·¸ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ìˆ˜ì§‘í•˜ê³ , í•„í„°ë§ ë° ê°€ê³µí•˜ì—¬ ì¼ê´€ëœ í¬ë§·ìœ¼ë£Œ ë³€í™˜í•´ì¤ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ìˆ˜ì§‘ëœ ë¡œê·¸ì˜ í’ˆì§ˆì„ ë†’ì´ê³ , ë¶„ì„ì˜ íš¨ìœ¨ì„±ì„ ë†’ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê°œì¸ ì‚¬ì´ë“œ í”„ë¡œì íŠ¸ì—ì„œëŠ” ê° ì„œë¹„ìŠ¤ê°€ ë¡œê·¸ íŒŒì¼ì„ ê° ì„œë²„ê°€ ì €ì¥í•˜ë„ë¡ í–ˆê³ , í•´ë‹¹ ë¡œê·¸ íŒŒì¼ì„ Logstashê°€ ìˆ˜ì§‘í•˜ë„ë¡ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.</p>

<h2 id="elasticsearch-ê¸°ë°˜ì˜-ë¹ ë¥¸-ê²€ìƒ‰">Elasticsearch ê¸°ë°˜ì˜ ë¹ ë¥¸ ê²€ìƒ‰</h2>

<p>ElasticsearchëŠ” ë¶„ì‚°í˜• ê²€ìƒ‰ ì—”ì§„ìœ¼ë¡œ, ëŒ€ìš©ëŸ‰ ë¡œê·¸ ë°ì´í„°ë¥¼ ë¹ ë¥´ê²Œ ì¸ë±ì‹± ë° ê²€ìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë•ë¶„ì— ì„œë¹„ìŠ¤ ì¥ì•  ì‹œ ë¹ ë¥¸ ì†ë„ì˜ ë¡œê·¸ ê²€ìƒ‰ìœ¼ë¡œ ì¸í•˜ì—¬ ë¬¸ì œë¥¼ ì‹ ì†í•˜ê²Œ ëŒ€ì‘í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.</p>

<h2 id="kibana-ëŒ€ì‹œë³´ë“œë¥¼-í†µí•œ-ì‹œê°í™”">Kibana ëŒ€ì‹œë³´ë“œë¥¼ í†µí•œ ì‹œê°í™”</h2>

<p>KibanaëŠ” Elasticsearchì— ì €ì¥ëœ ë¡œê·¸ ë°ì´í„°ë¥¼ ì‹œê°í™”í•˜ì—¬ ëŒ€ì‹œë³´ë“œë¥¼ êµ¬ì„±í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ë¡œê·¸ì˜ íë¦„ê³¼ ì´ìƒ ì§•í›„ë¥¼ í•œëˆˆì— íŒŒì•…í•  ìˆ˜ ìˆìœ¼ë©°, ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ í™˜ê²½ì„ êµ¬ì¶•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<h1 id="logbackê³¼-elk-ì—°ë™-ë°-êµ¬ì„±-ë°©ë²•">Logbackê³¼ ELK ì—°ë™ ë° êµ¬ì„± ë°©ë²•</h1>

<h2 id="logbackì´ë€">Logbackì´ë€?</h2>
<p>ìŠ¤í”„ë§ ë¶€íŠ¸ëŠ” <strong>ë¡œê¹… ì‹œìŠ¤í…œì˜ ê¸°ë³¸ êµ¬í˜„ì²´</strong>ë¡œ <code class="language-plaintext highlighter-rouge">Logback</code>ì„ ì‚¬ìš©í•˜ë„ë¡ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ê¸°ë³¸ì ì¸ ì„±ëŠ¥ê³¼ ê¸°ëŠ¥ì´ ì¢‹ê¸° ë•Œë¬¸ì— ë§ì´ ì‚¬ìš©ë˜ê³  ìˆìŠµë‹ˆë‹¤. ë§Œì•½ ì„¤ì •ì„ ì»¤ìŠ¤í…€í•˜ê³  ì‹¶ë‹¤ë©´ <code class="language-plaintext highlighter-rouge">logback.xml</code> íŒŒì¼ë¡œ ì„¤ì •ì„ ì¡°ì •í•˜ì‹¤ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.</p>

<p>ìŠ¤í”„ë§ ë¶€íŠ¸ í”„ë¡œì íŠ¸ì—ì„œ ê°œë°œ í¸ì˜ì„±ì„ ìœ„í•´ <code class="language-plaintext highlighter-rouge">Lombok</code>ì„ ëŒ€ë¶€ë¶„ ì‚¬ìš©í•˜ì‹¤ ê²ë‹ˆë‹¤. í•´ë‹¹ ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ëŠ” <code class="language-plaintext highlighter-rouge">Slf4j(Simple Logging Facade For Java)</code>ë¼ëŠ” ë¡œê·¸ ì‹œìŠ¤í…œì— ëŒ€í•œ ì¶”ìƒí™” ê³„ì¸µì„ ì œê³µí•˜ëŠ” ì¸í„°í˜ì´ìŠ¤ê°€ ì¡´ì¬í•©ë‹ˆë‹¤. Slf4jì˜ ê¸°ë³¸ êµ¬í˜„ì²´ëŠ” <code class="language-plaintext highlighter-rouge">Logback</code>ìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤. <strong>Slf4j ìì²´ëŠ” ì¸í„°í˜ì´ìŠ¤</strong>ì´ë¯€ë¡œ ë¡œê¹…ì„ ìˆ˜í–‰í•˜ì§€ ì•Šê³ , <strong>ì‹¤ì œ ë¡œê¹…ì„ ìˆ˜í–‰í•˜ëŠ” êµ¬í˜„ì²´(ex: Logback, Log4j ë“±)ì—ê²Œ ìœ„ì„</strong>í•©ë‹ˆë‹¤. ë§Œì•½ ë¡œê¹… êµ¬í˜„ì²´ë¥¼ êµì²´í•˜ê³  ì‹¶ë‹¤ë©´, ì˜ì¡´ì„±ì„ ë³€ê²½í•¨ìœ¼ë¡œì¨ ì‰½ê²Œ êµì²´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<h2 id="logback---logstash-ë¡œê·¸-ì „ì†¡">Logback -&gt; Logstash ë¡œê·¸ ì „ì†¡</h2>

<p>logback ë¡œê¹… ì‹œìŠ¤í…œì„ í†µí•´ Logstashë¡œ ë¡œê·¸ë¥¼ ì „ì†¡í•˜ê¸° ìœ„í•´ì„  ë‹¤ìŒ ì˜ì¡´ì„±ë¶€í„° ì¶”ê°€í•´ì¤˜ì•¼ í•©ë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ <code class="language-plaintext highlighter-rouge">logback.xml</code> ì„¤ì •ì— Logstashë¡œ ë¡œê·¸ë¥¼ ì¶œë ¥í•˜ëŠ” <strong>Appender</strong>ë¥¼ ì¶”ê°€í•´ì£¼ë©´ ë©ë‹ˆë‹¤.</p>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">implementation</span> <span class="s1">'net.logstash.logback:logstash-logback-encoder:8.0'</span>
</code></pre></div></div>

<p>ì•„ë˜ XML ì„¤ì •ì€ ìŠ¤í”„ë§ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì„¤ì •ëœ <code class="language-plaintext highlighter-rouge">logback.xml</code> ì„¤ì •ì…ë‹ˆë‹¤. í•´ë‹¹ ì„¤ì •ì€ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°œìƒë˜ëŠ” <strong>ë¡œê·¸ë¥¼ ì½˜ì†”, íŒŒì¼, Logstashì— ê°ê° ì¶œë ¥</strong>í•˜ëŠ” ì„¤ì •ì…ë‹ˆë‹¤.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;configuration&gt;</span>
    <span class="nt">&lt;springProperty</span> <span class="na">scope=</span><span class="s">"context"</span> <span class="na">name=</span><span class="s">"applicationName"</span> <span class="na">source=</span><span class="s">"spring.application.name"</span> <span class="na">defaultValue=</span><span class="s">"defaultAppName"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;springProperty</span> <span class="na">scope=</span><span class="s">"context"</span> <span class="na">name=</span><span class="s">"logstashDestination"</span> <span class="na">source=</span><span class="s">"logstash.destination"</span> <span class="na">defaultValue=</span><span class="s">"localhost:5044"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"LOG_FILE"</span> <span class="na">value=</span><span class="s">"application.log"</span><span class="nt">/&gt;</span>

    <span class="c">&lt;!-- Logstashë¡œ ì „ì†¡í•  Appender --&gt;</span>
    <span class="nt">&lt;appender</span> <span class="na">name=</span><span class="s">"LOGSTASH"</span> <span class="na">class=</span><span class="s">"net.logstash.logback.appender.LogstashTcpSocketAppender"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;destination&gt;</span>${logstashDestination}<span class="nt">&lt;/destination&gt;</span>
        <span class="nt">&lt;encoder</span> <span class="na">class=</span><span class="s">"net.logstash.logback.encoder.LogstashEncoder"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/appender&gt;</span>

    <span class="c">&lt;!-- ì½˜ì†” ì¶œë ¥ --&gt;</span>
    <span class="nt">&lt;appender</span> <span class="na">name=</span><span class="s">"CONSOLE"</span> <span class="na">class=</span><span class="s">"ch.qos.logback.core.ConsoleAppender"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;encoder&gt;</span>
            <span class="nt">&lt;pattern&gt;</span>%d{yyyy-MM-dd HH:mm:ss} %5p [${applicationName:-},%X{traceId:-},%X{spanId:-}] [%thread] %logger{36} - %msg%n<span class="nt">&lt;/pattern&gt;</span>
        <span class="nt">&lt;/encoder&gt;</span>
    <span class="nt">&lt;/appender&gt;</span>

    <span class="c">&lt;!-- íŒŒì¼ ì¶œë ¥ --&gt;</span>
    <span class="nt">&lt;appender</span> <span class="na">name=</span><span class="s">"FILE"</span> <span class="na">class=</span><span class="s">"ch.qos.logback.core.rolling.RollingFileAppender"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;file&gt;</span>${LOG_FILE}<span class="nt">&lt;/file&gt;</span>
        <span class="nt">&lt;rollingPolicy</span> <span class="na">class=</span><span class="s">"ch.qos.logback.core.rolling.TimeBasedRollingPolicy"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;fileNamePattern&gt;</span>application.%d{yyyy-MM-dd_HH-mm}.log.gz<span class="nt">&lt;/fileNamePattern&gt;</span>
            <span class="nt">&lt;maxHistory&gt;</span>2<span class="nt">&lt;/maxHistory&gt;</span>
        <span class="nt">&lt;/rollingPolicy&gt;</span>
        <span class="nt">&lt;encoder&gt;</span>
            <span class="nt">&lt;pattern&gt;</span>%d{yyyy-MM-dd HH:mm:ss} %5p [${applicationName:-},%X{traceId:-},%X{spanId:-}] [%thread] %logger{36} - %msg%n<span class="nt">&lt;/pattern&gt;</span>
        <span class="nt">&lt;/encoder&gt;</span>
    <span class="nt">&lt;/appender&gt;</span>

    <span class="c">&lt;!-- Logger ì„¤ì • --&gt;</span>
    <span class="nt">&lt;root</span> <span class="na">level=</span><span class="s">"info"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">"CONSOLE"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">"FILE"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">"LOGSTASH"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/root&gt;</span>
<span class="nt">&lt;/configuration&gt;</span>
</code></pre></div></div>

<blockquote>
  <p>ì°¸ê³ ë¡œ Logstash ì˜ ê¸°ë³¸ PortëŠ” 5044ë¡œ êµ¬ë™ë©ë‹ˆë‹¤. ì‚¬ì´ë“œ í”„ë¡œì íŠ¸ì—ì„œ ë„ì»¤ë¡œ Logstashë¥¼ êµ¬ë™í•˜ì—¬ ì‹¤ìŠµì„ ì§„í–‰í–ˆìŠµë‹ˆë‹¤.</p>
</blockquote>

<p>ìœ„ ì²˜ëŸ¼ ì„¤ì •ì„ ë§ˆì¹˜ë©´ ì´ì œ ìŠ¤í”„ë§ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë¡œê¹… ì‹œìŠ¤í…œ(Logback)ì´ ìë™ìœ¼ë¡œ ë¡œê·¸ë¥¼ Logstash ë¡œ ì „ì†¡í•  ê²ƒì…ë‹ˆë‹¤.</p>

<h2 id="logstash---elasticsearch-ë¡œê·¸-ì €ì¥">Logstash -&gt; Elasticsearch ë¡œê·¸ ì €ì¥</h2>

<p><code class="language-plaintext highlighter-rouge">Logstash</code>ëŠ” ë‹¨ìˆœíˆ ë°ì´í„° íŒŒì´í”„ë¼ì¸ ì—­í• ë§Œ í•˜ê¸° ë•Œë¬¸ì—, ê²°êµ­ ë¡œê·¸ë¥¼ ì €ì¥í•  ë°ì´í„°ë² ì´ìŠ¤ê°€ í•„ìš”í•©ë‹ˆë‹¤. ì—¬ê¸°ì„œ <code class="language-plaintext highlighter-rouge">Elasticsearch</code>ê°€ ë¡œê·¸ë¥¼ ì €ì¥í•˜ëŠ” ì—­í• ì„ ë§¡ê²Œ ë©ë‹ˆë‹¤. ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ëŠ” ì•ì„œ ë§í–ˆë“¯ì´, ëŒ€ìš©ëŸ‰ ë¡œê·¸ ë°ì´í„°ë¥¼ ë¹ ë¥´ê²Œ ì¸ë±ì‹± ë° ê²€ìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë•ë¶„ì— ì°¾ê³ ì í•˜ëŠ” ë¡œê·¸ë¥¼ ë¹ ë¥´ê²Œ íƒìƒ‰í•  ìˆ˜ ìˆê²Œ ë˜ëŠ” ê²ƒì´ì£ .</p>

<p>ì•„ë˜ëŠ” Logstashì˜ ì„¤ì • íŒŒì¼ì…ë‹ˆë‹¤. <code class="language-plaintext highlighter-rouge">ì• í”Œë¦¬ì¼€ì´ì…˜ -&gt; Logstash (ìˆ˜ì§‘) -&gt; Elasticsearch (ì €ì¥)</code>ì²˜ëŸ¼ ì¼ë ¨ì˜ ë°ì´í„° íŒŒì´í”„ë¼ì¸ì˜ ì„¤ì • ê°’ì…ë‹ˆë‹¤.  ì´ë¥¼ Logstashë¥¼ êµ¬ë™ì‹œí‚¬ ë•Œ ì„¤ì •í•´ì£¼ì–´ì•¼ í•˜ëŠ” ê°’ì…ë‹ˆë‹¤.</p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">input</span> {
    <span class="n">tcp</span> {
        <span class="n">port</span> =&gt; <span class="m">5044</span>
        <span class="n">codec</span> =&gt; <span class="n">json</span>
    }
}

<span class="n">output</span> {
    <span class="n">elasticsearch</span> {
        <span class="n">hosts</span> =&gt; [<span class="s2">"http://elasticsearch:9200"</span>]
        <span class="n">index</span> =&gt; <span class="s2">"application-logs-%{+YYYY.MM.dd}"</span>
    }
}
</code></pre></div></div>

<ul>
  <li><strong>input</strong>: í•´ë‹¹ ì„¤ì •ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì…ë ¥ë°›ê² ë‹¤ëŠ” ì •ë³´ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. (TCP 5044, JSON í¬ë§·ìœ¼ë¡œ ë°ì´í„° ì…ë ¥ ë°›ìŒ.)</li>
  <li><strong>output</strong>: ì¶œë ¥í•˜ê³ ì í•˜ëŠ” ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ ì €ì¥ì†Œì˜ ì •ë³´ë¥¼ ì ì–´ì¤ë‹ˆë‹¤.
    <ul>
      <li><strong>hosts</strong>: ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ì˜ í˜¸ìŠ¤íŠ¸ ì •ë³´ë¥¼ ì ì–´ì¤ë‹ˆë‹¤. ìœ„ ì„¤ì •ì€ ë™ì¼í•œ ë„ì»¤ ë„¤íŠ¸ì›Œí¬ ìƒì—ì„œ êµ¬ë™ë˜ê³  ìˆëŠ” í™˜ê²½ì´ê¸° ë•Œë¬¸ì— ë„ì»¤ ì»¨í…Œì´ë„ˆëª…ì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.</li>
      <li><strong>index</strong>: ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ì˜ ì–´ë–¤ ì¸ë±ìŠ¤ì— ì €ì¥í•  ì§€ ëª…ì‹œí•´ì¤ë‹ˆë‹¤. (RDBMSì˜ í…Œì´ë¸”ëª…ì´ë¼ê³  ë³´ì‹œë©´ ë©ë‹ˆë‹¤.)</li>
    </ul>
  </li>
</ul>

<p>ìœ„ ì²˜ëŸ¼ <code class="language-plaintext highlighter-rouge">logstash.conf</code> íŒŒì¼ì„ ì„¤ì •í–ˆë‹¤ë©´, ì´ì œ <strong>Logstashê°€ ìˆ˜ì§‘í•œ ë¡œê·¸ ë°ì´í„°ë¥¼ Elasticsearch ì €ì¥ì†Œë¡œ ì „ì†¡</strong>í•  ê²ƒì…ë‹ˆë‹¤.</p>

<p>ë§Œì•½, Logstashë¥¼ ë„ì»¤ë¡œ êµ¬ë™í•˜ì‹ ë‹¤ë©´ ì•„ë˜ ë„ì»¤ ì»´í¬ì¦ˆ íŒŒì¼ì²˜ëŸ¼ <code class="language-plaintext highlighter-rouge">logstash.conf</code> íŒŒì¼ì„ ë³¼ë¥¨ ë§ˆìš´íŒ… í•´ì£¼ì…”ì•¼ í•©ë‹ˆë‹¤.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3'</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="na">logstash</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">docker.elastic.co/logstash/logstash:8.10.0</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">logstash</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">5044:5044"</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./logstash.conf:/usr/share/logstash/pipeline/logstash.conf</span>
</code></pre></div></div>

<h2 id="elasticsearch---kibana-ë¡œê·¸-ë°ì´í„°-ì‹œê°í™”">Elasticsearch -&gt; Kibana ë¡œê·¸ ë°ì´í„° ì‹œê°í™”</h2>

<p>ì´ì œ <code class="language-plaintext highlighter-rouge">Elasticsearch</code>ì— ë¡œê·¸ ë°ì´í„°ê°€ ì ì¬ëœë‹¤ë©´, Kibanaë¥¼ í™œìš©í•˜ì—¬ ë¡œê·¸ ë°ì´í„°ë¥¼ ì‹œê°í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p>ì´ë•Œ <code class="language-plaintext highlighter-rouge">Zipkin</code>ì„ í™œìš©í•œ ë¶„ì‚° ë¡œê·¸ íŠ¸ë ˆì´ì‹±ì„ í†µí•© ì ìš©í•œë‹¤ë©´, ì—¬ëŸ¬ ì„œë¹„ìŠ¤ì— ê±¸ì³ ì²˜ë¦¬ë  ë•Œ ë°œìƒí•˜ëŠ” ë¡œê·¸ì˜ íë¦„ì„ ì¶”ì í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì¤ë‹ˆë‹¤. ê° ìš”ì²­ì— <strong>ê³ ìœ í•œ TraceIDë¥¼ ë¶€ì—¬</strong>í•˜ì—¬, ì—¬ëŸ¬ ì„œë¹„ìŠ¤ì— ë¶„ì‚°ë˜ì–´ ê¸°ë¡ëœ ë¡œê·¸ë“¤ì„ <strong>Elasticsearchì—ì„œ í•˜ë‚˜ì˜ íë¦„ìœ¼ë¡œ ì—°ê²°ì§€ì–´ ê²€ìƒ‰</strong>í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p>Kibanaì˜ Discovery ì„œë¹„ìŠ¤ì—ì„œ <strong>TraceID</strong>ë¥¼ ì…ë ¥í•˜ë©´ í•´ë‹¹ ìš”ì²­ì— ê´€ë ¨ëœ ëª¨ë“  ë¡œê·¸ê°€ íƒ€ì„ìŠ¤íƒ¬í”„ ìˆœì„œëŒ€ë¡œ ì •ë ¬ì‹œì¼œ ëª¨ë‹ˆí„°ë§ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ë‹¨ì¼ ìš”ì²­ì´ ì„œë¹„ìŠ¤ ì „ë°˜ì—ì„œ ì–´ë–»ê²Œ ì²˜ë¦¬ë˜ì—ˆëŠ”ì§€ í•œëˆˆì— íŒŒì•…í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.</p>

<figure align="center">
<img src="/post_images/spring-cloud-side-project/logs-discovery.png" />
<figcaption></figcaption>
</figure>

<p>ë˜í•œ, ë¡œê·¸ ë ˆë²¨ì˜ ë¶„ë¥˜ë¥¼ í†µí•´ ì „ì²´ ë¡œê·¸ì— ëŒ€í•œ í†µê³„ë¥¼ ëŒ€ì‹œë³´ë“œë¡œ í™•ì¸ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>

<figure align="center">
<img src="/post_images/spring-cloud-side-project/logs-dashboard.png" />
<figcaption></figcaption>
</figure>

<h1 id="-ê²°ë¡ ">ğŸš€ ê²°ë¡ </h1>

<p>ELK ìŠ¤íƒì„ ê¸°ë°˜ìœ¼ë¡œ í•œ ì¤‘ì•™ ì§‘ì¤‘ì‹ ë¡œê·¸ ëª¨ë‹ˆí„°ë§ì€ MSA í™˜ê²½ì—ì„œ í•„ìˆ˜ì ì¸ ìš”ì†Œë¼ê³  ìƒê°í•©ë‹ˆë‹¤. ë¶„ì‚°ëœ ë¡œê·¸ë¥¼ í•œëˆˆì— íŒŒì•…í•  ìˆ˜ ì—†ëŠ” ë¬¸ì œë¥¼ í•´ê²°í•´ì£¼ê³ , ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ëŒ€ì‘ ëŠ¥ë ¥ì„ í–¥ìƒì‹œì¼œì¤Œê³¼ ë™ì‹œì—, Zipkinê³¼ì˜ í†µí•©ì„ í†µí•´ ìš”ì²­ì˜ ì „ì²´ íë¦„ì„ ì¶”ì í•  ìˆ˜ ìˆë‹¤ëŠ” ì ì€ ì‹œìŠ¤í…œ ìš´ì˜ì˜ íš¨ìœ¨ì„±ì„ í¬ê²Œ í–¥ìƒì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ELKìŠ¤íƒê³¼ Zipkinê³¼ ê°™ì€ ë„êµ¬ë“¤ì„ ì ì ˆíˆ í™œìš©í•œë‹¤ë©´, ì¥ì•  ë°œìƒ ì‹œ ë¹ ë¥¸ ì›ì¸ ë¶„ì„ê³¼ ë¬¸ì œ í•´ê²°ì´ ê°€ëŠ¥í•´ì ¸, ì „ì²´ ì„œë¹„ìŠ¤ì˜ ì•ˆì •ì„± ìœ ì§€ì— ê¸°ì—¬í•  ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤.</p>

<p>ì´ìƒìœ¼ë¡œ ELK ìŠ¤íƒê³¼ Zipkin í†µí•©ì„ í†µí•œ ì¤‘ì•™ ì§‘ì¤‘ì‹ ë¡œê·¸ ëª¨ë‹ˆí„°ë§ì˜ í•„ìš”ì„±ê³¼ ì¥ì ì— ëŒ€í•´ ì•Œì•„ë³´ì•˜ìŠµë‹ˆë‹¤. ë³¸ í¬ìŠ¤íŠ¸ë¥¼ ì°¸ê³ í•˜ì—¬ ì—¬ëŸ¬ë¶„ì˜ í™˜ê²½ì— ë§ëŠ” ìµœì ì˜ ë¡œê·¸ ê´€ë¦¬ ì‹œìŠ¤í…œ êµ¬ì¶•ì— ë„ì›€ì´ ë˜ì—ˆìœ¼ë©´ ì¢‹ê² ìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤.</p>

<h1 id="-ì°¸ê³ -ìë£Œ">ğŸ“‚ ì°¸ê³  ìë£Œ</h1>

<ul>
  <li><a href="https://www.inflearn.com/course/%EA%B0%9C%EB%B0%9C%EC%9E%90%EC%97%90%EA%B2%8C-%ED%95%84%EC%9A%94%ED%95%9C-%EB%A1%9C%EA%B7%B8%EA%B4%80%EB%A6%AC">ì¸í”„ëŸ° - ê°œë°œìì—ê²Œ í•„ìš”í•œ ë¡œê·¸ ê´€ë¦¬</a></li>
  <li><a href="https://engineering.linecorp.com/ko/blog/line-ads-msa-opentracing-zipkin">LINE ê´‘ê³  í”Œë«í¼ì˜ MSA í™˜ê²½ì—ì„œ Zipkinì„ í™œìš©í•´ ë¡œê·¸ íŠ¸ë ˆì´ì‹±í•˜ê¸°</a></li>
</ul>

<hr />]]></content><author><name>Bang Seung IL</name></author><category term="MSA" /><category term="ELK" /><category term="Elatsticsearch" /><category term="Logstash" /><category term="Kibana" /><category term="Logback" /><category term="Zipkin" /><summary type="html"><![CDATA[ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ì—ì„œ ELK(Elasticsearch + Logstash + Kibana) ìŠ¤íƒì„ í™œìš©í•œ ì¤‘ì•™ ì§‘ì¤‘ì‹ ë¡œê·¸ ëª¨ë‹ˆí„°ë§ì— ëŒ€í•´ ì•Œì•„ë´…ì‹œë‹¤!]]></summary></entry><entry><title type="html">Zipkinì„ í™œìš©í•œ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ë¶„ì‚° íŠ¸ë ˆì´ì‹±</title><link href="http://localhost:4000/spring%20cloud/zipkin/msa/2025/02/23/Zipkin-Distributed-Tracing/" rel="alternate" type="text/html" title="Zipkinì„ í™œìš©í•œ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ë¶„ì‚° íŠ¸ë ˆì´ì‹±" /><published>2025-02-23T00:00:00+09:00</published><updated>2025-02-23T00:00:00+09:00</updated><id>http://localhost:4000/spring%20cloud/zipkin/msa/2025/02/23/Zipkin-Distributed-Tracing</id><content type="html" xml:base="http://localhost:4000/spring%20cloud/zipkin/msa/2025/02/23/Zipkin-Distributed-Tracing/"><![CDATA[<blockquote>
  <p>ë¶„ì‚° í™˜ê²½ì—ì„œ Zipkinì„ í™œìš©í•œ ìš”ì²­ì˜ ì „ì²´ íë¦„ì„ ì¶”ì í•´ë´…ì‹œë‹¤!</p>
</blockquote>

<!-- more -->

<h1 id="-ë“¤ì–´ê°€ê¸°">ğŸ“Œ ë“¤ì–´ê°€ê¸°</h1>

<p>ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ëŠ” ë…ë¦½ì ìœ¼ë¡œ ë°°í¬ë˜ê³  ê´€ë¦¬ë˜ëŠ” ì‘ì€ ì„œë¹„ìŠ¤ë“¤ì´ ëª¨ì—¬ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ êµ¬ì„±í•˜ê²Œ ë©ë‹ˆë‹¤. ì´ëŸ¬í•œ í™˜ê²½ì—ì„œëŠ” ì„œë¹„ìŠ¤ ê°„ì˜ í†µì‹ ì´ ë¹ˆë²ˆí•˜ê²Œ ë°œìƒí•˜ë©°, ê° ì„œë¹„ìŠ¤ê°€ ë…ìì ì¸ ë¡œê·¸ë¥¼ ë‚¨ê¸°ê¸° ë•Œë¬¸ì— ì „ì²´ íŠ¸ëœì­ì…˜ì˜ íë¦„ì„ íŒŒì•…í•˜ê¸°ê°€ ì–´ë µìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ì£¼ë¬¸ ì„œë¹„ìŠ¤ -&gt; ê²°ì œ ì„œë¹„ìŠ¤ -&gt; ë°°ì†¡ ì„œë¹„ìŠ¤ ë“±ì˜ ì—¬ëŸ¬ ì„œë¹„ìŠ¤ê°€ ìˆœì°¨ì ìœ¼ë¡œ í˜¸ì¶œë˜ëŠ” ê³¼ì •ì—ì„œ ê° ì„œë¹„ìŠ¤ëŠ” ë³„ë„ì˜ ë¡œê·¸ë¥¼ ê°ì ë‚¨ê¸°ê¸° ë•Œë¬¸ì— ì–´ë–¤ ì„œë¹„ìŠ¤ì—ì„œ ë¬¸ì œê°€ ë°œìƒí–ˆëŠ”ì§€ í™•ì¸í•˜ê¸° ì–´ë µìŠµë‹ˆë‹¤.</p>

<p>ì´ëŸ¬í•œ ë¬¸ì œì  ë•Œë¬¸ì— <strong>ë¶„ì‚° íŠ¸ë ˆì´ì‹±</strong>ì€ ë¬¸ì œ ë°œìƒ ì‹œ ì›ì¸ì„ ì‹ ì†í•˜ê²Œ íŒŒì•…í•˜ê³ , ì„±ëŠ¥ ë³‘ëª©ì„ ì°¾ì•„ë‚´ëŠ” ë° í•„ìˆ˜ì ì¸ ë„êµ¬ë¡œ ë“±ì¥í•©ë‹ˆë‹¤.</p>

<p>ë³¸ í¬ìŠ¤íŠ¸ì—ì„œëŠ” ë¶„ì‚° íŠ¸ë ˆì´ì‹± ë„êµ¬ ì¤‘ <code class="language-plaintext highlighter-rouge">Zipkin</code>ì„ í™œìš©í•œ ë¶„ì‚° íŠ¸ë ˆì´ì‹±ì„ ë‹¤ë£¨ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.</p>

<h1 id="ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤-í™˜ê²½ì˜-ë³µì¡ì„±">ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ í™˜ê²½ì˜ ë³µì¡ì„±</h1>

<p>ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ì—ì„œëŠ” <strong>í•˜ë‚˜ì˜ ì‚¬ìš©ì ìš”ì²­ì´ ì—¬ëŸ¬ ì„œë¹„ìŠ¤ë¥¼ ê±°ì¹˜ë©° ì²˜ë¦¬</strong>ë©ë‹ˆë‹¤. ì£¼ë¬¸, ê²°ì œ, ë°°ì†¡ ì„œë¹„ìŠ¤ ë“± ì—¬ëŸ¬ ì„œë¹„ìŠ¤ë¥¼ ê±°ì¹˜ê²Œ ë˜ëŠ” ê²ƒì´ì£ . ì´ëŸ¬í•œ <strong>ë¶„ì‚°ëœ í˜¸ì¶œ êµ¬ì¡°</strong>ëŠ” ì—¬ëŸ¬ <strong>ë¬¸ì œì </strong>ì„ ìœ ë°œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p>ê° ì„œë¹„ìŠ¤ë§ˆë‹¤ <strong>ë³„ë„ì˜ ë¡œê·¸</strong>ë¥¼ ë‚¨ê¸°ê¸° ë•Œë¬¸ì— í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ì´ ì–´ë””ì—ì„œ ì§€ì—°ë˜ê±°ë‚˜ ì¥ì• ê°€ ë°œìƒí–ˆëŠ”ì§€ í™•ì¸í•˜ê¸° ì–´ë µìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  ì „ì²´ íë¦„ì—ì„œ ì–´ëŠ ë¶€ë¶„ì´ ì‘ë‹µ ì‹œê°„ì„ ì§€ì—°ì‹œí‚¤ëŠ”ì§€ë„ íŒŒì•…í•˜ê¸° ì–´ë µìŠµë‹ˆë‹¤.</p>

<p><strong>ëª¨ë†€ë¦¬ì‹(Monolihic)</strong>ì˜ ê²½ìš° í•˜ë‚˜ì˜ ì„œë¹„ìŠ¤ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ êµ¬ë™ë˜ê¸° ë•Œë¬¸ì—, ì „ì²´ íë¦„ì— ëŒ€í•œ ë¡œê·¸ë¥¼ í•˜ë‚˜ì˜ ì„œë¹„ìŠ¤ì—ì„œ ë””ë²„ê¹… í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ <strong>MSA</strong>ì—ì„œëŠ” ë¬¸ì œë¥¼ íŒŒì•…í•˜ê¸° ìœ„í•´ ê´€ë ¨ëœ ëª¨ë“  ì„œë¹„ìŠ¤ë“¤ì˜ ë¡œê·¸ë¥¼ í•˜ë‚˜í•˜ë‚˜ ë‹¤ ì‚´í´ë´ì•¼ í•˜ëŠ” ë²ˆê±°ë¡œì›€ì´ ì¡´ì¬í•©ë‹ˆë‹¤.</p>

<p>ë§Œì•½ ë¶„ì‚° íŠ¸ë ˆì´ì‹± ë„êµ¬ê°€ ì—†ë‹¤ë©´, ìœ„ì™€ ê°™ì€ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ê° ì„œë¹„ìŠ¤ì—ì„œ ê°œë³„ì ìœ¼ë¡œ ë¡œê·¸ë¥¼ ë¶„ì„í•´ì•¼ í•˜ë©°, ì´ëŠ” ì‹œê°„ ì†Œëª¨ì ì´ì´ê³  ë¹„íš¨ìœ¨ì ì¼ ë¿ë§Œ ì•„ë‹ˆë¼, ë¬¸ì œ ì§„ë‹¨ì˜ ì–´ë ¤ì›€ì´ ë”°ë¥´ê¸° ë•Œë¬¸ì— ì‹ ì†í•˜ê²Œ ëŒ€ì‘í•˜ì§€ ëª»í•  ìœ„í—˜ì´ ë†’ì•„ì§‘ë‹ˆë‹¤.</p>

<h1 id="zipkinì„-í™œìš©í•œ-ìš”ì²­-ì¶”ì ">Zipkinì„ í™œìš©í•œ ìš”ì²­ ì¶”ì </h1>

<p><code class="language-plaintext highlighter-rouge">Zipkin</code>ì€ <strong>ì˜¤í”ˆ ì†ŒìŠ¤ ë¶„ì‚° íŠ¸ë ˆì´ì‹± ì‹œìŠ¤í…œ</strong>ìœ¼ë¡œ, ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ í™˜ê²½ì—ì„œ ì„œë¹„ìŠ¤ ê°„ í˜¸ì¶œ íë¦„ì„ <strong>ì‹œê°í™”í•˜ê³  ë¶„ì„í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ëŠ” ë„êµ¬</strong>ì…ë‹ˆë‹¤. <code class="language-plaintext highlighter-rouge">Zipkin</code>ì„ í™œìš©í•˜ë©´ ê° ì„œë¹„ìŠ¤ì˜ í˜¸ì¶œ ë°ì´í„°ë¥¼ ì¤‘ì•™ì—ì„œ ìˆ˜ì§‘í•˜ì—¬ ì•„ë˜ ë¬¸ì œì ë“¤ì„ í•´ê²°í•´ì¤ë‹ˆë‹¤.</p>

<ol>
  <li><strong>ì „ì²´ í˜¸ì¶œ íë¦„ ì‹œê°í™”</strong>: ì‚¬ìš©ì ìš”ì²­ì´ ì–´ë–¤ ê²½ë¡œë¡œ ì „ë‹¬ë˜ëŠ”ì§€ ì‹œê°í™”í•˜ì—¬ í•œ ëˆˆì— íŒŒì•… í• ìˆ˜ ìˆë„ë¡ í•´ì¤ë‹ˆë‹¤.</li>
  <li><strong>Latency ë¶„ì„</strong>: ê° ì„œë¹„ìŠ¤ ê°„ í˜¸ì¶œì˜ ì‘ë‹µ ì‹œê°„ ì •ë³´ë¥¼ ì œê³µí•˜ì—¬ ì–´ë–¤ ì„œë¹„ìŠ¤ì˜ ì–´ë–¤ ë¡œì§ì—ì„œ ì„±ëŠ¥ ë³‘ëª©ì´ ì¼ì–´ë‚˜ëŠ”ì§€ ì‰½ê²Œ ì‹ë³„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li><strong>ì¥ì•  ì›ì¸ ë¶„ì„</strong>: íŠ¸ëœì­ì…˜ ì¤‘ ë°œìƒí•œ ì˜ˆì™¸ë‚˜ ì˜¤ë¥˜ë¥¼ ì‹ ì†í•˜ê²Œ íƒì§€í•˜ê³ , ì–´ëŠ ì„œë¹„ìŠ¤ì—ì„œ ë¬¸ì œê°€ ë°œìƒí–ˆëŠ”ì§€ ë¶„ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ol>

<h1 id="zipkin-ì ìš©-ë°©ë²•">Zipkin ì ìš© ë°©ë²•</h1>

<p>ì˜ˆì „ì—ëŠ” Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì‰½ê²Œ ë¶„ì‚° íŠ¸ë ˆì´ì‹± ê¸°ëŠ¥ì„ ì¶”ê°€í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ëŠ” <code class="language-plaintext highlighter-rouge">Spring Cloud Sleuth</code>ë¼ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í–ˆì—ˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ìµœê·¼ ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸ ë˜ë©´ì„œ <code class="language-plaintext highlighter-rouge">Spring Cloud Sleuth</code>ëŠ” Deprecated ë  ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ìµœê·¼ ë²„ì „ì—ì„œëŠ” <code class="language-plaintext highlighter-rouge">Micrometer</code>ë¡œ ë¶„ì‚° íŠ¸ë ˆì´ì‹± ê¸°ëŠ¥ì„ ì¶”ê°€í•˜ë„ë¡ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.</p>

<h2 id="dependency">Dependency</h2>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">implementation</span> <span class="s1">'org.springframework.boot:spring-boot-starter-actuator'</span>
	<span class="n">implementation</span> <span class="s1">'io.micrometer:micrometer-observation'</span>
	<span class="n">implementation</span> <span class="s1">'io.micrometer:micrometer-tracing-bridge-brave'</span>
	<span class="n">implementation</span> <span class="s1">'io.zipkin.brave:brave-instrumentation-spring-web'</span>
	<span class="n">implementation</span> <span class="s1">'io.zipkin.reporter2:zipkin-reporter-brave'</span>
</code></pre></div></div>

<h2 id="applicationyml">application.yml</h2>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">spring</span><span class="pi">:</span>
  <span class="na">application</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">product-service</span>
<span class="na">management</span><span class="pi">:</span>
  <span class="na">tracing</span><span class="pi">:</span>
    <span class="na">sampling</span><span class="pi">:</span>
      <span class="na">probability</span><span class="pi">:</span> <span class="m">1.0</span>
    <span class="na">propagation</span><span class="pi">:</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">b3</span>
  <span class="na">zipkin</span><span class="pi">:</span>
    <span class="na">tracing</span><span class="pi">:</span>
      <span class="na">endpoint</span><span class="pi">:</span> <span class="s">${MANAGEMENT_ZIPKIN_TRACING_ENDPOINT:http://localhost:9411/api/v2/spans}</span>
</code></pre></div></div>

<ul>
  <li>ì—¬ê¸°ì„œ <code class="language-plaintext highlighter-rouge">spring.application.name</code>ì€ ì„œë¹„ìŠ¤ íƒœê¹…ì— í™œìš©ë˜ë©°, ê° ì„œë¹„ìŠ¤ì˜ ì´ë¦„ì´ <strong>Zipkin UI</strong>ì— í‘œì‹œë˜ì–´ í˜¸ì¶œ íë¦„ì„ ì‰½ê²Œ íŒŒì•…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ìœ„ì™€ ê°™ì´ ì˜ì¡´ì„±ê³¼ ì„¤ì •ì„ ë§ˆì¹˜ë©´, ìë™ìœ¼ë¡œ <strong>ê° ìš”ì²­ì— ê³ ìœ í•œ Trace IDì™€ Span IDë¥¼ ë¶€ì—¬í•˜ì—¬, ì„œë¹„ìŠ¤ ê°„ì˜ í˜¸ì¶œ ê´€ê³„ë¥¼ ì¶”ì </strong>í•˜ê²Œ ë©ë‹ˆë‹¤.</li>
</ul>

<h1 id="zipkin-uië¥¼-í™œìš©í•œ-íŠ¸ë ˆì´ìŠ¤-ë¶„ì„">Zipkin UIë¥¼ í™œìš©í•œ íŠ¸ë ˆì´ìŠ¤ ë¶„ì„</h1>

<h2 id="ì„œë¹„ìŠ¤-ê°„-í˜¸ì¶œ-íë¦„-ì‹œê°í™”">ì„œë¹„ìŠ¤ ê°„ í˜¸ì¶œ íë¦„ ì‹œê°í™”</h2>

<p><strong>Zipkin UI</strong>ëŠ” ìˆ˜ì§‘ëœ íŠ¸ë ˆì´ìŠ¤ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ, ì„œë¹„ìŠ¤ ê°„ í˜¸ì¶œ íë¦„ì„ ì§ê´€ì ìœ¼ë¡œ ì‹œê°í™”í•´ì¤ë‹ˆë‹¤. ê°œë°œìëŠ” UIë¥¼ í†µí•´ ê° ì„œë¹„ìŠ¤ê°€ í˜¸ì¶œí•œ ìˆœì„œì™€ ê´€ê³„ë¥¼ ê·¸ë˜í”½ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜í•œ íŠ¹ì • íŠ¸ëœì­ì…˜ì˜ ì„¸ë¶€ì ì¸ ìŠ¤íŒ¬ ì •ë³´ì™€ íƒ€ì„ë¼ì¸ì„ ë¶„ì„í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.</p>

<h2 id="latency-ë¶„ì„-ë°-ì¥ì• -ê°ì§€">Latency ë¶„ì„ ë° ì¥ì•  ê°ì§€</h2>

<p>Zipkin UIì—ì„œëŠ” ê° ìŠ¤íŒ¬ì˜ ì‘ë‹µ ì‹œê°„ì„ ì‹œê°ì ìœ¼ë¡œ í‘œì‹œí•˜ì—¬, ì–´ëŠ ë¶€ë¶„ì—ì„œ ì§€ì—°ì´ ë°œìƒí–ˆëŠ”ì§€ ì‰½ê²Œ ì‹ë³„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì„±ëŠ¥ ë³‘ëª© êµ¬ê°„ì„ ì°¾ì•„ë‚´ê³ , ì¥ì•  ë°œìƒ ì‹œ ì›ì¸ ë¶„ì„ì— í•„ìš”í•œ ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤. ë§Œì•½ ì´ëŸ¬í•œ ì‹œê°í™” ë„êµ¬ê°€ ì—†ìœ¼ë©´, ë¡œê·¸ íŒŒì¼ë§Œìœ¼ë¡œ ê° ì„œë¹„ìŠ¤ ê°„ì˜ í˜¸ì¶œ ê´€ê³„ì™€ ì§€ì—° ì‹œê°„ì„ ë¶„ì„í•´ì•¼ í•˜ë¯€ë¡œ, ë¬¸ì œ ë°œìƒ ì‹œ ì¦‰ê°ì ì¸ ëŒ€ì‘ì´ ì–´ë ¤ì›Œì§ˆ ê²ƒì…ë‹ˆë‹¤.</p>

<h1 id="spring-aopë¥¼-í™œìš©í•œ-ë¯¸ë“¤ì›¨ì–´-ê°„ì˜-ìš”ì²­-ì¶”ì ">Spring AOPë¥¼ í™œìš©í•œ ë¯¸ë“¤ì›¨ì–´ ê°„ì˜ ìš”ì²­ ì¶”ì </h1>

<p>ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ì—ì„œëŠ” HTTP í˜¸ì¶œ ì™¸ì—ë„ Kafka, Redisì™€ ê°™ì€ ë¯¸ë“¤ì›¨ì–´ë¥¼ í™œìš©í•˜ëŠ” ê²½ìš°ê°€ ë§ìŠµë‹ˆë‹¤. Zipkinê³¼ Micrometerì˜ ê¸°ë³¸ ì˜ì¡´ì„±ê³¼ ì„¤ì •ë§Œìœ¼ë¡œëŠ” ë¯¸ë“¤ì›¨ì–´ í†µì‹  ê²½ë¡œë¥¼ ìë™ ì¶”ì í•˜ì§„ ì•ŠìŠµë‹ˆë‹¤. ë¯¸ë“¤ì›¨ì–´ê°„ì˜ í˜¸ì¶œ íë¦„ê¹Œì§€ ì¶”ì í•˜ê¸° ìœ„í•´, ì¶”ì ì— í•„ìš”í•œ ë¡œì§ì„ <strong>ìŠ¤í”„ë§ AOP</strong>ë¥¼ í™œìš©í•˜ì—¬ <strong>ì‚¬ìš©ì ì •ì˜ íŠ¸ë ˆì´ì‹±</strong> ì½”ë“œë¥¼ ì‚½ì…í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.</p>

<p>ì˜ˆë¥¼ ë“¤ì–´, ìŠ¤í”„ë§ AOPë¥¼ í™œìš©í•˜ì—¬ Kafkaë¥¼ í†µí•œ ë©”ì‹œì§€ ë°œí–‰/êµ¬ë… íë¦„ë„ ì¶”ì í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ë©”ì‹œì§€ íë¥¼ í†µí•œ ë¹„ë™ê¸° í˜¸ì¶œë„ ëª…í™•í•˜ê²Œ ì¶”ì í•  ìˆ˜ ìˆìœ¼ë©°, ë©”ì‹œì§€ ì†ì‹¤ì´ë‚˜ ì§€ì—° ë¬¸ì œë¥¼ ì‰½ê²Œ ì¶”ì í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p>ë§Œì•½ ì´ëŸ¬í•œ ë¯¸ë“¤ì›¨ì–´ ì¶”ì  ë©”ì»¤ë‹ˆì¦˜ì´ ì—†ë‹¤ë©´, ê° ë¯¸ë“¤ì›¨ì–´ ê°„ì˜ í˜¸ì¶œ íë¦„ì´ ë‹¨ì ˆë˜ì–´ ë¬¸ì œ ë°œìƒ ì‹œ ì›ì¸ íŒŒì•…ì— í° ì–´ë ¤ì›€ì´ ë”°ë¥¼ ê²ƒì…ë‹ˆë‹¤. ì´ëŠ” ë””ë²„ê¹… í•˜ëŠ” ì‹œê°„ì´ ê¸‰ê²©íˆ ì¦ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<h1 id="-ê²°ë¡ ">ğŸš€ ê²°ë¡ </h1>

<p>ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ì—ì„œëŠ” ì„œë¹„ìŠ¤ ê°„ í˜¸ì¶œ íë¦„ì´ ë³µì¡í•´ì§ì— ë”°ë¼, ë‹¨ìˆœ ë¡œê·¸ ë¶„ì„ë§Œìœ¼ë¡œëŠ” ë¬¸ì œì˜ ì›ì¸ì„ íŒŒì•…í•˜ê¸° ì–´ë µìŠµë‹ˆë‹¤. <code class="language-plaintext highlighter-rouge">Zipkin</code>ê³¼ <code class="language-plaintext highlighter-rouge">Micrometer</code>ë¥¼ í™œìš©í•˜ë©´, ì „ì²´ íŠ¸ëœì­ì…˜ì˜ íë¦„ì„ ì‹œê°í™”í•˜ê³  ê° ì„œë¹„ìŠ¤ì˜ ì„±ëŠ¥ì„ ëª¨ë‹ˆí„°ë§í•  ìˆ˜ ìˆì–´ ë¬¸ì œ ë°œìƒ ì‹œ ì‹ ì†í•˜ê²Œ ëŒ€ì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ ë„êµ¬ë“¤ì´ ì—†ë‹¤ë©´, ì‹œìŠ¤í…œ ì¥ì• ë‚˜ ì„±ëŠ¥ ë³‘ëª©ì„ ì°¾ì•„ë‚´ëŠ” ë°ì— ë§ì€ ì‹œê°„ê³¼ ë¦¬ì†ŒìŠ¤ê°€ ì†Œëª¨ë˜ë©°, ì´ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ì— ì‹¬ê°í•œ ì˜í–¥ì„ ë¯¸ì¹  ê²ƒì…ë‹ˆë‹¤. MSA í™˜ê²½ì—ì„œ <code class="language-plaintext highlighter-rouge">Zipkin</code>ì„ í†µí•œ <strong>ë¶„ì‚° íŠ¸ë ˆì´ì‹±</strong>ì€ ë‹¨ìˆœíˆ ë¡œê·¸ë¥¼ ë‚¨ê¸°ëŠ” ê²ƒì„ ë„˜ì–´, ì‹œìŠ¤í…œì˜ <strong>ì „ì²´ì ì¸ ê±´ê°• ìƒíƒœë¥¼ ê´€ë¦¬</strong>í•˜ê³ , ì¥ì•  ë°œìƒ ì‹œ <strong>ì‹ ì†í•œ ì›ì¸ ë¶„ì„ ë° ëŒ€ì‘</strong> ì „ëµì„ ë§ˆë ¨í•˜ëŠ” ë° <strong>í•„ìˆ˜ì ì¸ ìš”ì†Œ</strong>ë¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<h1 id="ì°¸ê³ -ìë£Œ">ì°¸ê³  ìë£Œ</h1>

<ul>
  <li><a href="https://engineering.linecorp.com/ko/blog/line-ads-msa-opentracing-zipkin">LINE ê´‘ê³  í”Œë«í¼ì˜ MSA í™˜ê²½ì—ì„œ Zipkinì„ í™œìš©í•´ ë¡œê·¸ íŠ¸ë ˆì´ì‹±í•˜ê¸°</a></li>
  <li><a href="https://github.com/openzipkin/b3-propagation">b3-propagation</a></li>
</ul>

<hr />]]></content><author><name>Bang Seung IL</name></author><category term="Spring Cloud" /><category term="Zipkin" /><category term="MSA" /><category term="Distributed Tracing" /><category term="b3 propagation" /><category term="Micrometer" /><summary type="html"><![CDATA[ë¶„ì‚° í™˜ê²½ì—ì„œ Zipkinì„ í™œìš©í•œ ìš”ì²­ì˜ ì „ì²´ íë¦„ì„ ì¶”ì í•´ë´…ì‹œë‹¤!]]></summary></entry><entry><title type="html">Redissonì„ í™œìš©í•œ ë¶„ì‚° ë½ ê·¸ë¦¬ê³  AOP ì ìš©</title><link href="http://localhost:4000/msa/redis/2025/02/22/Redisson-Lock-and-AOP/" rel="alternate" type="text/html" title="Redissonì„ í™œìš©í•œ ë¶„ì‚° ë½ ê·¸ë¦¬ê³  AOP ì ìš©" /><published>2025-02-22T00:00:00+09:00</published><updated>2025-02-22T00:00:00+09:00</updated><id>http://localhost:4000/msa/redis/2025/02/22/Redisson-Lock-and-AOP</id><content type="html" xml:base="http://localhost:4000/msa/redis/2025/02/22/Redisson-Lock-and-AOP/"><![CDATA[<blockquote>
  <p>ë¶„ì‚° ì‹œìŠ¤í…œì—ì„œ Redisë¥¼ ì´ìš©í•œ ë¶„ì‚° ë½ì˜ í•„ìš”ì„±ê³¼ ë¶„ì‚° ë½ ì ìš© ë¶€ë¶„ì˜ AOP í™œìš© ë°©ë²•ì„ ì•Œì•„ë´…ì‹œë‹¤.</p>
</blockquote>

<!-- more -->

<h1 id="-ë“¤ì–´ê°€ê¸°">ğŸ“Œ ë“¤ì–´ê°€ê¸°</h1>

<p>MSAì™€ ê°™ì€ ë¶„ì‚° ì‹œìŠ¤í…œì—ì„œëŠ” ì—¬ëŸ¬ ì¸ìŠ¤í„´ìŠ¤ê°€ ë™ì‹œì— í•˜ë‚˜ì˜ ë¦¬ì†ŒìŠ¤ì— ì ‘ê·¼í•˜ëŠ” ê²½ìš°ê°€ ë¹ˆë²ˆí•˜ê²Œ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ì£¼ë¬¸ì´ ë™ì‹œë‹¤ë°œì ìœ¼ë¡œ ë°œìƒí•˜ì—¬ ìƒí’ˆì˜ ì¬ê³ ë¥¼ ì°¨ê°í•˜ê¸° ìœ„í•´ ì—¬ëŸ¬ ì¸ìŠ¤í„´ìŠ¤ê°€ ì¬ê³ ì— ì ‘ê·¼í•˜ëŠ” ê²½ìš°ê°€ ê·¸ë ‡ìŠµë‹ˆë‹¤.</p>

<p>ì´ë•Œ ë™ì‹œì„± ì´ìŠˆê°€ ë°œìƒí•˜ì—¬ ë°ì´í„° ë¬´ê²°ì„±ì— ë¬¸ì œê°€ ë°œìƒí•©ë‹ˆë‹¤. ì´ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ ë¶„ì‚° ë½(Distributed Lock)ì´ í•„ìš”í•œ ê²ƒì…ë‹ˆë‹¤.</p>

<p>ë³¸ í¬ìŠ¤íŠ¸ì—ì„œëŠ” Redisê¸°ë°˜ì˜ <strong>ë¶„ì‚° ë½</strong>ì„ êµ¬í˜„í•˜ê¸° ìœ„í•´ <strong>Redisson</strong>ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ í™œìš©í•˜ëŠ” ë°©ë²•ê³¼, <strong>ìŠ¤í”„ë§ AOP(Aspect Oriented Programming)</strong>ë¥¼ í†µí•´ ë½ ì²˜ë¦¬ ë¡œì§ì„ ë¶„ë¦¬í•˜ì—¬ ì½”ë“œì˜ ì‘ì§‘ë„ì™€ ìœ ì§€ë³´ìˆ˜ì„±ì„ ë†’ì´ëŠ” ë°©ë²•ì„ ì‚´í´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.</p>

<h1 id="redis-ë¼ì´ë¸ŒëŸ¬ë¦¬-redissonì„-í™œìš©í•œ-ë¶„ì‚°-ë½">Redis ë¼ì´ë¸ŒëŸ¬ë¦¬: Redissonì„ í™œìš©í•œ ë¶„ì‚° ë½</h1>

<p>RedisëŠ” ì¸ë©”ëª¨ë¦¬ ë°ì´í„° ì €ì¥ì†Œë¡œ ë†’ì€ ì„±ëŠ¥ê³¼ ë¹ ë¥¸ ì‘ë‹µ ì†ë„ë¥¼ ì œê³µí•©ë‹ˆë‹¤. ì´ë¥¼ í™œìš©í•˜ì—¬ ì—¬ëŸ¬ í”„ë¡œì„¸ìŠ¤ í˜¹ì€ ì„œë²„ ê°„ì— ë¶„ì‚° ë½ì„ êµ¬í˜„í•  ìˆ˜ ìˆìœ¼ë©°, ë¶„ì‚° í™˜ê²½ì—ì„œì˜ ë™ì‹œì„± ì œì–´ì™€ ë°ì´í„° ë¬´ê²°ì„± í™•ë³´ì— í° ì—­í• ì„ í•˜ê²Œ ë©ë‹ˆë‹¤.</p>

<p><strong>Redisson</strong>ì€ Redisë¥¼ Java ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì‰½ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì§€ì›í•˜ëŠ” <strong>Redis í´ë¼ì´ì–¸íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬</strong>ì…ë‹ˆë‹¤. Redissonì€ ë¶„ì‚° ë½, ì„¸ë§ˆí¬ì–´ ë“± ì—¬ëŸ¬ ë™ì‹œì„± ê´€ë ¨ ê¸°ëŠ¥ì„ ì œê³µí•˜ë©°, <strong>ë³µì¡í•œ ë½ ë¡œì§ì„ ë‹¨ìˆœí™”</strong>ì‹œì¼œ ì¤ë‹ˆë‹¤.</p>

<h1 id="lettuce-vs-redisson">Lettuce vs Redisson</h1>

<p><code class="language-plaintext highlighter-rouge">Spring Data Redis</code> ì˜ì¡´ì„±ì„ ì¶”ê°€í•˜ë©´ ê¸°ë³¸ì ìœ¼ë¡œ Lettuce ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ Redis í´ë¼ì´ì–¸íŠ¸ë¡œ ì‚¬ìš©í•˜ê²Œ ë©ë‹ˆë‹¤. ê¸°ë³¸ì ìœ¼ë¡œ ì œê³µí•˜ëŠ” Lettuceê°€ ìˆìŒì—ë„ ë¶„ì‚° ë½ì— Redissonì„ ì‚¬ìš©í•˜ëŠ” ì´ìœ ëŠ” ë¬´ì—‡ì¼ê¹Œìš”?</p>

<p>ë¶„ì‚° ë½ì— <code class="language-plaintext highlighter-rouge">Lettuce</code> ëŒ€ì‹  <code class="language-plaintext highlighter-rouge">Redisson</code>ì„ ì‚¬ìš©í•˜ëŠ” ì´ìœ ëŠ” <strong>ë½ íšë“ ë°©ì‹</strong> ì°¨ì´ì ì— ìˆìŠµë‹ˆë‹¤.</p>

<p><code class="language-plaintext highlighter-rouge">Lettuce</code>ëŠ” ìŠ¤ë ˆë“œê°€ ë½ íšë“ ëŒ€ê¸° ìƒíƒœì¼ ê²½ìš°, <code class="language-plaintext highlighter-rouge">spin lock</code> ë°©ì‹ìœ¼ë¡œ ëŒ€ê¸°í•˜ê²Œ ë©ë‹ˆë‹¤. ë§ì€ ìŠ¤ë ˆë“œê°€ ìŠ¤í•€ ë½ìœ¼ë¡œ Redisì— ë½ì„ ìš”ì²­í•˜ê²Œ ë  ê²½ìš° Redisì— í° ë¶€í•˜ê°€ ìƒê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë°˜ë©´ì— <code class="language-plaintext highlighter-rouge">Redisson</code>ì€ ë½ íšë“ ë°©ì‹ì´ <code class="language-plaintext highlighter-rouge">pub/sub</code> ë°©ì‹ìœ¼ë¡œ êµ¬í˜„ë˜ì–´ ìˆê¸° ë•Œë¬¸ì— ìŠ¤í•€ ë½ ë°©ì‹ë³´ë‹¤ëŠ” Redisì— ë¶€í•˜ ë¶€ë‹´ì´ ì¤„ì–´ë“¤ê²Œ ë©ë‹ˆë‹¤. ë”ë¶ˆì–´ <code class="language-plaintext highlighter-rouge">Redisson</code>ì€ ë½ íšë“ ì¬ì‹œë„ë¥¼ ê¸°ë³¸ ë¡œì§ìœ¼ë¡œ ì œê³µí•´ì£¼ê¸° ë•Œë¬¸ì— í¸ë¦¬í•˜ê²Œ Lockì„ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤.</p>

<h1 id="redisson-lock-ì˜ˆì œ-ì½”ë“œ">Redisson Lock ì˜ˆì œ ì½”ë“œ</h1>

<p>ì•„ë˜ëŠ” ì‚¬ì´ë“œ í”„ë¡œì íŠ¸ì—ì„œ <code class="language-plaintext highlighter-rouge">Redisson</code>ì„ í™œìš©í•˜ì—¬ ë¶„ì‚° ë½ì„ êµ¬í˜„í•œ ì½”ë“œì…ë‹ˆë‹¤. ë™ì‹œì„± ì´ìŠˆê°€ ë°œìƒí•  ìˆ˜ ìˆëŠ” ì‘ì—…ì„ ìˆ˜í–‰í•˜ê¸° ì „ì— ë¶„ì‚° ë½ì„ íšë“í•˜ê³ , ì‘ì—…ì„ ë§ˆì³¤ë‹¤ë©´ ë½ì„ ë°˜ë‚©í•˜ë©´ ë©ë‹ˆë‹¤. ì´ë¡œì¨ ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— ì ‘ê·¼í•˜ë”ë¼ë„ ë™ì‹œì„± ë¬¸ì œê°€ ë°œìƒí•˜ì§€ ì•Šê²Œ ë©ë‹ˆë‹¤.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="nd">@Slf4j</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedissonLockService</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">RedissonClient</span> <span class="n">redissonClient</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">tryLock</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">,</span> <span class="kt">long</span> <span class="n">waitTime</span><span class="o">,</span> <span class="kt">long</span> <span class="n">leaseTime</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">RLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">redissonClient</span><span class="o">.</span><span class="na">getLock</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">lock</span><span class="o">.</span><span class="na">tryLock</span><span class="o">(</span><span class="n">waitTime</span><span class="o">,</span> <span class="n">leaseTime</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
            <span class="c1">// waitTime: ë½ì„ ê¸°ë‹¤ë¦¬ëŠ” ì‹œê°„</span>
            <span class="c1">// leaseTime: ë½ì´ ìë™ìœ¼ë¡œ í•´ì œë˜ê¸°ê¹Œì§€ ìœ ì§€ë˜ëŠ” ì‹œê°„</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Failed to acquire lock"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">unlock</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">RLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">redissonClient</span><span class="o">.</span><span class="na">getLock</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">lock</span><span class="o">.</span><span class="na">isHeldByCurrentThread</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">tryLock</code> ë©”ì„œë“œë¥¼ í†µí•´ ë½ íšë“ ì‹œë„ë¥¼ í•˜ê²Œ ë©ë‹ˆë‹¤. íšë“ì— ì„±ê³µí•œë‹¤ë©´ <code class="language-plaintext highlighter-rouge">true</code>ë¥¼ ë°˜í™˜í•˜ê³ , <code class="language-plaintext highlighter-rouge">waitTime</code>ë™ì•ˆ ë½ì„ íšë“í•˜ì§€ ëª»í•œë‹¤ë©´ ì˜ˆì™¸ê°€ ë°œìƒí•˜ê³  <code class="language-plaintext highlighter-rouge">false</code>ë¥¼ ë°˜í™˜í•˜ê²Œ ë©ë‹ˆë‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">tryLock</code> ë©”ì„œë“œëŠ” <strong>ë¸”ë½í‚¹(blocking) ë©”ì„œë“œë¡œ, ë½ì„ íšë“í•˜ì§€ ëª» í•œ ê²½ìš° ìŠ¤ë ˆë“œê°€ ëŒ€ê¸° ìƒíƒœì— ë†“ì´ê²Œ ë©ë‹ˆë‹¤.</strong></li>
  <li>ë½ íšë“ keyëŠ” ë™ì‹œì„± ì´ìŠˆë¥¼ ì˜ˆë°©í•˜ê³ ì í•˜ëŠ” ëŒ€ìƒì˜ ê³ ìœ í•œ ì‹ë³„ìê°€ ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. <code class="language-plaintext highlighter-rouge">ex: productId</code></li>
  <li><code class="language-plaintext highlighter-rouge">waitTime</code>ë™ì•ˆ ë½ íšë“ ëŒ€ê¸° ìƒíƒœì— ë†“ì´ê²Œ ë˜ë©°, ë½ì„ ì‚¬ìš©í•˜ë˜ ìŠ¤ë ˆë“œê°€ ë½ì„ í•´ì œí•˜ë©´ <code class="language-plaintext highlighter-rouge">pub/sub</code> ë°©ì‹ì„ í†µí•´ ëŒ€ê¸° ìƒíƒœì— ë†“ì—¬ìˆë˜ ìŠ¤ë ˆë“œì—ê²Œ ë½ íšë“ ì‹œë„ë¥¼ í•˜ë¼ê³  ì•Œë¦¼ì„ ë³´ë‚´ê²Œ ë©ë‹ˆë‹¤.</li>
  <li>ë§Œì•½ ë½ì„ íšë“í•˜ê³  ì‘ì—… ì‹œê°„ì´ <code class="language-plaintext highlighter-rouge">leaseTime</code>ì„ ë„˜ì–´ê°€ê²Œ ë˜ë©´ ìë™ìœ¼ë¡œ ë½ì´ í•´ì œë©ë‹ˆë‹¤. ë”°ë¼ì„œ <code class="language-plaintext highlighter-rouge">leaseTime</code> ì´ë‚´ë¡œ ì‘ì—…ì´ ëë‚´ëŠ” ê²ƒì„ ë³´ì¥í•´ì•¼ ë™ì‹œì„± ì´ìŠˆê°€ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
  <li>ì‘ì—…ì„ ë§ˆì¹œ ìŠ¤ë ˆë“œëŠ” <code class="language-plaintext highlighter-rouge">unlock</code>ì„ í†µí•´ ë½ì„ í•´ì œí•˜ê²Œ ë©ë‹ˆë‹¤.</li>
</ul>

<h1 id="ë¶„ì‚°-ë½-í™œìš©-ì˜ˆì œ-ì½”ë“œ-ì¬ê³ -ì°¨ê°">ë¶„ì‚° ë½ í™œìš© ì˜ˆì œ ì½”ë“œ (ì¬ê³  ì°¨ê°)</h1>

<p>ìƒí’ˆì˜ ì¬ê³  ìˆ˜ëŸ‰ì„ ë³€ê²½ì‹œí‚¤ëŠ” ì‘ì—…ì€ ë™ì‹œì„± ì´ìŠˆê°€ ë°œìƒí•˜ëŠ” ëŒ€í‘œì ì¸ ì˜ˆì‹œë¡œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ìƒí’ˆ ì¬ê³ ì˜ ìˆ˜ëŸ‰ì„ ë³€ê²½í•˜ê¸° ìœ„í•´ ë™ì‹œì— ì ‘ê·¼í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</p>

<p>ì•ì„œ ì‚´í´ë³¸ Redissonì„ í™œìš©í•œ ë¶„ì‚° ë½ì„ ì¬ê³  ìˆ˜ëŸ‰ì„ ë³€ê²½í•˜ëŠ” ë¡œì§ ì „í›„ë¡œ ë½ì„ íšë“/í•´ì œë¥¼ í•œë‹¤ë©´ ë™ì‹œì„± ì´ìŠˆë¥¼ ì˜ˆë°©í•  ìˆ˜ ìˆì„ ê²ë‹ˆë‹¤.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Transactional</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">Product</span> <span class="nf">decreaseStock</span><span class="o">(</span><span class="nc">String</span> <span class="n">productId</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">quantity</span><span class="o">)</span> <span class="o">{</span>

    <span class="kt">long</span> <span class="n">leaseTime</span> <span class="o">=</span> <span class="mi">5</span><span class="o">;</span>
    <span class="kt">long</span> <span class="n">waitTime</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>
    <span class="nc">String</span> <span class="n">lockKey</span> <span class="o">=</span> <span class="s">"lock:product:stock:"</span> <span class="o">+</span> <span class="n">productId</span><span class="o">;</span>

    <span class="k">try</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">redissonLockService</span><span class="o">.</span><span class="na">tryLock</span><span class="o">(</span><span class="n">lockKey</span><span class="o">,</span> <span class="n">waitTime</span><span class="o">,</span> <span class="n">leaseTime</span><span class="o">))</span> <span class="o">{</span> <span class="c1">// ë½ íšë“ ì‹œë„</span>
        <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">&gt;</span> <span class="n">findProduct</span> <span class="o">=</span> <span class="n">productRepository</span><span class="o">.</span><span class="na">findByProductId</span><span class="o">(</span><span class="n">productId</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">findProduct</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Product not found"</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nc">Product</span> <span class="n">product</span> <span class="o">=</span> <span class="n">findProduct</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="n">product</span><span class="o">.</span><span class="na">decreaseStock</span><span class="o">(</span><span class="n">quantity</span><span class="o">);</span> <span class="c1">// ì¬ê³  ì°¨ê°</span>
        <span class="k">return</span> <span class="n">product</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="n">redissonLockService</span><span class="o">.</span><span class="na">unlock</span><span class="o">(</span><span class="n">lockKey</span><span class="o">);</span> <span class="c1">// ë½ í•´ì œ </span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>ìƒí’ˆ ê³ ìœ  ì‹ë³„ì(productId)ë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒí’ˆ ë³„ë¡œ ë¶„ì‚° ë½ì„ ì œì–´í•  ìˆ˜ ìˆë„ë¡ í–ˆìŠµë‹ˆë‹¤.</li>
  <li>ë½ì„ íšë“í•œ ê²½ìš°ì—ë§Œ ì¬ê³  ìˆ˜ëŸ‰ì„ ì°¨ê°ì‹œí‚¬ ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.</li>
  <li>ë½ íšë“ì— ì‹¤íŒ¨í•˜ê²Œ ë˜ë©´ ì˜ˆì™¸ê°€ ë°œìƒí•˜ì—¬, ì¬ê³  ìˆ˜ëŸ‰ ì°¨ê° ë¡œì§ì€ ìˆ˜í–‰í•˜ì§€ ëª» í•˜ê²Œ ë©ë‹ˆë‹¤.</li>
  <li>ë½ íšë“ í›„ ì‘ì—…ì„ ì™„ë£Œí–ˆë‹¤ë©´ ë½ì„ í•´ì œí•´ì¤ë‹ˆë‹¤.</li>
</ul>

<h1 id="ë¶„ì‚°-ë½-ì ìš©-ë¶€ë¶„ì˜-aop-ë¶„ë¦¬">ë¶„ì‚° ë½ ì ìš© ë¶€ë¶„ì˜ AOP ë¶„ë¦¬</h1>

<p>ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ë¶„ì‚° ë½ê³¼ ê°™ì€ íš¡<strong>ë‹¨ ê´€ì‹¬ì‚¬(cross-cutting concern)</strong>ëŠ” ì—¬ëŸ¬ ì„œë¹„ìŠ¤ ë©”ì„œë“œì—ì„œ ë°˜ë³µì ìœ¼ë¡œ êµ¬í˜„ë˜ê¸° ë•Œë¬¸ì—, ì´ë¥¼ ê°œë³„ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ê³¼ ë¶„ë¦¬í•˜ë©´ ì½”ë“œì˜ ê°€ë…ì„± ë° ìœ ì§€ë³´ìˆ˜ì„±ì´ í¬ê²Œ í–¥ìƒë©ë‹ˆë‹¤. <strong>ìŠ¤í”„ë§ AOP</strong>ë¥¼ í™œìš©í•˜ë©´ ë©”ì„œë“œ í˜¸ì¶œ ì „í›„ì— ìë™ìœ¼ë¡œ ë½ì„ íšë“í•˜ê³  í•´ì œí•˜ëŠ” ë¡œì§ì„ ì‚½ì…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<blockquote>
  <p>ì•„ë˜ ë‚´ìš©ì€ AOPì— ëŒ€í•œ ì´í•´ê°€ í•„ìš”í•©ë‹ˆë‹¤!</p>
</blockquote>

<h2 id="aop-ì ìš©-ë°©ë²•">AOP ì ìš© ë°©ë²•</h2>

<p>ìŠ¤í”„ë§ AOPë¥¼ ì ìš©í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ ë‹¨ê³„ë³„ë¡œ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.</p>

<h3 id="ì–´ë…¸í…Œì´ì…˜-ì •ì˜">ì–´ë…¸í…Œì´ì…˜ ì •ì˜</h3>

<p>ë½ì´ í•„ìš”í•œ ë©”ì„œë“œì— ì ìš©í•  ì»¤ìŠ¤í…€ ì–´ë…¸í…Œì´ì…˜(<code class="language-plaintext highlighter-rouge">@StockLock</code>)ì„ ì •ì˜í•©ë‹ˆë‹¤.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Target</span><span class="o">(</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">)</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">StockLock</span> <span class="o">{</span>
    <span class="kt">long</span> <span class="nf">waitTime</span><span class="o">()</span> <span class="k">default</span> <span class="mi">5</span><span class="o">;</span>
    <span class="kt">long</span> <span class="nf">leaseTime</span><span class="o">()</span> <span class="k">default</span> <span class="mi">10</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="aspect-í´ë˜ìŠ¤-ì‘ì„±">Aspect í´ë˜ìŠ¤ ì‘ì„±</h3>

<p><code class="language-plaintext highlighter-rouge">@Around</code> ì–´ë“œë°”ì´ìŠ¤ë¥¼ í™œìš©í•˜ì—¬ ì–´ë…¸í…Œì´ì…˜ì´ ë¶™ì€ ë©”ì„œë“œì˜ <strong>ì‹¤í–‰ ì „í›„ì— ë¶„ì‚° ë½ íšë“ ë° í•´ì œ ë¡œì§ì„ ì‚½ì…</strong>í•©ë‹ˆë‹¤.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Aspect</span>
<span class="nd">@Slf4j</span>
<span class="nd">@Component</span>
<span class="nd">@Order</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="c1">// AOP ìš°ì„ ìˆœìœ„ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">StockAspect</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">RedissonLockService</span> <span class="n">redissonLockService</span><span class="o">;</span>

    <span class="nd">@Around</span><span class="o">(</span><span class="s">"@annotation(stockLock) &amp;&amp; args(productId,..)"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">doLock</span><span class="o">(</span><span class="nc">ProceedingJoinPoint</span> <span class="n">joinPoint</span><span class="o">,</span> <span class="nc">StockLock</span> <span class="n">stockLock</span><span class="o">,</span> <span class="nc">String</span> <span class="n">productId</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"StockLockAspect.doLock {}"</span><span class="o">,</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">getSignature</span><span class="o">());</span>

        <span class="kt">long</span> <span class="n">leaseTime</span> <span class="o">=</span> <span class="n">stockLock</span><span class="o">.</span><span class="na">leaseTime</span><span class="o">();</span>
        <span class="kt">long</span> <span class="n">waitTime</span> <span class="o">=</span> <span class="n">stockLock</span><span class="o">.</span><span class="na">waitTime</span><span class="o">();</span>
        <span class="nc">String</span> <span class="n">lockKey</span> <span class="o">=</span> <span class="s">"lock:product:stock:"</span> <span class="o">+</span> <span class="n">productId</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">redissonLockService</span><span class="o">.</span><span class="na">tryLock</span><span class="o">(</span><span class="n">lockKey</span><span class="o">,</span> <span class="n">waitTime</span><span class="o">,</span> <span class="n">leaseTime</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">redissonLockService</span><span class="o">.</span><span class="na">unlock</span><span class="o">(</span><span class="n">lockKey</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"ë½ì„ íšë“í•˜ì§€ ëª»í•˜ì—¬ ì¢…ë£Œí•©ë‹ˆë‹¤. productId={}"</span><span class="o">,</span> <span class="n">productId</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p>ğŸš¨ AOP ìš°ì„  ìˆœìœ„ ì§€ì •</p>

  <p>ìŠ¤í”„ë§ì˜ íŠ¸ëœì­ì…˜ ì²˜ë¦¬ë„ AOPë¥¼ í™œìš©í•©ë‹ˆë‹¤. ì´ë•Œ ë¶„ì‚° ë½ì˜ AOPì™€ íŠ¸ëœì­ì…˜ì˜ AOPì˜ ìˆœì„œê°€ êµ‰ì¥íˆ ì¤‘ìš”í•©ë‹ˆë‹¤. ë§Œì•½ íŠ¸ëœì­ì…˜ AOPê°€ ë¨¼ì € ì‹¤í–‰ëœë‹¤ë©´, ì—¬ì „íˆ ë™ì‹œì„± ì´ìŠˆê°€ ë°œìƒí•  ê°€ëŠ¥ì„±ì´ ì¡´ì¬í•˜ê²Œ ë©ë‹ˆë‹¤. ë”°ë¼ì„œ ë¶„ì‚° ë½ AOPë¥¼ ë¨¼ì € ì ìš©í•˜ê¸° ìœ„í•´ @Orderë¥¼ í†µí•´ ìˆœì„œë¥¼ ì§€ì •í•´ì¤ë‹ˆë‹¤. ì˜ˆì œ ì½”ë“œì—ì„œëŠ” Integer.MAX_VALUE - 1 ê°’ì„ ì§€ì •í•´ì£¼ì—ˆëŠ”ë°, ì´ëŠ” íŠ¸ëœì­ì…˜ì˜ ìš°ì„ ìˆœìœ„ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì œì¼ í›„ìˆœìœ„(INTEGER.MAX_VALUE)ì´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</p>
</blockquote>

<h3 id="ë¹„ì¦ˆë‹ˆìŠ¤-ë¡œì§ê³¼-ë¶„ë¦¬">ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ê³¼ ë¶„ë¦¬</h3>

<p>ì‹¤ì œ ì„œë¹„ìŠ¤ ë©”ì„œë“œëŠ” ë½ ê´€ë ¨ ì½”ë“œë¥¼ í¬í•¨í•˜ì§€ ì•Šê³ , AOPê°€ ì´ë¥¼ ëŒ€ì‹  ì²˜ë¦¬í•˜ê²Œ ë©ë‹ˆë‹¤.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@Transactional</span>
    <span class="nd">@Override</span>
    <span class="nd">@StockLock</span>
    <span class="kd">public</span> <span class="nc">Product</span> <span class="nf">decreaseStock</span><span class="o">(</span><span class="nc">String</span> <span class="n">productId</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">quantity</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"product-service: ì¬ê³  ì°¨ê°"</span><span class="o">);</span>
        <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">&gt;</span> <span class="n">findProduct</span> <span class="o">=</span> <span class="n">productRepository</span><span class="o">.</span><span class="na">findByProductId</span><span class="o">(</span><span class="n">productId</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">findProduct</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Product not found"</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nc">Product</span> <span class="n">product</span> <span class="o">=</span> <span class="n">findProduct</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="n">product</span><span class="o">.</span><span class="na">decreaseStock</span><span class="o">(</span><span class="n">quantity</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">product</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div></div>

<h2 id="aop-ì ìš©ì˜-ì¥ì ">AOP ì ìš©ì˜ ì¥ì </h2>

<p>ë½ íšë“ ë° í•´ì œ ë¡œì§ì„ í•œ ê³³ì—ì„œ ê´€ë¦¬í•˜ì—¬ ì—¬ëŸ¬ ì„œë¹„ìŠ¤ ë©”ì„œë“œì— <strong>ì¤‘ë³µëœ ì½”ë“œë¥¼ ì œê±°</strong>í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë§Œì•½ ë½ ì²˜ë¦¬ ë¡œì§ì„ ë³€ê²½í•  ê²½ìš°, Aspect í´ë˜ìŠ¤ë§Œ ìˆ˜ì •í•˜ë©´ ë˜ë¯€ë¡œ <strong>ê´€ë¦¬ê°€ ìš©ì´</strong>í•©ë‹ˆë‹¤. ê·¸ë¦¬ê³  ì„œë¹„ìŠ¤ ë©”ì„œë“œì—ì„œëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì—ë§Œ ì§‘ì¤‘í•  ìˆ˜ ìˆì–´ ì½”ë“œì˜ <strong>ê°€ë…ì„±</strong>ì´ ì¢‹ì•„ì§‘ë‹ˆë‹¤.</p>

<h1 id="ê²°ë¡ ">ê²°ë¡ </h1>

<p><strong>ë¶„ì‚° ì‹œìŠ¤í…œ</strong>ì—ì„œ ë™ì‹œì„± ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•œ <strong>ë¶„ì‚° ë½ì€ í•„ìˆ˜</strong>ì ì¸ ìš”ì†Œì…ë‹ˆë‹¤. Redisì˜ Redissonì„ í™œìš©í•˜ë©´ ë†’ì€ ì„±ëŠ¥ê³¼ í¸ë¦¬í•œ ë¶„ì‚° ë½ êµ¬í˜„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. ë˜í•œ AOPë¥¼ ì ìš©í•¨ìœ¼ë¡œì¨ ë½ ê´€ë ¨ ë¡œì§ì„ ë¶„ë¦¬í•˜ë©´ ì½”ë“œì˜ ìœ ì§€ë³´ìˆ˜ì„±ê³¼ ê°€ë…ì„±ì´ í¬ê²Œ í–¥ìƒë©ë‹ˆë‹¤. ë³¸ í¬ìŠ¤íŠ¸ë¥¼ ì°¸ê³ í•˜ì—¬ ë¶„ì‚° ë½ì„ ì‹¤ì œ êµ¬í˜„í•˜ëŠ” ë° ë„ì›€ì´ ë˜ë©´ ì¢‹ê² ìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤.</p>

<h1 id="ì°¸ê³ -ìë£Œ">ì°¸ê³  ìë£Œ</h1>

<ul>
  <li><a href="https://www.inflearn.com/course/%EB%8F%99%EC%8B%9C%EC%84%B1%EC%9D%B4%EC%8A%88-%EC%9E%AC%EA%B3%A0%EC%8B%9C%EC%8A%A4%ED%85%9C">ì¸í”„ëŸ° - ì¬ê³ ì‹œìŠ¤í…œìœ¼ë¡œ ì•Œì•„ë³´ëŠ” ë™ì‹œì„±ì´ìŠˆ í•´ê²°ë°©ë²•</a></li>
  <li><a href="https://www.youtube.com/watch?v=4wGTavSyLxE">ì¹´ì¹´ì˜¤í˜ì´ëŠ” ì–´ë–»ê²Œ ìˆ˜ì²œë§Œ ê²°ì œë¥¼ ì²˜ë¦¬í• ê¹Œ? ìš°ì•„í•œ ê²°ì œ ë¶„ì‚°ë½ ë…¸í•˜ìš° / if(kakaoAI)2024</a></li>
  <li><a href="https://helloworld.kurly.com/blog/distributed-redisson-lock/#2-%EC%A4%91%EB%B3%B5-%EB%B0%9C%EC%A3%BC-%EB%8D%B0%EC%9D%B4%ED%84%B0-%EB%8F%99%EC%8B%9C-%EC%88%98%EC%8B%A0">í’€í•„ë¨¼íŠ¸ ì…ê³  ì„œë¹„ìŠ¤íŒ€ì—ì„œ ë¶„ì‚°ë½ì„ ì‚¬ìš©í•˜ëŠ” ë°©ë²• - ë§ˆì¼“ ì»¬ë¦¬</a></li>
</ul>

<hr />]]></content><author><name>Bang Seung IL</name></author><category term="MSA" /><category term="Redis" /><category term="AOP" /><category term="Distributed Lock" /><category term="Redisson" /><summary type="html"><![CDATA[ë¶„ì‚° ì‹œìŠ¤í…œì—ì„œ Redisë¥¼ ì´ìš©í•œ ë¶„ì‚° ë½ì˜ í•„ìš”ì„±ê³¼ ë¶„ì‚° ë½ ì ìš© ë¶€ë¶„ì˜ AOP í™œìš© ë°©ë²•ì„ ì•Œì•„ë´…ì‹œë‹¤.]]></summary></entry><entry><title type="html">MSAì—ì„œ ë°ì´í„° ì¼ê´€ì„± ìœ ì§€ë¥¼ ìœ„í•œ Saga íŒ¨í„´</title><link href="http://localhost:4000/spring%20cloud/msa/2025/02/22/MSA-SAGA-Pattern/" rel="alternate" type="text/html" title="MSAì—ì„œ ë°ì´í„° ì¼ê´€ì„± ìœ ì§€ë¥¼ ìœ„í•œ Saga íŒ¨í„´" /><published>2025-02-22T00:00:00+09:00</published><updated>2025-02-22T00:00:00+09:00</updated><id>http://localhost:4000/spring%20cloud/msa/2025/02/22/MSA-SAGA-Pattern</id><content type="html" xml:base="http://localhost:4000/spring%20cloud/msa/2025/02/22/MSA-SAGA-Pattern/"><![CDATA[<blockquote>
  <p>Saga íŒ¨í„´ì´ ë¬´ì—‡ì´ê³ , MSA í™˜ê²¨ì—ì„œ ì™œ í•„ìš”í•œì§€ ì•Œì•„ë´…ì‹œë‹¤!</p>
</blockquote>

<!-- more -->

<h1 id="-ë“¤ì–´ê°€ê¸°">ğŸ“Œ ë“¤ì–´ê°€ê¸°</h1>

<p><strong>ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜</strong>ì—ì„œëŠ” ê° ì„œë¹„ìŠ¤ê°€ ë…ë¦½ì ì¸ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ê°€ì§€ê³  ìˆìœ¼ë©°, ì„œë¹„ìŠ¤ ê°„ í†µì‹ ì„ í†µí•´ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ì—°ê²°ë˜ëŠ” ê²½ìš°ê°€ ë§ìŠµë‹ˆë‹¤.</p>

<p>ì´ë•Œ, ë°ì´í„° ì¼ê´€ì„±ì„ ìœ ì§€í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•œë°, ì „í†µì ì¸ <strong>ë¶„ì‚° íŠ¸ëœì­ì…˜</strong> ë°©ì‹ìœ¼ë¡œëŠ” í•œê³„ê°€ ìˆìŠµë‹ˆë‹¤.</p>

<p>ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” <strong>Saga íŒ¨í„´</strong>ì˜ í•„ìš”ì„±ê³¼ ì´ë¥¼ ë„ì…í•˜ì§€ ì•Šì„ ê²½ìš° ë°œìƒí•  ìˆ˜ ìˆëŠ” ë¬¸ì œì ì— ëŒ€í•´ ì‚´í´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.</p>

<h1 id="1-ì „í†µì ì¸-ë¶„ì‚°-íŠ¸ëœì­ì…˜">1. ì „í†µì ì¸ ë¶„ì‚° íŠ¸ëœì­ì…˜</h1>

<p>MSA í™˜ê²½ì—ì„œ ê° ì„œë¹„ìŠ¤ëŠ” ë…ë¦½ì ì¸ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ê°€ì§€ê³  ìˆê¸° ë•Œë¬¸ì— ë°ì´í„° ì •í•©ì„±ì„ ìœ ì§€í•˜ê¸°ê°€ í›¨ì”¬ ì–´ë ¤ì›Œì§‘ë‹ˆë‹¤.</p>

<p>ì „í†µì ì¸ ë¶„ì‚° íŠ¸ëœì­ì…˜ì€ ë°ì´í„° ì •í•©ì„± ë¶ˆì¼ì¹˜ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•œ <strong>ì´ˆê¸° ì ‘ê·¼ ë°©ì‹</strong>ìœ¼ë¡œ, <strong>ì—¬ëŸ¬ ë°ì´í„°ë² ì´ìŠ¤ì— ê±¸ì³ ì›ìì„±(Atomicity)ì„ ë³´ì¥í•˜ë ¤ëŠ” ë°©ì‹</strong>ì´ì—ˆìŠµë‹ˆë‹¤.</p>

<p>ê·¸ëŸ¬ë‚˜ ì´ ë°©ì‹ì€ <strong>í•œê³„ì ê³¼ ë¬¸ì œì ì„ ë™ë°˜</strong>í•˜ê²Œ ë˜ë©°, ê²°ê³¼ì ìœ¼ë¡œ <strong>Saga íŒ¨í„´</strong>ê³¼ ê°™ì€ ëŒ€ì•ˆì´ ë“±ì¥í•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.</p>

<h2 id="ì „í†µì ì¸-ë¶„ì‚°-íŠ¸ëœì­ì…˜-í•µì‹¬-2-phase-commit2pc">ì „í†µì ì¸ ë¶„ì‚° íŠ¸ëœì­ì…˜ í•µì‹¬: 2-Phase Commit(2PC)</h2>

<p>MSA <strong>ë‹¤ì¤‘ ë°ì´í„°ë² ì´ìŠ¤ í™˜ê²½</strong>ì—ì„œ í•˜ë‚˜ì˜ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ìˆ˜í–‰ë  ë•Œ, ì—¬ëŸ¬ ë°ì´í„°ë² ì´ìŠ¤ì— ê±¸ì³ ê´€ë ¨ ë°ì´í„°ë“¤ì´ ì €ì¥ë©ë‹ˆë‹¤. <strong>ì „í†µì ì¸ ë¶„ì‚° íŠ¸ëœì­ì…˜</strong>ì—ì„œ ê°€ì¥ ë„ë¦¬ ì‚¬ìš©ëœ í”„ë¡œí† ì½œë¡œ <code class="language-plaintext highlighter-rouge">2-Phase Commit(2PC)</code>ê°€ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” <code class="language-plaintext highlighter-rouge">íŠ¸ëœì­ì…˜ ê´€ë¦¬ì(Transaction Coordinator)</code>ê°€ ì¡´ì¬í•˜ì—¬ ì „ì²´ íŠ¸ëœì­ì…˜ì„ ì¡°ìœ¨í•˜ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.</p>

<h2 id="ì „í†µì ì¸-ë¶„ì‚°-íŠ¸ëœì­ì…˜-í•œê³„ì ">ì „í†µì ì¸ ë¶„ì‚° íŠ¸ëœì­ì…˜ í•œê³„ì </h2>

<p>ì „í†µì ì¸ ë¶„ì‚° íŠ¸ëœì­ì…˜ í•œê³„ì ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>

<ul>
  <li>ë½í‚¹(Locking)ìœ¼ë¡œ ì¸í•œ ì„±ëŠ¥ ì €í•˜, ë³‘ëª© ì§€ì ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>íŠ¸ëœì­ì…˜ì€ ê´€ë¦¬í•˜ëŠ” ì½”ë””ë„¤ì´í„°ê°€ <strong>ë‹¨ì¼ ì‹¤íŒ¨ ì§€ì </strong>ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ë„¤íŠ¸ì›Œí¬ ë¬¸ì œë¡œ ì¸í•´ íŠ¸ëœì­ì…˜ ê´€ë¦¬ìì˜ ì§€ì‹œë¥¼ ë°›ì§€ ëª»í•˜ë©´, êµì°© ìƒíƒœ(Deadlock)ì— ë¹ ì§ˆ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ê´€ë¦¬í•˜ëŠ” ë…¸ë“œê°€ ë§ì•„ì§ˆìˆ˜ë¡ íŠ¸ëœì­ì…˜ì„ ì¡°ìœ¨í•˜ê¸° ë³µì¡í•´ì§‘ë‹ˆë‹¤. ì´ë¡œ ì¸í•´ ì‹œìŠ¤í…œì˜ í™•ì¥ì„±ì´ ì €í•˜ë©ë‹ˆë‹¤.</li>
</ul>

<p>ğŸ’¡ ìœ„ì™€ ê°™ì€ í•œê³„ì ë“¤ë¡œ ì¸í•´ ì „í†µì ì¸ 2PC ë°©ì‹ì€ ë‹¨ì¼ ì‹œìŠ¤í…œì´ë‚˜ ì ì€ ìˆ˜ì˜ ì„œë¹„ìŠ¤ì— ì í•©í•˜ì§€ë§Œ, <strong>í™•ì¥ì„±, ê³ ê°€ìš©ì„±, ë¹„ë™ê¸°ì„±ì´ ì¤‘ìš”í•œ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ í™˜ê²½ì—ëŠ” ì í•©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</strong></p>

<p>â—ï¸ ì°¸ê³ ë¡œ, ì´ë²ˆ í¬ìŠ¤íŠ¸ì˜ ì£¼ì œëŠ” ì „í†µì ì¸ ë¶„ì‚° íŠ¸ëœì­ì…˜ì˜ í•œê³„ì ìœ¼ë¡œ ì¸í•œ Saga íŒ¨í„´ ë„ì…ì˜ í•„ìš”ì„±ì„ ë‹¤ë£¨ëŠ” í¬ìŠ¤íŠ¸ì…ë‹ˆë‹¤. ë”°ë¼ì„œ ì „í†µì ì¸ ë¶„ì‚° íŠ¸ëœì­ì…˜ì— ëŒ€í•œ ë‚´ìš©ì€ ì¶”í›„ ë‹¤ë¥¸ í¬ìŠ¤íŠ¸ì—ì„œ ìì„¸íˆ ë‹¤ë£¨ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.</p>

<h1 id="2-ì „í†µì ì¸-ë¶„ì‚°-íŠ¸ëœì­ì…˜ì˜-ëŒ€ì•ˆ">2. ì „í†µì ì¸ ë¶„ì‚° íŠ¸ëœì­ì…˜ì˜ ëŒ€ì•ˆ</h1>

<p>ì „í†µì ì¸ ë¶„ì‚° íŠ¸ëœì­ì…˜ì˜ ëŒ€ì•ˆìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">Saga íŒ¨í„´</code>ê³¼ <code class="language-plaintext highlighter-rouge">Outbox íŒ¨í„´</code>ì´ ìˆìŠµë‹ˆë‹¤.</p>

<p>ë‘ íŒ¨í„´ ì¤‘ ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” Spring Cloud ì‚¬ì´ë“œ í”„ë¡œì íŠ¸ë¥¼ ì§„í–‰í•˜ë©´ì„œ Saga íŒ¨í„´ì„ ì ìš©í•œ ë‚´ìš©ì„ ë‹¤ë£¨ê² ìŠµë‹ˆë‹¤.</p>

<h1 id="3-saga-íŒ¨í„´ì´ë€">3. Saga íŒ¨í„´ì´ë€?</h1>

<p>Saga íŒ¨í„´ì€ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ê°„ <strong>ë¶„ì‚° íŠ¸ëœì­ì…˜ì„ ê´€ë¦¬í•˜ê¸° ìœ„í•œ íŒ¨í„´</strong>ì…ë‹ˆë‹¤.</p>

<p>ê° ì„œë¹„ìŠ¤ì˜ ë¡œì»¬ íŠ¸ëœì­ì…©ì„ í†µí•´ì„œ ì „ì²´ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì˜ ì¼ê´€ì„±ì„ ìœ ì§€í•˜ëŠ” ë°©ë²•ì´ì£ .</p>

<p><strong>Saga íŒ¨í„´</strong>ì˜ í•µì‹¬ ì•„ì´ë””ì–´ëŠ” í•˜<strong>ë‚˜ì˜ í° íŠ¸ëœì­ì…˜ì„ ì—¬ëŸ¬ ê°œì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë‚˜ëˆ„ê³ </strong>, ë¬¸ì œê°€ ë°œìƒí•˜ë©´ <strong>ë³´ìƒ íŠ¸ëœì­ì…˜(Compensating Transaction)</strong>ì„ ìˆ˜í–‰í•˜ì—¬ ì¼ê´€ì„±ì„ ë§ì¶”ëŠ” ê²ƒì…ë‹ˆë‹¤.</p>

<h2 id="3-1-saga-íŒ¨í„´-ì˜ˆì‹œ">3-1. Saga íŒ¨í„´ ì˜ˆì‹œ</h2>

<p>Saga íŒ¨í„´ì´ ë¬´ì—‡ì¸ì§€ ì´í•´í•˜ê¸° ì‰½ë„ë¡ ì˜ˆì‹œë¥¼ ë“¤ì–´ë³´ê² ìŠµë‹ˆë‹¤.</p>

<p>ì˜ˆë¥¼ ë“¤ì–´, <code class="language-plaintext highlighter-rouge">Order Service -&gt; Payment Service -&gt; Product Service</code> ì˜ ìˆœì„œë¡œ ì£¼ë¬¸ê³¼ ê²°ì œ ê·¸ë¦¬ê³  ì¬ê³  ì°¨ê°ì´ ì´ë¤„ì§€ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ìˆë‹¤ê³  í•˜ê² ìŠµë‹ˆë‹¤.</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">Order Service</code>: ì£¼ë¬¸ ìƒì„± -&gt; <code class="language-plaintext highlighter-rouge">ORDER_CREATED</code> ì´ë²¤íŠ¸ ë°œí–‰.</li>
  <li><code class="language-plaintext highlighter-rouge">Payment Service</code>: ê²°ì œ ìš”ì²­ -&gt; ê²°ì œ ì„±ê³µ ì‹œ <code class="language-plaintext highlighter-rouge">PAYMENT_COMPLETED</code> ì´ë²¤íŠ¸ ë°œí–‰.</li>
  <li><code class="language-plaintext highlighter-rouge">Product Service</code>: ì¬ê³  ì°¨ê° -&gt; ë§Œì•½ ì¬ê³  ë¶€ì¡± ì‹œ, <strong>ì‹¤íŒ¨ ì´ë²¤íŠ¸</strong> ë°œí–‰.</li>
</ol>

<p>ğŸ¯ ë§Œì•½ <code class="language-plaintext highlighter-rouge">Product Service</code>ì—ì„œ ì¬ê³  ë¶€ì¡±ìœ¼ë¡œ ì¸í•´ ì‹¤íŒ¨ ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ë©´, ë³´ìƒ íŠ¸ëœì­ì…˜ìœ¼ë¡œ <strong>ì£¼ë¬¸ ì·¨ì†Œ ë° ê²°ì œ ì·¨ì†Œ</strong>ë¥¼ ì§„í–‰í•´ì£¼ê²Œ ë©ë‹ˆë‹¤. ì´ì²˜ëŸ¼ ì‹¤íŒ¨ì— ëŒ€í•œ ë³´ìƒ ì²˜ë¦¬ë¥¼ í•´ì£¼ëŠ” ê²ƒì´ Saga íŒ¨í„´ì…ë‹ˆë‹¤.</p>

<h1 id="4-saga-íŒ¨í„´ì˜-ì¢…ë¥˜">4. Saga íŒ¨í„´ì˜ ì¢…ë¥˜</h1>

<p>Saga íŒ¨í„´ì—ëŠ” ì¢…ë¥˜ê°€ ì¡´ì¬í•©ë‹ˆë‹¤. í¬ê²Œ Choreography(ì½”ë ˆì˜¤ê·¸ë˜í”¼) ë°©ì‹ê³¼ Orchestration(ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜) ë°©ì‹ìœ¼ë¡œ ë‚˜ë‰˜ê²Œ ë©ë‹ˆë‹¤.</p>

<p>ê° ë°©ì‹ì—ëŠ” ì¥ë‹¨ì ì´ ì¡´ì¬í•˜ë©°, í”„ë¡œì íŠ¸ í™˜ê²½ì— ë”°ë¼ ì ì ˆí•œ íŒ¨í„´ì„ ì ìš©í•˜ë©´ ë  ê²ƒ ê°™ìŠµë‹ˆë‹¤.</p>

<p>ê·¸ëŸ¼, ê° íŒ¨í„´ ì¢…ë¥˜ì˜ ì¥ë‹¨ì ì„ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.</p>

<h2 id="4-1-saga-pattern---choreographyì½”ë ˆì˜¤ê·¸ë˜í”¼">4-1. Saga pattern - Choreography(ì½”ë ˆì˜¤ê·¸ë˜í”¼)</h2>

<p><strong>ì´ë²¤íŠ¸ ê¸°ë°˜</strong>ìœ¼ë¡œ <strong>ê° ì„œë¹„ìŠ¤ê°€ ì§ì ‘ ì´ë²¤íŠ¸ë¥¼ êµ¬ë…í•˜ê³  ë‹¤ìŒ ì‘ì—…ì„ ìˆ˜í–‰</strong>í•˜ëŠ” íŒ¨í„´ì…ë‹ˆë‹¤. ì´ëŠ” <strong>ì¤‘ì•™ ì¡°ì •ìê°€ ì—†ë‹¤</strong>ëŠ” ê²ƒì´ íŠ¹ì§•ì…ë‹ˆë‹¤.</p>

<ul>
  <li><strong>ì¥ì </strong>: ë‹¨ìˆœí•œ êµ¬í˜„, ë‚®ì€ ë³µì¡ì„±</li>
  <li><strong>ë‹¨ì </strong>: ì„œë¹„ìŠ¤ ê°„ ì˜ì¡´ì„± ì¦ê°€, ë³µì¡í•œ ì´ë²¤íŠ¸ í”Œë¡œìš° ê´€ë¦¬ ì–´ë ¤ì›€</li>
</ul>

<p>ğŸ‘‰ <strong>ì˜ˆì‹œ</strong></p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">Order Service</code> -&gt; <code class="language-plaintext highlighter-rouge">ORDER_CREATED</code> ì£¼ë¬¸ ìƒì„± ì´ë²¤íŠ¸ ë°œí–‰</li>
  <li><code class="language-plaintext highlighter-rouge">Payment Service</code> ê°€ ì£¼ë¬¸ ìƒì„± êµ¬ë… í›„ ê²°ì œ ì²˜ë¦¬ -&gt; <code class="language-plaintext highlighter-rouge">PAYMENT_COMPLETED</code> ê²°ì œ ì„±ê³µ ì´ë²¤íŠ¸ ë°œí–‰</li>
  <li><code class="language-plaintext highlighter-rouge">Delivery Service</code>ê°€ ê²°ì œ ì„±ê³µ êµ¬ë… í›„ ë°°ì†¡ ìš”ì²­ ì²˜ë¦¬.</li>
</ol>

<h2 id="4-2-saga-pattern---orchestrationì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜">4-2. Saga Pattern - Orchestration(ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜)</h2>

<p><strong>ì¤‘ì•™ ì¡°ì •ì(Service Orchestration)</strong>ê°€ ê° ì„œë¹„ìŠ¤ì— ìš”ì²­ì„ ë³´ë‚´ê³  <strong>ì „ì²´ íŠ¸ëœì­ì…˜ì„ ê´€ë¦¬ ë° ì¡°ìœ¨</strong>í•˜ëŠ” íŒ¨í„´ì…ë‹ˆë‹¤.</p>

<ul>
  <li><strong>ì¥ì </strong>: ì„œë¹„ìŠ¤ ê°„ ì˜ì¡´ì„± ê°ì†Œ, ì¤‘ì•™ ì§‘ì¤‘ì‹ìœ¼ë¡œ ì „ì²´ í”Œë¡œìš° ê´€ë¦¬ ê°€ëŠ¥.</li>
  <li><strong>ë‹¨ì </strong>: Orchestrator(ì¤‘ì•™ ì¡°ì •ì)ë¥¼ ì¶”ê°€ êµ¬í˜„í•´ì•¼ í•˜ë©°, ë‹¨ì¼ ì‹¤íŒ¨ ì§€ì (SPOF)ì´ ë  ìˆ˜ ìˆìŒ.</li>
</ul>

<p>ğŸ‘‰ <strong>ì˜ˆì‹œ</strong></p>

<ol>
  <li><strong>Orchestrator</strong>ê°€ Order Service ì— ì£¼ë¬¸ ìƒì„± ìš”ì²­</li>
  <li>ì£¼ë¬¸ ìƒì„± -&gt; ê²°ì œ ìš”ì²­ -&gt; ì¬ê³  ì°¨ê° -&gt; ë°°ì†¡ ìš”ì²­ ìˆœìœ¼ë¡œ ì „ì²´ ì´ë²¤íŠ¸ ë°œí–‰ ë° íŠ¸ëœì­ì…˜ ê´€ë¦¬</li>
  <li>ì‹¤íŒ¨ ì‹œ ë³´ìƒ íŠ¸ëœì­ì…˜ì„ ì§ì ‘ í˜¸ì¶œ</li>
</ol>

<h2 id="-4-3-saga-pattern-ì¢…ë¥˜-ì •ë¦¬">âœ… 4-3 Saga Pattern ì¢…ë¥˜ ì •ë¦¬</h2>

<p>Saga íŒ¨í„´ì—ëŠ” Choreographyì™€ Orchestration ë‘ ë°©ì‹ì´ ì¡´ì¬í•©ë‹ˆë‹¤.</p>

<p>ë‘ ë°©ì‹ì€ ê°ê°ì˜ ì¥ë‹¨ì ì´ ìƒë°˜ë˜ë©°, í”„ë¡œì íŠ¸ í™˜ê²½ì— ì•Œë§ê²Œ ì ì ˆí•œ íŒ¨í„´ ì¢…ë¥˜ë¥¼ ì„ íƒí•˜ë©´ ë©ë‹ˆë‹¤.</p>

<p>ì°¸ê³ ë¡œ ì €ëŠ” ì‚¬ì´ë“œ í”„ë¡œì íŠ¸ë¥¼ ì§„í–‰í•  ë•Œ ë‹¨ìˆœí•œ êµ¬í˜„ê³¼ ë‚®ì€ ë³µì¡ì„±ìœ¼ë¡œ êµ¬ì„±ë˜ë„ë¡ ì›í–ˆê³ , ì¤‘ì•™ ì¡°ì •ì ë„ì…ì´ ì˜¤íˆë ¤ ì„œë¹„ìŠ¤ê°€ ë§ì•„ì§ˆ ìˆ˜ë¡ ì¤‘ì•™ ì¡°ì •ìë¥¼ ê´€ë¦¬í•˜ê¸° ì–´ë ¤ì›Œ ì§ˆ ê²ƒì´ë€ íŒë‹¨í•˜ì— <strong>Choreography(ì½”ë ˆì˜¤ê·¸ë˜í”¼)</strong> ë°©ì‹ì„ ì ìš©í•˜ì˜€ìŠµë‹ˆë‹¤.</p>

<h1 id="5-saga-íŒ¨í„´-ì ìš©-ì˜ˆì œ-ì½”ë“œ">5. Saga íŒ¨í„´ ì ìš© ì˜ˆì œ ì½”ë“œ</h1>

<p>ì‚¬ì´ë“œ í”„ë¡œì íŠ¸ì—ì„œ Saga íŒ¨í„´(Choreography)ì„ ì ìš©í•œ ì˜ˆì œ ì½”ë“œë¥¼ ë³´ì—¬ë“œë¦¬ê² ìŠµë‹ˆë‹¤.</p>

<p>ì°¸ê³ ë¡œ ì‹¤ì œ ì½”ë“œ ì „ë¶€ê°€ ì•„ë‹Œ Saga íŒ¨í„´ ì´í•´ë¥¼ ìœ„í•œ ê°„ì†Œí™”ëœ ì½”ë“œë¡œ ë³´ì—¬ë“œë¦¬ê² ìŠµë‹ˆë‹¤.</p>

<h2 id="order-service---order_created-ì´ë²¤íŠ¸-ë°œí–‰">Order Service - <code class="language-plaintext highlighter-rouge">ORDER_CREATED</code> ì´ë²¤íŠ¸ ë°œí–‰</h2>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Transactional</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">OrderDto</span> <span class="nf">createOrder</span><span class="o">(</span><span class="nc">OrderDto</span> <span class="n">orderDto</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Order-service: ì£¼ë¬¸ ìƒì„±"</span><span class="o">);</span>
    
    <span class="c1">// ì£¼ë¬¸ ìƒì„± ë¡œì§ ...</span>

    <span class="c1">// ORDER_CREATED ì´ë²¤íŠ¸ ë°œí–‰</span>
    <span class="nc">OrderCreatedEvent</span> <span class="n">orderCreatedEvent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">OrderCreatedEvent</span><span class="o">(</span>
            <span class="n">order</span><span class="o">.</span><span class="na">getOrderId</span><span class="o">(),</span>
            <span class="nc">BigDecimal</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">totalPrice</span><span class="o">),</span>
            <span class="n">orderDto</span><span class="o">.</span><span class="na">getPaymentInfos</span><span class="o">(),</span>
            <span class="n">orderDto</span><span class="o">.</span><span class="na">getDeliveryInfo</span><span class="o">());</span>
    <span class="n">orderEventProducer</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="no">ORDER_CREATED</span><span class="o">,</span> <span class="n">orderCreatedEvent</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="payment-service---order_created-ì´ë²¤íŠ¸-êµ¬ë…-í›„-ê²°ì œ-ì²˜ë¦¬">Payment Service - <code class="language-plaintext highlighter-rouge">ORDER_CREATED</code> ì´ë²¤íŠ¸ êµ¬ë… í›„ ê²°ì œ ì²˜ë¦¬</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@KafkaListener</span><span class="o">(</span><span class="n">topics</span> <span class="o">=</span> <span class="s">"ORDER_CREATED"</span><span class="o">,</span> <span class="n">groupId</span> <span class="o">=</span> <span class="s">"${spring.kafka.consumer.group-id:payment-service-group}"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">consume</span><span class="o">(</span><span class="nc">ConsumerRecord</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">record</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JsonProcessingException</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">message</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="na">value</span><span class="o">();</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Consumed message: {}"</span><span class="o">,</span> <span class="n">message</span><span class="o">);</span>
        <span class="nc">OrderCreatedEvent</span> <span class="n">orderCreatedEvent</span> <span class="o">=</span> <span class="n">objectMapper</span><span class="o">.</span><span class="na">readValue</span><span class="o">(</span><span class="n">message</span><span class="o">,</span> <span class="nc">OrderCreatedEvent</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Order created event: {}"</span><span class="o">,</span> <span class="n">orderCreatedEvent</span><span class="o">);</span>

        <span class="n">paymentHandler</span><span class="o">.</span><span class="na">handle</span><span class="o">(</span><span class="n">orderCreatedEvent</span><span class="o">);</span> <span class="c1">// ê²°ì œ ì²˜ë¦¬ </span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Error Consume OrderCreatedEvent"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ë§Œì•½, ê²°ì œ ì²˜ë¦¬ ì‹¤íŒ¨ ì‹œ ë³´ìƒ íŠ¸ëœì­ì…˜ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.</p>

<p><code class="language-plaintext highlighter-rouge">PAYMENT_FAILED</code> ì´ë²¤íŠ¸ ë°œí–‰ -&gt; <code class="language-plaintext highlighter-rouge">Order Service</code>ì—ì„œ ê²°ì œ ì‹¤íŒ¨ë¥¼ êµ¬ë…í•˜ì—¬ ì£¼ë¬¸ ì·¨ì†Œë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="nc">Event</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">handleEvent</span><span class="o">(</span><span class="n">event</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">handleException</span><span class="o">(</span><span class="n">event</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">handleException</span><span class="o">(</span><span class="nc">Event</span> <span class="n">event</span><span class="o">,</span> <span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Error handling payment"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">event</span> <span class="k">instanceof</span> <span class="nc">OrderCreatedEvent</span> <span class="n">orderCreatedEvent</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">paymentEventProducer</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="no">PAYMENT_FAILED</span><span class="o">,</span> <span class="k">new</span> <span class="nc">PaymentFailedEvent</span><span class="o">(</span>
                <span class="n">orderCreatedEvent</span><span class="o">.</span><span class="na">getOrderId</span><span class="o">(),</span>
                <span class="kc">null</span><span class="o">,</span>
                <span class="no">FAILED</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">()));</span>
    <span class="o">}</span>
    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<h1 id="6-saga-íŒ¨í„´-ë„ì…-ì‹œ-ì¥ì ">6. Saga íŒ¨í„´ ë„ì… ì‹œ ì¥ì </h1>

<p>ë¶„ì‚° íŠ¸ëœì­ì…˜ ì²˜ë¦¬ë¥¼ ìœ„í•´ Saga íŒ¨í„´ì„ ë„ì…í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ ì¥ì ì´ ìˆìŠµë‹ˆë‹¤.</p>

<h2 id="6-1-ë°ì´í„°-ì •í•©ì„±-ë³´ì¥">6-1. ë°ì´í„° ì •í•©ì„± ë³´ì¥</h2>

<p>ì„œë¹„ìŠ¤ ê°„ ë¹„ë™ê¸° ì²˜ë¦¬ì—ë„ Eventually Consistent(ìµœì¢… ì¼ê´€ì„±) ìƒíƒœë¥¼ ìœ ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ì£¼ë¬¸ ìƒì„± í›„ ê²°ì œë¥¼ ì‹¤íŒ¨í•œë‹¤ë©´, ì£¼ë¬¸ì„ ì·¨ì†Œí•˜ì—¬ ë°ì´í„° ë¶ˆì¼ì¹˜ë¥¼ ë°©ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p>ì´ì²˜ëŸ¼, ë³´ìƒ íŠ¸ëœì­ì…˜ì„ í†µí•´ ë°ì´í„° ì¼ê´€ì„±ì´ ìœ ì§€ë©ë‹ˆë‹¤.</p>

<h2 id="6-2-ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤-ë…ë¦½ì„±-ìœ ì§€">6-2. ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ë…ë¦½ì„± ìœ ì§€</h2>

<p>ê° ì„œë¹„ìŠ¤ëŠ” ë¡œì»¬ íŠ¸ëœì­ì…˜ë§Œ ê´€ë¦¬í•˜ë©´ ë˜ë¯€ë¡œ, ê°•í•œ ê²°í•©(Tightly Coupled)ì„ í”¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<h2 id="6-3-í™•ì¥ì„±-í–¥ìƒ">6-3. í™•ì¥ì„± í–¥ìƒ</h2>

<p>ì„œë¹„ìŠ¤ ê°„ì˜ ì§ì ‘ì ì¸ ì˜ì¡´ì„±ì´ ì¤„ì–´ë“¤ì–´, ìƒˆë¡œìš´ ì„œë¹„ìŠ¤ ì¶”ê°€ ë° í™•ì¥ì´ ì‰¬ì›Œì§€ê²Œ ë©ë‹ˆë‹¤.</p>

<h1 id="7-saga-íŒ¨í„´ì„-ë„ì…í•˜ì§€-ì•Šìœ¼ë©´-ë°œìƒí•˜ëŠ”-ë¬¸ì œì ">7. Saga íŒ¨í„´ì„ ë„ì…í•˜ì§€ ì•Šìœ¼ë©´ ë°œìƒí•˜ëŠ” ë¬¸ì œì </h1>

<h2 id="7-1-ë°ì´í„°-ë¶ˆì¼ì¹˜">7-1. ë°ì´í„° ë¶ˆì¼ì¹˜</h2>

<p>ì‹¤íŒ¨ ì‹œ ì ì ˆí•œ ë³´ìƒ íŠ¸ëœì­ì…˜ì´ ì—†ë‹¤ë©´, <strong>ê²°ì œ ì‹¤íŒ¨</strong>ë‚˜ <strong>ì¬ê³  ë¶€ì¡±</strong> ë“±ì˜ ì‹œë‚˜ë¦¬ì˜¤ì—ì„œ, ì£¼ë¬¸ ìƒíƒœëŠ” <strong>â€œì™„ë£Œâ€</strong>ì´ì§€ë§Œ ì‹¤ì œë¡œëŠ” ê²°ì œê°€ ë˜ì§€ ì•Šì€ ì£¼ë¬¸ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<h2 id="7-2-ì‚¬ìš©ì-ê²½í—˜-ì €í•˜">7-2. ì‚¬ìš©ì ê²½í—˜ ì €í•˜</h2>

<p>ì£¼ë¬¸ì€ <strong>ì™„ë£Œ ìƒíƒœ</strong>ì´ê³  <strong>ê²°ì œëŠ” ì‹¤íŒ¨</strong>í–ˆì„ ë•Œ, ì œëŒ€ë¡œëœ ë³´ìƒ íŠ¸ëœì­ì…˜ ì²˜ë¦¬ë¥¼ í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ <strong>â€œì£¼ë¬¸ ì •ìƒ ì²˜ë¦¬â€</strong>ë¼ëŠ” ì˜ëª»ëœ ì •ë³´ë¥¼ ì‚¬ìš©ìì—ê²Œ ì „ë‹¬í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.</p>

<h1 id="-ê²°ë¡ ">ğŸ¯ ê²°ë¡ </h1>

<ul>
  <li>Saga íŒ¨í„´ì€ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ í™˜ê²½ì—ì„œ <strong>ë°ì´í„° ì •í•©ì„±ì„ ìœ ì§€í•˜ê¸° ìœ„í•œ í•„ìˆ˜ ì„¤ê³„ íŒ¨í„´</strong>ìœ¼ë¡œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ë³´ìƒ íŠ¸ëœì­ì…˜ì„ í†µí•´ ì‹¤íŒ¨ ì‹œì—ë„ ì „ì²´ ì‹œìŠ¤í…œì˜ ì¼ê´€ì„±ì„ ìœ ì§€í•  ìˆ˜ ìˆìœ¼ë©°, ì„œë¹„ìŠ¤ ê°„ ê²°í•©ë„ë¥¼ ë‚®ì¶° <strong>í™•ì¥ì„±</strong>ê³¼ <strong>ìœ ì—°ì„±</strong>ì„ í™•ë³´í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì¤ë‹ˆë‹¤.</li>
</ul>

<p>Kafkaì™€ ê°™ì€ ì´ë²¤íŠ¸ ë“œë¦¬ë¸ ê¸°ë°˜ì˜ MSA í™˜ê²½ì—ì„œ Saga íŒ¨í„´ì„ ë„ì…í•˜ì§€ ì•Šìœ¼ë©´, ë°ì´í„° ë¶ˆì¼ì¹˜ ë° ë¹„ì¦ˆë‹ˆìŠ¤ ì˜¤ë¥˜ê°€ ë°œìƒí•  ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤. ì•ˆì •ì ì¸ ì‹œìŠ¤í…œì„ ë§Œë“¤ê¸° ìœ„í•´ì„œëŠ” ë°˜ë“œì‹œ <strong>Saga íŒ¨í„´ê³¼ ê°™ì€ ë¶„ì‚° íŠ¸ëœì­ì…˜ ê´€ë¦¬ ê¸°ë²•</strong>ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>

<h1 id="-ì¶”ê°€ë¡œ-ê³µë¶€í•˜ë©´-ì¢‹ì„-ë‚´ìš©">ğŸ’¡ ì¶”ê°€ë¡œ ê³µë¶€í•˜ë©´ ì¢‹ì„ ë‚´ìš©</h1>

<ul>
  <li><a href="https://en.wikipedia.org/wiki/CAP_theorem">CAP ì´ë¡ </a></li>
  <li><a href="https://ko.wikipedia.org/wiki/2%EB%8B%A8%EA%B3%84_%EC%BB%A4%EB%B0%8B_%ED%94%84%EB%A1%9C%ED%86%A0%EC%BD%9C">2-Phase Commit</a></li>
  <li>Outbox íŒ¨í„´</li>
</ul>

<hr />]]></content><author><name>Bang Seung IL</name></author><category term="Spring Cloud" /><category term="MSA" /><category term="Saga pattern" /><summary type="html"><![CDATA[Saga íŒ¨í„´ì´ ë¬´ì—‡ì´ê³ , MSA í™˜ê²¨ì—ì„œ ì™œ í•„ìš”í•œì§€ ì•Œì•„ë´…ì‹œë‹¤!]]></summary></entry><entry><title type="html">Spring Cloud + Kafkaë¡œ êµ¬í˜„í•˜ëŠ” ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì´ë²¤íŠ¸ ì•„í‚¤í…ì²˜</title><link href="http://localhost:4000/spring%20cloud/msa/kafka/2025/02/22/Spring-Cloud-Kafka-EventArchitecture/" rel="alternate" type="text/html" title="Spring Cloud + Kafkaë¡œ êµ¬í˜„í•˜ëŠ” ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì´ë²¤íŠ¸ ì•„í‚¤í…ì²˜" /><published>2025-02-22T00:00:00+09:00</published><updated>2025-02-22T00:00:00+09:00</updated><id>http://localhost:4000/spring%20cloud/msa/kafka/2025/02/22/Spring-Cloud-Kafka-EventArchitecture</id><content type="html" xml:base="http://localhost:4000/spring%20cloud/msa/kafka/2025/02/22/Spring-Cloud-Kafka-EventArchitecture/"><![CDATA[<blockquote>
  <p>Kafkaë¥¼ ì´ìš©í•œ ì´ë²¤íŠ¸ ë“œë¦¬ë¸ ì•„í‚¤í…ì²˜ì˜ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ í†µì‹ ì— ëŒ€í•´ ì•Œì•„ë´…ì‹œë‹¤!</p>
</blockquote>

<!-- more -->

<h1 id="-1-ë“¤ì–´ê°€ê¸°">ğŸ“Œ 1. ë“¤ì–´ê°€ê¸°</h1>

<h2 id="1-1-ì™œ-ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤-ê°„-í†µì‹ -ë°©ì‹ì´-ì¤‘ìš”í• ê¹Œìš”">1-1. ì™œ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ê°„ í†µì‹  ë°©ì‹ì´ ì¤‘ìš”í• ê¹Œìš”?</h2>

<p>ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì„ <strong>ì‘ì€ ë…ë¦½ì ì¸ ì„œë¹„ìŠ¤</strong>ë¡œ ë‚˜ëˆ„ì–´ ê°œë°œ, ë°°í¬ ë° í™•ì¥ì„±ì„ ê·¹ëŒ€í™”í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤.</p>

<p>í•˜ì§€ë§Œ ì„œë¹„ìŠ¤ ê°„ì— <strong>ë°ì´í„°ì™€ ëª…ë ¹ì„ ì–´ë–»ê²Œ ì£¼ê³ ë°›ì„ì§€</strong>ê°€ ì‹œìŠ¤í…œì˜ í™•ì¥ì„±, ì„±ëŠ¥ ê·¸ë¦¬ê³  ì‹ ë¢°ì„±ì— ì˜í–¥ì„ ë¯¸ì¹©ë‹ˆë‹¤. ê·¸ë˜ì„œ <strong>ì„œë¹„ìŠ¤ ê°„ í†µì‹  ë°©ì‹</strong>ì— ëŒ€í•œ ê³ ë¯¼ì´ ì¤‘ìš”í•œ í¬ì¸íŠ¸ê°€ ë©ë‹ˆë‹¤.</p>

<p>ê°€ì¥ í”íˆ ì‚¬ìš©ë˜ëŠ” ë‘ ê°€ì§€ í†µì‹  ë°©ì‹ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>

<ol>
  <li>REST API ê¸°ë°˜ í†µì‹  (ë™ê¸° ë°©ì‹, Synchronous)</li>
  <li>Message Queueë¥¼ í™œìš©í•œ Event driven í†µì‹  (ë¹„ë™ê¸° ë°©ì‹, Asynchronous)</li>
</ol>

<p>ì´ì „ì— MSAì— ê´€í•œ í†µì‹  ë°©ë²•ë“¤ì˜ ì¥ë‹¨ì ì„ ë¹„êµí•˜ëŠ” <a href="https://seung-il-bang.github.io/spring%20cloud/msa/2025/02/10/Spring-Cloud-%EA%B8%B0%EB%B0%98-%EB%A7%88%EC%9D%B4%ED%81%AC%EB%A1%9C%EC%84%9C%EB%B9%84%EC%8A%A4-%EA%B5%AC%EC%B6%95-%EA%B3%BC%EC%A0%95/">í¬ìŠ¤íŠ¸</a>ë¥¼ ì‘ì„±í–ˆì—ˆìŠµë‹ˆë‹¤. ì´ë²ˆ í¬ìŠ¤íŠ¸ì™€ í•¨ê»˜ ì½ì–´ë³´ì‹œë©´ ì¢‹ì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.</p>

<h2 id="1-2-rest-api-ê¸°ë°˜-í†µì‹ ì˜-í•œê³„ì ">1-2. REST API ê¸°ë°˜ í†µì‹ ì˜ í•œê³„ì </h2>

<p>REST APIë¥¼ í™œìš©í•œ ë™ê¸° í†µì‹ ì€ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì´ˆê¸° êµ¬í˜„ ì‹œ ê°„ë‹¨í•˜ê²Œ ì ìš©í•  ìˆ˜ ìˆê³ , HTTPë¥¼ ì´ìš©í•œ ìš”ì²­/ì‘ë‹µ íŒ¨í„´ì€ ì¹œìˆ™í•˜ê¸°ì— ê°€ì¥ ë§ì´ ì„ íƒë˜ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.</p>

<p>í•˜ì§€ë§Œ, ì„œë¹„ìŠ¤ ê·œëª¨ê°€ ì»¤ì§ˆìˆ˜ë¡ REST API í†µì‹ ì˜ í•œê³„ì ì— ì§ë©´í•˜ê²Œ ë©ë‹ˆë‹¤.</p>

<h3 id="ê°•í•œ-ê²°í•©-tightly-coupled">ê°•í•œ ê²°í•© (Tightly Coupled)</h3>

<ul>
  <li><strong>ë¬¸ì œ</strong>: ì„œë¹„ìŠ¤ Aê°€ ì„œë¹„ìŠ¤ Bì˜ APIë¥¼ í˜¸ì¶œí•´ì•¼ í•œë‹¤ë©´, ì„œë¹„ìŠ¤ Bê°€ ë°˜ë“œì‹œ <strong>ì •ìƒ ë™ì‘</strong>í•˜ê³  ìˆì–´ì•¼ í•©ë‹ˆë‹¤.</li>
  <li><strong>ì˜ˆì‹œ</strong>: <code class="language-plaintext highlighter-rouge">Order Service</code>ê°€ <code class="language-plaintext highlighter-rouge">Payment Service</code>ì˜ APIë¥¼ í˜¸ì¶œí–ˆëŠ”ë°, ê²°ì œ ì„œë¹„ìŠ¤ê°€ ë‹¤ìš´ë˜ë©´ ì£¼ë¬¸ ìƒì„± ìì²´ê°€ ì‹¤íŒ¨í•˜ê²Œ ë©ë‹ˆë‹¤.</li>
</ul>

<h3 id="í™•ì¥ì„±-ë°-ì„±ëŠ¥-ì´ìŠˆ">í™•ì¥ì„± ë° ì„±ëŠ¥ ì´ìŠˆ</h3>

<ul>
  <li><strong>ë¬¸ì œ</strong>: ë™ê¸°ì‹ í˜¸ì¶œë¡œ ì¸í•´ ìš”ì²­ì´ <strong>ë³‘ëª© ì§€ì </strong>ì´ ë©ë‹ˆë‹¤.</li>
  <li><strong>ì˜ˆì‹œ</strong>: <code class="language-plaintext highlighter-rouge">Order Service</code>ê°€ ì£¼ë¬¸ ìƒì„± -&gt; ê²°ì œ ìš”ì²­ -&gt; ë°°ì†¡ ìš”ì²­ê¹Œì§€ ìˆœì°¨ì ìœ¼ë¡œ(ë™ê¸°ì‹)ìœ¼ë¡œ í˜¸ì¶œí•œë‹¤ë©´, ì „ì²´ ì‘ë‹µ ì‹œê°„ì´ ê¸¸ì–´ì§€ê²Œ ë©ë‹ˆë‹¤. ê²°êµ­ ì „ì²´ íŠ¸ëœì­ì…˜ì´ ëŠë ¤ì§€ê³ , ë™ì‹œì— ë§ì€ ìš”ì²­ì„ ì²˜ë¦¬í•˜ê¸° ì–´ë ¤ì›Œì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h3 id="ì¥ì• -ì „íŒŒ">ì¥ì•  ì „íŒŒ</h3>

<ul>
  <li><strong>ë¬¸ì œ</strong>: í•˜ë‚˜ì˜ ì„œë¹„ìŠ¤ ì¥ì• ê°€ ì—°ì‡„ì ìœ¼ë¡œ ë‹¤ë¥¸ ì„œë¹„ìŠ¤ì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ë‹¨ì¼ ì¥ì• ê°€ ì „ì²´ ì‹œìŠ¤í…œì˜ ë¬¸ì œë¡œ í™•ì‚°ë  ìˆ˜ ë„ ìˆìŠµë‹ˆë‹¤.</li>
  <li><strong>ì˜ˆì‹œ</strong>: ê²°ì œ ì‹œìŠ¤í…œì´ ëŠë ¤ì§€ê±°ë‚˜ ì¥ì• ê°€ ë°œìƒí•˜ë©´, ì£¼ë¬¸ ì²˜ë¦¬ ì‹œìŠ¤í…œë„ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>
</ul>

<h3 id="ë†’ì€-ì¢…ì†ì„±">ë†’ì€ ì¢…ì†ì„±</h3>

<ul>
  <li><strong>ë¬¸ì œ</strong>: API êµ¬ì¡° ë³€ê²½ ì‹œ, ì´ë¥¼ í˜¸ì¶œí•˜ëŠ” ëª¨ë“  ì„œë¹„ìŠ¤ì— ì˜í–¥ì„ ë¯¸ì¹©ë‹ˆë‹¤. ì´ë¡œ ì¸í•´ ê° ì„œë¹„ìŠ¤ì˜ ë…ë¦½ì„±ì´ ë‚®ì•„ì§€ê³ , ë°°í¬ì‹œ ì„œë¹„ìŠ¤ ê°„ì˜ ì¡°ìœ¨ì´ í•„ìš”í•©ë‹ˆë‹¤.</li>
</ul>

<h2 id="1-3--ìš”ì•½">1-3. âœ… ìš”ì•½</h2>

<blockquote>
  <p>REST API ë°©ì‹ì€ ë‹¨ìˆœí•˜ê³  ì§ê´€ì ì´ì§€ë§Œ, í™•ì¥ì„±, ì‹ ë¢°ì„±, ìœ ì—°ì„± ì¸¡ë©´ì—ì„œ í•œê³„ê°€ ë°œìƒí•©ë‹ˆë‹¤.</p>
</blockquote>

<h1 id="2-kafka-ê¸°ë°˜-ì´ë²¤íŠ¸-ë“œë¦¬ë¸event-driven-ì•„í‚¤í…ì²˜">2. Kafka ê¸°ë°˜ ì´ë²¤íŠ¸ ë“œë¦¬ë¸(Event-driven) ì•„í‚¤í…ì²˜</h1>

<p>ì•ì„œ ì‚´í´ë³¸ ë™ê¸°ì‹ í†µì‹ ì˜ í•œê³„ì ì„ ê·¹ë³µí•˜ê¸° ìœ„í•´ ëŒ€ê·œëª¨ì˜ MSA í™˜ê²½ì—ì„œëŠ” <code class="language-plaintext highlighter-rouge">Kafka</code> ê¸°ë°˜ì˜ <strong>ë¹„ë™ê¸° ì´ë²¤íŠ¸ í†µì‹ </strong>ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì í•©í•©ë‹ˆë‹¤.</p>

<p>KafkaëŠ” ë©”ì‹œì§€ ë¸Œë¡œì»¤ ì—­í• ì„ ìˆ˜í–‰í•˜ë©´ì„œ, ì„œë¹„ìŠ¤ ê°„ì— ë¹„ë™ê¸° ë©”ì‹œì§€ë¥¼ ì „ë‹¬í•´ì£¼ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤. ì„œë¹„ìŠ¤ë“¤ì€ <strong>í† í”½(Topic)</strong>ì— ë©”ì‹œì§€ë¥¼ <strong>ë°œí–‰(Publish)</strong>í•˜ê±°ë‚˜ <strong>êµ¬ë…(Subscribe)</strong>í•¨ìœ¼ë¡œì¨ ì„œë¡œ í†µì‹ í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.</p>

<h2 id="2-1-ì´ë²¤íŠ¸-ë“œë¦¬ë¸event-driven-ì•„í‚¤í…ì²˜ì˜-ì¥ì ">2-1. ì´ë²¤íŠ¸ ë“œë¦¬ë¸(Event-driven) ì•„í‚¤í…ì²˜ì˜ ì¥ì </h2>

<h3 id="ëŠìŠ¨í•œ-ê²°í•©-loosely-coupled">ëŠìŠ¨í•œ ê²°í•© (Loosely Coupled)</h3>

<ul>
  <li><strong>ì¥ì </strong>: ì„œë¹„ìŠ¤ ê°„ ì§ì ‘ì ì¸ í˜¸ì¶œì´ ì—†ìœ¼ë¯€ë¡œ, ì„œë¡œì˜ ì¡´ì¬ë¥¼ ëª°ë¼ë„ ë©ë‹ˆë‹¤. ë”°ë¼ì„œ íŠ¹ì • ì„œë¹„ìŠ¤ê°€ ë‹¤ìš´ë˜ë”ë¼ë„ ì „ì²´ ì‹œìŠ¤í…œì—ëŠ” ì˜í–¥ì´ ì ìŠµë‹ˆë‹¤.</li>
  <li><strong>ì˜ˆì‹œ</strong>: <code class="language-plaintext highlighter-rouge">Order Service</code>ëŠ” <code class="language-plaintext highlighter-rouge">ORDER_CREATED</code> ì£¼ë¬¸ ìƒì„± ì´ë²¤íŠ¸ë§Œ ë°œí–‰í•˜ê³ , ì´ë¥¼ <code class="language-plaintext highlighter-rouge">Payment Service</code>ì—ì„œ êµ¬ë…í•´ì„œ ì²˜ë¦¬í•©ë‹ˆë‹¤. ì¦‰, ê° ì„œë¹„ìŠ¤ë“¤ì€ ë…ë¦½ì ìœ¼ë¡œ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.</li>
</ul>

<h3 id="ë¹„ë™ê¸°-ì²˜ë¦¬ë¡œ-ì¸í•œ-ì„±ëŠ¥-í–¥ìƒ">ë¹„ë™ê¸° ì²˜ë¦¬ë¡œ ì¸í•œ ì„±ëŠ¥ í–¥ìƒ</h3>

<ul>
  <li><strong>ì¥ì </strong>: ìš”ì²­ì„ íì— ë„£ê³  ë°”ë¡œ ì‘ë‹µì„ ì¤„ ìˆ˜ ìˆì–´, ë¹ ë¥¸ ì²˜ë¦¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤. ë¹ ë¥¸ ì‘ë‹µì€ ì‚¬ìš©ìì˜ ê²½í—˜ì„ ê°œì„ í•´ì¤ë‹ˆë‹¤.</li>
  <li><strong>ì˜ˆì‹œ</strong>: ì‚¬ìš©ìê°€ ì£¼ë¬¸ì„ ìƒì„±í•˜ë©´, ì£¼ë¬¸ IDë¥¼ ë°”ë¡œ ì‘ë‹µë°›ê³ , ê²°ì œ ë° ë°°ì†¡ì²˜ë¦¬ëŠ” ë°±ì—”ë“œì—ì„œ ë¹„ë™ê¸°ë¡œ ì§„í–‰ë©ë‹ˆë‹¤.</li>
</ul>

<h3 id="ì¥ì• -ê²©ë¦¬-ë°-ë‚´ê²°í•¨ì„±-fault-tolerance">ì¥ì•  ê²©ë¦¬ ë° ë‚´ê²°í•¨ì„± (Fault Tolerance)</h3>

<ul>
  <li><strong>ì¥ì </strong>: Kafkaì— ë°œí–‰ëœ ë©”ì‹œì§€ëŠ” ë””ìŠ¤í¬ì— ì €ì¥ë˜ë¯€ë¡œ, êµ¬ë…ìê°€ ì ì‹œ ë‹¤ìš´ë˜ì–´ë„ ë©”ì‹œì§€ ì¬ì²˜ë¦¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ì„œë¹„ìŠ¤ ì¥ì•  ë°œìƒ ì‹œì—ë„ ë°ì´í„° ìœ ì‹¤ ì—†ì´ ë³µêµ¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
  <li><strong>ì˜ˆì‹œ</strong>: <code class="language-plaintext highlighter-rouge">Payment Service</code>ê°€ ë‹¤ìš´ë˜ì–´ë„, Kafkaì— ìŒ“ì¸ <code class="language-plaintext highlighter-rouge">ORDER_CREATED</code> ë©”ì‹œì§€ë¥¼ ì„œë¹„ìŠ¤ ë³µêµ¬ í›„ ë‹¤ì‹œ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h3 id="í™•ì¥ì„±ê³¼-ìœ ì—°ì„±">í™•ì¥ì„±ê³¼ ìœ ì—°ì„±</h3>

<ul>
  <li><strong>ì¥ì </strong>: ì„œë¹„ìŠ¤ ê°„ì— ì§ì ‘ì ì¸ í†µì‹ ì„ í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— í™•ì¥ì„±ì´ ë†’ì•„ì§€ê³ , ë…ë¦½ì ìœ¼ë¡œ ì„œë¹„ìŠ¤ ë°°í¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì´ë¡œì¨ ìƒˆë¡œìš´ ì„œë¹„ìŠ¤ë¥¼ ì‰½ê²Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li><strong>ì˜ˆì‹œ</strong>: <code class="language-plaintext highlighter-rouge">Order Service</code>ì—ì„œ ë°œí–‰í•˜ëŠ” ì´ë²¤íŠ¸ë¥¼ êµ¬ë…í•˜ëŠ” ìƒˆë¡œìš´ ì„œë¹„ìŠ¤ë¥¼ ì¶”ê°€í•´ë„ ê¸°ì¡´ ì‹œìŠ¤í…œì— ì˜í–¥ì´ ì—†ìŠµë‹ˆë‹¤.</li>
</ul>

<h2 id="2-2--ìš”ì•½">2-2. âœ… ìš”ì•½</h2>

<blockquote>
  <p>Kafka ê¸°ë°˜ ì´ë²¤íŠ¸ ë“œë¦¬ë¸ ì•„í‚¤í…ì²˜ëŠ” í™•ì¥ì„±, ìœ ì—°ì„±, ë‚´ê²°í•¨ì„± ë“± ì—¬ëŸ¬ ì¸¡ë©´ì—ì„œ ìœ ë¦¬í•©ë‹ˆë‹¤.</p>
</blockquote>

<h1 id="3-ê°œì„ -ê³¼ì •-rest-api--kafka-ê¸°ë°˜-ì•„í‚¤í…ì²˜ë¡œ-ì „í™˜">3. ê°œì„  ê³¼ì •: REST API â†’ Kafka ê¸°ë°˜ ì•„í‚¤í…ì²˜ë¡œ ì „í™˜</h1>

<h2 id="3-1-ê¸°ì¡´-êµ¬ì¡°-rest-api-ê¸°ë°˜">3-1. ê¸°ì¡´ êµ¬ì¡°: REST API ê¸°ë°˜</h2>

<p><strong>Order -&gt; Payment -&gt; Delivery</strong> íë¦„ì„ REST APIë¡œ ì²˜ë¦¬í•˜ë©´ ë‹¤ìŒ ê³¼ì •ë“¤ì´ ë™ê¸°ì‹ìœ¼ë¡œ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤.</p>

<ol>
  <li>ì‚¬ìš©ìê°€ ì£¼ë¬¸ ìƒì„± ìš”ì²­ -&gt; <code class="language-plaintext highlighter-rouge">Order Service</code></li>
  <li><code class="language-plaintext highlighter-rouge">Order Service</code>ê°€ ê²°ì œ ìš”ì²­ -&gt; <code class="language-plaintext highlighter-rouge">Payment Service</code></li>
  <li>ê²°ì œ ì„±ê³µ ì‹œ ë°°ì†¡ ìš”ì²­ -&gt; <code class="language-plaintext highlighter-rouge">Delivery Service</code></li>
</ol>

<p>REST API ê¸°ë°˜ ë°©ì‹ì˜ ë¬¸ì œì ì€ ì„œë¹„ìŠ¤ ê°„ ê°•í•œ ê²°í•©ìœ¼ë¡œ ì¸í•´, ì¼ë¶€ ê³¼ì • ì¤‘ ì¥ì• ê°€ ë°œìƒ ì‹œ ì „í˜ í”„ë¡œì„¸ìŠ¤ê°€ ì‹¤íŒ¨í•˜ê²Œ ë©ë‹ˆë‹¤. <strong>ì¦‰ ì „ì²´ íŠ¸ëœì­ì…˜ì´ ëª¨ë“  ì„œë¹„ìŠ¤ë“¤ì˜ ì„±ê³µ ì—¬ë¶€ì— ì¢…ì†í•˜ê²Œ ë©ë‹ˆë‹¤.</strong></p>

<h2 id="3-2-ê°œì„ ëœ-êµ¬ì¡°-kafka-ì´ë²¤íŠ¸-ë“œë¦¬ë¸-ê¸°ë°˜">3-2. ê°œì„ ëœ êµ¬ì¡°: Kafka ì´ë²¤íŠ¸ ë“œë¦¬ë¸ ê¸°ë°˜</h2>

<p>Kafkaë¥¼ ë„ì…í•˜ì—¬ ê° ë‹¨ê³„ì—ì„œ <strong>ì´ë²¤íŠ¸ë¥¼ ë°œí–‰</strong>í•˜ê³ , <strong>í•„ìš”í•œ ì„œë¹„ìŠ¤ê°€ ì´ë¥¼ êµ¬ë…</strong>í•˜ëŠ” êµ¬ì¡°ë¡œ ì „í™˜í•©ë‹ˆë‹¤.</p>

<ol>
  <li>ì‚¬ìš©ìê°€ ì£¼ë¬¸ ìƒì„± ìš”ì²­ì„ í•˜ë©´ <code class="language-plaintext highlighter-rouge">Order Service</code>ëŠ” <code class="language-plaintext highlighter-rouge">ORDER_CREATED</code> ì´ë²¤íŠ¸ë¥¼ Kafkaì— ë°œí–‰í•©ë‹ˆë‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">Payment Service</code>ê°€ ì£¼ë¬¸ ìƒì„± ë©”ì‹œì§€ë¥¼ êµ¬ë…í•˜ì—¬ ê²°ì œ ì²˜ë¦¬ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.</li>
  <li>ê²°ì œ ì„±ê³µ ì‹œ <code class="language-plaintext highlighter-rouge">PAYMENT_COMPLETED</code> ê²°ì œ ì„±ê³µ ì´ë²¤íŠ¸ë¥¼ ë°œí–‰í•©ë‹ˆë‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">Delivery Service</code>ê°€ ê²°ì œ ì„±ê³µ ì´ë²¤íŠ¸ë¥¼ êµ¬ë…í•˜ì—¬ ë°°ì†¡ ìš”ì²­ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.</li>
</ol>

<p>Kafkaë¥¼ ë„ì…í•¨ìœ¼ë¡œì¨ ë¹„ë™ê¸° ì²˜ë¦¬ë¡œ ì¸í•œ ë¹ ë¥¸ ì‚¬ìš©ì ì‘ë‹µì´ ê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤. ì„œë¹„ìŠ¤ ê°„ ëŠìŠ¨í•œ ê²°í•©ê³¼ Kafkaì˜ ë‚´ê²°í•¨ì„± ë•ë¶„ì— ì¥ì•  ì „íŒŒ ì˜í–¥ë„ ìµœì†Œí™” ë©ë‹ˆë‹¤. ê·¸ë¦¬ê³  ê°ê°ì˜ ì„œë¹„ìŠ¤ë“¤ì´ ë…ë¦½ì ìœ¼ë¡œ ë°°í¬ê°€ ê°€ëŠ¥í•˜ê³ , ì‹ ê·œ ì„œë¹„ìŠ¤ ì¶”ê°€ê°€ ìš©ì´í•´ì§‘ë‹ˆë‹¤.</p>

<h1 id="4--kafka-ê¸°ë°˜-ì´ë²¤íŠ¸-ì•„í‚¤í…ì²˜-ì„¤ê³„-ì‹œ-ê³ ë ¤ì‚¬í•­">4. ğŸš¨ Kafka ê¸°ë°˜ ì´ë²¤íŠ¸ ì•„í‚¤í…ì²˜ ì„¤ê³„ ì‹œ ê³ ë ¤ì‚¬í•­</h1>

<h2 id="ë©”ì‹œì§€-ì¤‘ë³µ-ì²˜ë¦¬">ë©”ì‹œì§€ ì¤‘ë³µ ì²˜ë¦¬</h2>

<ul>
  <li>ì´ë²¤íŠ¸ê°€ ì¤‘ë³µìœ¼ë¡œ ì „ë‹¬ë  ìˆ˜ ìˆê¸° ë•Œë¬¸ì—, ìˆ˜ì‹ ì ì¸¡ì— ì¤‘ë³µ ë°©ì§€ ë¡œì§ì„ êµ¬í˜„í•´ì•¼ í•©ë‹ˆë‹¤.</li>
</ul>

<h2 id="ë°ì´í„°-ì •í•©ì„±">ë°ì´í„° ì •í•©ì„±</h2>

<ul>
  <li>ë¹„ë™ê¸° êµ¬ì¡°ë¡œ ì¸í•´ ë°ì´í„° ì •í•©ì„±ì´ ê¹¨ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>í•´ê²°ì±…ìœ¼ë¡œ <strong>Sage íŒ¨í„´</strong> ë˜ëŠ” <strong>Outbox íŒ¨í„´</strong>ì„ ë„ì…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h2 id="ì—ëŸ¬-í•¸ë“¤ë§-ë°-ë³´ìƒ-íŠ¸ëœì­ì…˜">ì—ëŸ¬ í•¸ë“¤ë§ ë° ë³´ìƒ íŠ¸ëœì­ì…˜</h2>

<ul>
  <li>íŠ¹ì • ì´ë²¤íŠ¸ ì²˜ë¦¬ ì‹¤íŒ¨ì— ëŒ€í•´ ë¹„ì¦ˆë‹ˆìŠ¤ ì‹¤íŒ¨ ì¼€ì´ìŠ¤ë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ <strong>ë³´ìƒ íŠ¸ëœì­ì…˜</strong> ì„¤ê³„ê°€ í•„ìš”í•©ë‹ˆë‹¤.</li>
</ul>

<h2 id="kafka-ëª¨ë‹ˆí„°ë§-ë°-ìš´ì˜">Kafka ëª¨ë‹ˆí„°ë§ ë° ìš´ì˜</h2>

<ul>
  <li>Kafkaì˜ í† í”½, ë©”ì‹œì§€ ì ì¬ëŸ‰, Lag ë“±ì„ ëª¨ë‹ˆí„°ë§í•˜ì—¬ ì ì ˆí•œ ëŒ€ì‘ì„ í•  ìˆ˜ ìˆë„ë¡ í•´ì•¼ í•©ë‹ˆë‹¤.</li>
  <li>Kafkaê°€ SPOF(Single Point Of Failure)ì´ ë˜ì§€ ì•Šë„ë¡ ë©€í‹° í´ëŸ¬ìŠ¤í„°ë¡œ ìš´ì˜í•  í•„ìš”ê°€ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h1 id="5-ì¶”ê°€ë¡œ-ê³µë¶€í•˜ë©´-ì¢‹ì„-ë‚´ìš©">5. ì¶”ê°€ë¡œ ê³µë¶€í•˜ë©´ ì¢‹ì„ ë‚´ìš©</h1>

<ul>
  <li>Kafkaì˜ <strong>At-Least-Once/Exactly-Once</strong> ë³´ì¥ ë°©ì‹</li>
  <li>Kafka ë©€í‹° í´ëŸ¬ìŠ¤í„° êµ¬ì„±</li>
  <li>Saga íŒ¨í„´ê³¼ ë³´ìƒ íŠ¸ëœì­ì…˜</li>
</ul>

<h1 id="6--ì •ë¦¬">6. ğŸ’¡ ì •ë¦¬</h1>

<ul>
  <li>REST API ê¸°ë°˜ ë™ê¸°ì‹ í†µì‹ ì€ ì´ˆê¸°ì—ëŠ” ë¹ ë¥´ê²Œ ê°œë°œ ê°€ëŠ¥í•˜ì§€ë§Œ, í™•ì¥ì„±ê³¼ ìœ ì—°ì„± ì¸¡ë©´ì—ì„œ í•œê³„ê°€ ì¡´ì¬í•©ë‹ˆë‹¤.</li>
  <li>Kafkaë¥¼ í™œìš©í•œ ì´ë²¤íŠ¸ ë“œë¦¬ë¸ ì•„í‚¤í…ì²˜ëŠ” ì„œë¹„ìŠ¤ ê°„ ê²°í•©ë„ë¥¼ ë‚®ì¶”ê³ , ì¥ì•  ê²©ë¦¬ ë° í™•ì¥ì„± ì¸¡ë©´ì—ì„œ ë›°ì–´ë‚œ ì´ì ì„ ì œê³µí•©ë‹ˆë‹¤.</li>
  <li>í•˜ì§€ë§Œ, ì´ë²¤íŠ¸ ê¸°ë°˜ ì‹œìŠ¤í…œì„ ì„¤ê³„í•  ë•ŒëŠ” ì¤‘ë³µ ì²˜ë¦¬, ë°ì´í„° ì •í•©ì„±, ì—ëŸ¬ í•¸ë“¤ë§ê³¼ ê°™ì€ ì¶”ê°€ì ì¸ ê³ ë ¤ ì‚¬í•­ì„ ë°˜ë“œì‹œ ì‹ ê²½ì¨ì•¼ í•©ë‹ˆë‹¤.</li>
</ul>

<blockquote>
  <p>ê¶ê·¹ì ìœ¼ë¡œ ì„œë¹„ìŠ¤ ê·œëª¨ê°€ ì»¤ì§ˆìˆ˜ë¡ Kafka ê¸°ë°˜ì˜ ì´ë²¤íŠ¸ ë“œë¦¬ë¸ ì•„í‚¤í…ì²˜ëŠ” ì„±ëŠ¥ê³¼ ìœ ì—°ì„± ì¸¡ë©´ì—ì„œ REST API ë°©ì‹ë³´ë‹¤ ì¥ì ì´ ë§ë‹¤ê³  ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
</blockquote>

<hr />]]></content><author><name>Bang Seung IL</name></author><category term="Spring Cloud" /><category term="MSA" /><category term="Kafka" /><category term="REST API" /><category term="Event-driven" /><summary type="html"><![CDATA[Kafkaë¥¼ ì´ìš©í•œ ì´ë²¤íŠ¸ ë“œë¦¬ë¸ ì•„í‚¤í…ì²˜ì˜ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ í†µì‹ ì— ëŒ€í•´ ì•Œì•„ë´…ì‹œë‹¤!]]></summary></entry><entry><title type="html">Spring Cloud Gatewayì™€ JWT - ë¶„ì‚° ì‹œìŠ¤í…œì˜ ì¤‘ì•™ì§‘ì¤‘ì‹ ì¸ì¦</title><link href="http://localhost:4000/spring%20cloud/msa/2025/02/19/Spring-Cloud-Gateway-Security/" rel="alternate" type="text/html" title="Spring Cloud Gatewayì™€ JWT - ë¶„ì‚° ì‹œìŠ¤í…œì˜ ì¤‘ì•™ì§‘ì¤‘ì‹ ì¸ì¦" /><published>2025-02-19T00:00:00+09:00</published><updated>2025-02-19T00:00:00+09:00</updated><id>http://localhost:4000/spring%20cloud/msa/2025/02/19/Spring-Cloud-Gateway-Security</id><content type="html" xml:base="http://localhost:4000/spring%20cloud/msa/2025/02/19/Spring-Cloud-Gateway-Security/"><![CDATA[<blockquote>
  <p>Spring Cloud Gatewayì™€ JWTë¥¼ í™œìš©í•œ ì¤‘ì•™ ì§‘ì¤‘ì‹ ì¸ì¦ì— ëŒ€í•´ ì•Œì•„ë´…ì‹œë‹¤!</p>
</blockquote>

<!-- more -->

<h1 id="ë“¤ì–´ê°€ê¸°">ë“¤ì–´ê°€ê¸°</h1>

<p>ë¶„ì‚° ì‹œìŠ¤í…œì—ì„œ <code class="language-plaintext highlighter-rouge">JWT</code>ì™€ ê°™ì€ í† í° ê¸°ë°˜ ì¸ì¦ì„ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ì–´ë–»ê²Œ ë ê¹Œìš”?</p>

<p>ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” ë¶„ì‚° ì‹œìŠ¤í…œì—ì„œ Spring Cloud Gatewayì™€ JWT í† í° ê¸°ë°˜ ì¸ì¦ì„ ì‚¬ìš©ì˜ ì´ì ì— ëŒ€í•´ ì•Œì•„ë³´ëŠ” ì‹œê°„ì„ ê°–ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.</p>

<h2 id="ë¶„ì‚°-ì‹œìŠ¤í…œno-token--no-gateway">ë¶„ì‚° ì‹œìŠ¤í…œ(No Token &amp; No Gateway)</h2>

<p>ìš°ì„ , ë¶„ì‚° í™˜ê²½ì—ì„œ API Gatewayì™€ í† í° ê¸°ë°˜ ì¸ì¦ ê¸°ìˆ ì„ ê²°í•©í•œ ì¤‘ì•™ì§‘ì¤‘ì‹ ì¸ì¦ ì‹œìŠ¤í…œì„ ë„ì…í•˜ì§€ ì•ŠëŠ” ê²½ìš° ë°œìƒí•˜ëŠ” ë¬¸ì œì ë“¤ì— ëŒ€í•´ ë¨¼ì € ì‚´í´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.</p>

<ol>
  <li>
    <p>ì¤‘ì•™ì§‘ì¤‘ì‹ ì¸ì¦ ì‹œìŠ¤í…œì´ ì—†ë‹¤ë©´, ê° ì„œë¹„ìŠ¤ë§ˆë‹¤ ë³„ë„ì˜ ì¸ì¦/ì¸ê°€ ë¡œì§ì„ êµ¬í˜„í•´ì•¼ í•©ë‹ˆë‹¤. ì´ëŠ” ì½”ë“œì˜ ì¤‘ë³µê³¼ ìœ ì§€ë³´ìˆ˜ì˜ ì–´ë ¤ì›€ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>í† í° ëŒ€ì‹  ì‚¬ìš©í•˜ëŠ” ì„¸ì…˜ ê¸°ë°˜ ì¸ì¦ ë°©ì‹ì€ ì„œë²„ì— ìƒíƒœ ì •ë³´ë¥¼ ì €ì¥í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì—, ë¶„ì‚° í™˜ê²½ì—ì„œì˜ ì„œë²„ ê°„ ì„¸ì…˜ ë™ê¸°í™” ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ì‹œìŠ¤í…œ í™•ì¥ì„±ì— ì–´ë ¤ì›€ì„ ì¦ê°€ì‹œí‚µë‹ˆë‹¤.</p>
  </li>
</ol>

<h2 id="ë¶„ì‚°-ì‹œìŠ¤í…œgateway--token-ê¸°ë°˜">ë¶„ì‚° ì‹œìŠ¤í…œ(Gateway + Token ê¸°ë°˜)</h2>

<p>ê·¸ë ‡ë‹¤ë©´ Spring Cloud Gatewayì™€ JWT ê²°í•©ì˜ ì¤‘ì•™ ì§‘ì¤‘ì‹ ì¸ì¦ ì‹œìŠ¤í…œì€ ì–´ë– í•œ ì¥ì ì´ ìˆëŠ”ì§€ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.</p>

<ol>
  <li>
    <p>ëª¨ë“  ìš”ì²­ì— ëŒ€í•œ ê²€ì‚¬ë¥¼ API Gatewayì—ì„œ í•œ ë²ˆì— ìˆ˜í–‰í•  ìˆ˜ ìˆì–´, ê°œë³„ ì„œë¹„ìŠ¤ë§ˆë‹¤ ì¤‘ë³µëœ ì¸ì¦ ë¡œì§ì„ êµ¬í˜„í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ë³´ì•ˆ ì„¤ì •ì˜ ì¼ê´€ì„±ì´ í™•ë³´ë˜ê³ , ìœ ì§€ë³´ìˆ˜ê°€ ìš©ì´í•´ì§‘ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>JWTëŠ” í† í° ê¸°ë°˜ ì¸ì¦ ë°©ì‹ìœ¼ë¡œ, ë³„ë„ì˜ ì„¸ì…˜ ê´€ë¦¬ë¥¼ í•˜ì§€ ì•Šê³ ë„ ì‚¬ìš©ì ì¸ì¦ ì •ë³´ë¥¼ ì•ˆì „í•˜ê²Œ ì „ë‹¬ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ë¶„ì‚° ì‹œìŠ¤í…œ í™˜ê²½ì—ì„œ íš¨ìœ¨ì ì¸ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ê³¼ í™•ì¥ì„±ì„ ë³´ì¥í•©ë‹ˆë‹¤.</p>
  </li>
</ol>

<h1 id="ì˜ˆì œ-ì½”ë“œ">ì˜ˆì œ ì½”ë“œ</h1>

<p>ì´ë²ˆì—ëŠ” ì‚¬ì´ë“œ í”„ë¡œì íŠ¸ì—ì„œ ì§ì ‘ Spring Cloud Gatewayì™€ JWTë¥¼ ê²°í•©í•œ ì¸ì¦ í•„í„°ë¥¼ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.</p>

<p>ë‹¤ìŒ ì½”ë“œëŠ” <code class="language-plaintext highlighter-rouge">Spring Cloud Gateway</code> ì—ì„œ ì‚¬ìš©ì ìš”ì²­ì˜ ë‹´ê²¨ ìˆëŠ” <code class="language-plaintext highlighter-rouge">Authorization</code> í—¤ë”ì˜ <code class="language-plaintext highlighter-rouge">JWT</code> í† í°ì´ ìœ íš¨í•œì§€ ê²€ì¦í•˜ëŠ” ì½”ë“œì…ë‹ˆë‹¤.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthorizationHeaderFilter</span> <span class="kd">extends</span> <span class="nc">AbstractGatewayFilterFactory</span><span class="o">&lt;</span><span class="nc">AuthorizationHeaderFilter</span><span class="o">.</span><span class="na">Config</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Config</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Environment</span> <span class="n">env</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">AuthorizationHeaderFilter</span><span class="o">(</span><span class="nc">Environment</span> <span class="n">env</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="nc">Config</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">env</span> <span class="o">=</span> <span class="n">env</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">GatewayFilter</span> <span class="nf">apply</span><span class="o">(</span><span class="nc">Config</span> <span class="n">config</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">exchange</span><span class="o">,</span> <span class="n">chain</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>

            <span class="nc">ServerHttpRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="na">getRequest</span><span class="o">();</span>

            <span class="k">if</span> <span class="o">(!</span><span class="n">request</span><span class="o">.</span><span class="na">getHeaders</span><span class="o">().</span><span class="na">containsKey</span><span class="o">(</span><span class="nc">HttpHeaders</span><span class="o">.</span><span class="na">AUTHORIZATION</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">return</span> <span class="nf">onError</span><span class="o">(</span><span class="n">exchange</span><span class="o">,</span> <span class="s">"Authorization header is missing"</span><span class="o">,</span> <span class="nc">HttpStatus</span><span class="o">.</span><span class="na">UNAUTHORIZED</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="nc">String</span> <span class="n">authorizationHeader</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getHeaders</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="nc">HttpHeaders</span><span class="o">.</span><span class="na">AUTHORIZATION</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
            <span class="nc">String</span> <span class="n">jwt</span> <span class="o">=</span> <span class="n">authorizationHeader</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">"Bearer"</span><span class="o">,</span> <span class="s">""</span><span class="o">).</span><span class="na">trim</span><span class="o">();</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">isNotValidJwt</span><span class="o">(</span><span class="n">jwt</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">return</span> <span class="nf">onError</span><span class="o">(</span><span class="n">exchange</span><span class="o">,</span> <span class="s">"JWT is not valid"</span><span class="o">,</span> <span class="nc">HttpStatus</span><span class="o">.</span><span class="na">UNAUTHORIZED</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="k">return</span> <span class="n">chain</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">exchange</span><span class="o">);</span>
        <span class="o">};</span>
    <span class="o">}</span>

    <span class="c1">// WebFlux method to handle errors</span>
    <span class="kd">private</span> <span class="nc">Mono</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="nf">onError</span><span class="o">(</span><span class="nc">ServerWebExchange</span> <span class="n">exchange</span><span class="o">,</span> <span class="nc">String</span> <span class="n">err</span><span class="o">,</span> <span class="nc">HttpStatus</span> <span class="n">httpStatus</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">exchange</span><span class="o">.</span><span class="na">getResponse</span><span class="o">().</span><span class="na">setStatusCode</span><span class="o">(</span><span class="n">httpStatus</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">err</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">exchange</span><span class="o">.</span><span class="na">getResponse</span><span class="o">().</span><span class="na">setComplete</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isNotValidJwt</span><span class="o">(</span><span class="nc">String</span> <span class="n">jwt</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">boolean</span> <span class="n">returnValue</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

        <span class="nc">String</span> <span class="n">secretKey</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"token.secret"</span><span class="o">);</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">keyBytes</span> <span class="o">=</span> <span class="nc">Base64</span><span class="o">.</span><span class="na">getDecoder</span><span class="o">().</span><span class="na">decode</span><span class="o">(</span><span class="n">secretKey</span><span class="o">);</span>
        <span class="nc">SecretKey</span> <span class="n">key</span> <span class="o">=</span> <span class="nc">Keys</span><span class="o">.</span><span class="na">hmacShaKeyFor</span><span class="o">(</span><span class="n">keyBytes</span><span class="o">);</span>

        <span class="nc">String</span> <span class="n">subject</span> <span class="o">=</span> <span class="nc">Jwts</span><span class="o">.</span><span class="na">parser</span><span class="o">()</span>
                <span class="o">.</span><span class="na">setSigningKey</span><span class="o">(</span><span class="n">key</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">()</span>
                <span class="o">.</span><span class="na">parseClaimsJws</span><span class="o">(</span><span class="n">jwt</span><span class="o">)</span>
                <span class="o">.</span><span class="na">getBody</span><span class="o">()</span>
                <span class="o">.</span><span class="na">getSubject</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">subject</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">subject</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">returnValue</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">returnValue</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>ìœ„ ì½”ë“œì²˜ëŸ¼ Gatewayì—ì„œ ëª¨ë“  ìš”ì²­ì— ëŒ€í•œ ì¸ì¦ì„ í•œ ë²ˆì— ì²˜ë¦¬í•¨ìœ¼ë¡œì¨ ë³´ì•ˆ ê´€ë¦¬ê°€ ìš©ì´í•´ì§‘ë‹ˆë‹¤.</li>
  <li>ê·¸ë¦¬ê³  ê° ì„œë¹„ìŠ¤ì—ì„œ ë³„ë„ì˜ ì„¸ì…˜ ê´€ë¦¬ë¥¼ í•˜ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤.</li>
  <li>ì¸ì¦/ì¸ê°€ ë¡œì§ì„ ê²Œì´íŠ¸ì›¨ì´ì—ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ ê° ë°±ì—”ë“œ ì„œë¹„ìŠ¤ì˜ ì¤‘ë³µëœ ì½”ë“œë¥¼ ì¤„ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<p>ì´ì²˜ëŸ¼ Spring Cloud Gatewayì™€ JWT ì¸ì¦ì˜ ê²°í•©ì€ ë³µì¡í•œ ë¶„ì‚° í™˜ê²½ì—ì„œ ì•ˆì •ì ì´ê³  íš¨ìœ¨ì ì¸ ì¸ì¦/ì¸ê°€ë¥¼ ê°€ëŠ¥í•˜ê²Œ í•´ì¤ë‹ˆë‹¤.</p>

<h1 id="ì¶”ê°€ë¡œ-ê³ ë ¤í•´ë³¼-ë§Œí•œ-ë‚´ìš©">ì¶”ê°€ë¡œ ê³ ë ¤í•´ë³¼ ë§Œí•œ ë‚´ìš©</h1>

<ul>
  <li>JWT ì‚¬ìš© ì‹œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ë³´ì•ˆ ì´ìŠˆì™€ ì´ì— ëŒ€í•œ ëŒ€ì‘ ë°©ë²•</li>
</ul>

<h1 id="ìš”ì•½">ìš”ì•½</h1>
<p>Spring Cloud Gatewayì™€ JWT ê²°í•© ì‚¬ìš©ì˜ ì´ìœ  ë° ê¸°ëŒ€ íš¨ê³¼ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>

<ul>
  <li>ì¤‘ì•™ ì§‘ì¤‘ì‹ ë³´ì•ˆ ê´€ë¦¬ë¡œ ìœ ì§€ë³´ìˆ˜ê°€ ìš©ì´</li>
  <li>ë¶„ì‚° í™˜ê²½ì— ì í•©í•œ <code class="language-plaintext highlighter-rouge">stateless</code> ì¸ì¦ ë°©ì‹</li>
  <li>í™•ì¥ì„±ê³¼ ìœ ì—°ì„± í™•ë³´</li>
  <li>íš¨ìœ¨ì ì¸ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©</li>
</ul>

<hr />]]></content><author><name>Bang Seung IL</name></author><category term="Spring Cloud" /><category term="MSA" /><category term="JWT" /><category term="Spring Cloud Gateway" /><summary type="html"><![CDATA[Spring Cloud Gatewayì™€ JWTë¥¼ í™œìš©í•œ ì¤‘ì•™ ì§‘ì¤‘ì‹ ì¸ì¦ì— ëŒ€í•´ ì•Œì•„ë´…ì‹œë‹¤!]]></summary></entry></feed>